<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Catálogo · Dashboard de Métricas</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js + adapter fechas -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Export helpers -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- Montserrat font -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Montserrat', sans-serif; }
    .sidebar-link { transition: all .2s ease-in-out; }
    .sidebar-link:hover, .sidebar-link.active { background-color:#7a7a7a; color:#fff; transform: translateX(4px); }
    .kpi-card{background:#fff;border-radius:.75rem;padding:1.5rem;box-shadow:0 4px 6px -1px rgb(0 0 0 / 0.1),0 2px 4px -2px rgb(0 0 0 / 0.1);transition:transform .2s, box-shadow .2s;}
    .kpi-card:hover{transform:translateY(-4px);box-shadow:0 10px 15px -3px rgb(0 0 0 / .1),0 4px 6px -4px rgb(0 0 0 / .1);}
    .chart-container{height:400px;}
    #mobile-menu{transition: transform .3s ease-in-out;}
    /* Nine-box */
    .nb-cell{display:flex;align-items:center;justify-content:center;height:80px;border-radius:.5rem;border:1px solid rgb(226 232 240);}
    .nb-hdr{font-weight:600;color:#475569}
    .nb-badge{font-size:1.5rem;font-weight:700}
    .nb-green{background:#dcfce7}
    .nb-yellow{background:#fef9c3}
    .nb-orange{background:#ffedd5}
    .nb-red{background:#fee2e2}
    .nb-cell[data-bucket]{cursor:pointer}
    /* Export dropdown */
    .dropdown{position:relative;display:inline-block;}
    .dropdown-menu{position:absolute;right:0;top:100%;background:#fff;border:1px solid #e2e8f0;border-radius:.5rem;box-shadow:0 10px 20px rgba(0,0,0,.08);min-width:260px;z-index:50}
    .dropdown-menu a{display:block;padding:.6rem .8rem;font-size:.95rem;color:#334155}
    .dropdown-menu a:hover{background:#f1f5f9}

    /* IA (formato enriquecido) */
    .ai-output p { margin-bottom: 0.75rem; line-height: 1.5; }
    .ai-output ul { list-style: disc; margin-left: 1.5rem; margin-bottom: 1rem; }
    .ai-output table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    .ai-output th, .ai-output td { border: 1px solid #cbd5e1; padding: 0.5rem; text-align: left; }
    .ai-output th { background-color: #f1f5f9; }
    .ai-output code { background: #f3f4f6; padding: 0.2rem 0.4rem; border-radius: 4px; }

    /* --------- Filtros en acordeón con checkboxes --------- */
    .acc { @apply bg-white border border-slate-200 rounded-lg shadow-sm; }
    .acc-btn { @apply w-full flex items-center justify-between px-4 py-2 text-left; }
    .acc-btn .summary { @apply text-slate-500 text-sm; }
    .acc-btn .chev { transition: transform .2s ease; }
    .acc.open .chev { transform: rotate(180deg); }
    .acc-panel { @apply border-t border-slate-200; }
    .acc-tools { @apply flex items-center gap-2 px-4 py-2; }
    .acc-search { @apply w-full px-3 py-2 text-sm border border-slate-300 rounded-md focus:outline-none focus:ring-1 focus:ring-sky-500; }
    .acc-list { max-height: 13.5rem; overflow:auto; @apply px-2 pb-3; }
    .acc-item { @apply flex items-center gap-2 px-2 py-1.5 hover:bg-slate-50 rounded cursor-pointer; }
    .acc-clear { @apply text-xs px-2 py-1 rounded border border-slate-300 text-slate-700 hover:bg-slate-50; }
  </style>
</head>

<body class="bg-slate-100 text-slate-800">
  <div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside id="sidebar" class="hidden md:flex w-64 flex-col bg-[#999999] text-white p-4">
      <div class="flex items-center mb-8">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3 text-white" viewBox="0 0 20 20" fill="currentColor">
          <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>
        </svg>
        <h1 class="text-2xl font-bold text-white">Catálogo</h1>
      </div>
      <nav id="nav-menu" class="flex-1 space-y-2">
        <a href="#resumen" class="sidebar-link active flex items-center p-3 rounded-lg">Resumen General</a>
        <a href="#detalle" class="sidebar-link flex items-center p-3 rounded-lg">Detalle por Usuario</a>
        <a href="#lideres" class="sidebar-link flex items-center p-3 rounded-lg">Comparativa por Equipo</a>
        <a href="#evolucion" class="sidebar-link flex items-center p-3 rounded-lg">Evolución Semanal</a>
        <a href="#ubicacion" class="sidebar-link flex items-center p-3 rounded-lg">Análisis por Ubicación</a>
        <a href="#analisis" class="sidebar-link flex items-center p-3 rounded-lg">Análisis Inteligente</a>
      </nav>
    </aside>

    <!-- Main -->
    <main class="flex-1 overflow-x-hidden overflow-y-auto">
      <div class="container mx-auto px-6 py-8">
        <!-- Header -->
        <div class="flex flex-wrap justify-between items-center mb-6 gap-3">
          <div class="flex items-center gap-3">
            <button id="mobile-menu-button" class="md:hidden text-slate-600">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
              </svg>
            </button>
            <h2 id="page-title" class="text-3xl font-bold text-slate-700">Resumen General</h2>
          </div>

          <!-- Toolbar global: limpiar + exportar -->
          <div class="flex items-center gap-2">
            <button id="btn-clear-filters" class="px-3 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-slate-700 text-sm">
              Limpiar todos los filtros
            </button>

            <div class="dropdown">
              <button id="btn-export" class="px-3 py-2 rounded-lg bg-sky-600 hover:bg-sky-700 text-white text-sm">
                Exportar
              </button>
              <div id="export-menu" class="dropdown-menu hidden">
                <a href="#" data-exp="csv">Exportar datos (CSV)</a>
                <a href="#" data-exp="sheets">Exportar a Google Sheets</a>
                <a href="#" data-exp="png">Exportar gráficos (PNG)</a>
                <a href="#" data-exp="zip">Exportar sección (ZIP)</a>
              </div>
            </div>
          </div>
        </div>

        <!-- Filtros (apilados en acordeón con checkboxes + limpiar individual) -->
        <div id="filters-accordion" class="space-y-3 mb-8"></div>

        <!-- Secciones -->
        <div id="dashboard-content">
          <!-- Resumen -->
          <section id="resumen" class="page-section">
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-6 gap-6 mb-6">
              <div class="kpi-card text-center">
                <h3 class="text-slate-500 font-medium">Total Tareas</h3>
                <p id="kpi-total-tareas" class="text-4xl font-bold mt-2"></p>
              </div>
              <div class="kpi-card text-center">
                <h3 class="text-slate-500 font-medium">IDs trabajados</h3>
                <p id="kpi-ids" class="text-4xl font-bold mt-2"></p>
              </div>
              <div class="kpi-card text-center">
                <h3 class="text-slate-500 font-medium">Promedio Diario</h3>
                <p id="kpi-promedio-diario" class="text-4xl font-bold mt-2"></p>
              </div>
              <div class="kpi-card text-center">
                <h3 class="text-slate-500 font-medium">% Efectividad</h3>
                <p id="kpi-efectividad-prom" class="text-4xl font-bold mt-2"></p>
              </div>
              <div class="kpi-card text-center">
                <h3 class="text-slate-500 font-medium">Correcciones Auditadas</h3>
                <p id="kpi-correcciones" class="text-4xl font-bold mt-2"></p>
              </div>
              <div class="kpi-card text-center">
                <h3 class="text-slate-500 font-medium">Usuarios Activos</h3>
                <p id="kpi-usuarios" class="text-4xl font-bold mt-2"></p>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <!-- Nine-box -->
              <div id="ninebox-card" class="kpi-card">
                <div class="flex justify-between items-center mb-4">
                  <h3 class="text-xl font-semibold">Productividad - Calidad</h3>
                  <button id="generate-summary-btn" class="bg-sky-500 text-white px-4 py-2 rounded-lg hover:bg-sky-600 transition-colors text-sm font-medium">✨ Generar Resumen</button>
                </div>
                <div id="ninebox-grid" class="grid grid-cols-4 gap-2"></div>
                <p class="mt-3 text-xs text-slate-500">
                  Productividad: Alta ≥80; Media 70–&lt;80; Baja &lt;70. &nbsp;|&nbsp;
                  Calidad: Alta ≥90%; Media 75%–&lt;90%; Baja &lt;75%.
                </p>
                <div id="ninebox-missing" class="mt-4 text-sm text-slate-600 ai-output"></div>
                <div id="ninebox-details" class="mt-4 hidden"></div>
              </div>

              <!-- Demanda vs Enhancement -->
              <div class="kpi-card">
                <h3 class="text-xl font-semibold mb-4">Tareas Demanda vs. Enhancement</h3>
                <div class="chart-container relative mx-auto" style="height:320px;max-width:360px">
                  <canvas id="demandPieChart"></canvas>
                </div>
                <div id="demandTotals" class="mt-3 text-center text-sm text-slate-600"></div>
              </div>
            </div>
          </section>

          <!-- Detalle por Usuario -->
          <section id="detalle" class="page-section hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div class="kpi-card lg:col-span-2">
                <h3 class="text-xl font-semibold mb-4">Promedio Diario - % Efectividad</h3>
                <div class="chart-container"><canvas id="tasksByUserChart"></canvas></div>
              </div>
              <div class="grid grid-cols-1 gap-4">
                <div class="kpi-card text-center">
                  <h3 class="text-slate-500 font-medium">Promedio Diario</h3>
                  <p id="det-kpi-prom" class="text-4xl font-bold mt-2"></p>
                </div>
                <div class="kpi-card text-center">
                  <h3 class="text-slate-500 font-medium">% Efectividad</h3>
                  <p id="det-kpi-ef" class="text-4xl font-bold mt-2"></p>
                </div>
                <div class="kpi-card text-center">
                  <h3 class="text-slate-500 font-medium">IDs trabajados</h3>
                  <p id="det-kpi-ids" class="text-3xl font-bold mt-2"></p>
                </div>
              </div>
            </div>
          </section>

          <!-- Comparativa por equipo -->
          <section id="lideres" class="page-section hidden">
            <div class="kpi-card">
              <h3 class="text-xl font-semibold mb-4">Comparativa por Equipo</h3>
              <div class="chart-container"><canvas id="tasksByLeaderChart"></canvas></div>
            </div>
          </section>

          <!-- Evolución semanal -->
          <section id="evolucion" class="page-section hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div class="kpi-card lg:col-span-2">
                <h3 class="text-xl font-semibold mb-4">Promedio Diario - % Efectividad</h3>
                <div class="chart-container"><canvas id="weeklyEvolutionChart"></canvas></div>
              </div>
              <div class="grid grid-cols-1 gap-4">
                <div class="kpi-card text-center">
                  <h3 class="text-slate-500 font-medium">Promedio Diario</h3>
                  <p id="evo-kpi-prom" class="text-4xl font-bold mt-2"></p>
                </div>
                <div class="kpi-card text-center">
                  <h3 class="text-slate-500 font-medium">% Efectividad</h3>
                  <p id="evo-kpi-ef" class="text-4xl font-bold mt-2"></p>
                </div>
                <div class="kpi-card text-center">
                  <h3 class="text-slate-500 font-medium">IDs trabajados</h3>
                  <p id="evo-kpi-ids" class="text-3xl font-bold mt-2"></p>
                </div>
                <div class="kpi-card text-center">
                  <h3 class="text-slate-500 font-medium">Usuarios Activos</h3>
                  <p id="evo-kpi-users" class="text-3xl font-bold mt-2"></p>
                </div>
              </div>
            </div>
          </section>

          <!-- Ubicación -->
          <section id="ubicacion" class="page-section hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div class="kpi-card">
                <h3 class="text-xl font-semibold mb-4">Promedio Diario - % Efectividad</h3>
                <div class="chart-container"><canvas id="locCombinedChart"></canvas></div>
              </div>
              <div class="kpi-card">
                <h3 class="text-xl font-semibold mb-4">Antigüedad Promedio (meses)</h3>
                <div id="avg-antiguedad-cards" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
              </div>
            </div>
          </section>

          <!-- IA -->
          <section id="analisis" class="page-section hidden">
            <div class="kpi-card">
              <h3 class="text-xl font-semibold mb-2">Análisis Inteligente con Gemini</h3>
              <p class="text-slate-600 mb-4">Insights basados en los datos y filtros actuales.</p>
              <button id="generate-insights-btn" class="bg-sky-600 text-white px-6 py-3 rounded-lg hover:bg-sky-700 transition-colors text-base font-semibold">
                ✨ Analizar Datos y Generar Sugerencias
              </button>
              <div id="insights-output" class="mt-6 p-4 bg-slate-50 rounded-md border border-slate-200 hidden ai-output"></div>
            </div>
          </section>
        </div>
      </div>
    </main>
  </div>

  <!-- Menú móvil -->
  <div id="mobile-menu" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden">
    <aside class="absolute top-0 left-0 h-full w-64 bg-[#999999] text-white p-4 transform -translate-x-full transition-transform duration-300">
      <div class="flex justify-between items-center mb-8">
        <h1 class="text-2xl font-bold text-white">Menú</h1>
        <button id="close-mobile-menu">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <nav id="mobile-nav-menu" class="flex-1 space-y-2"></nav>
    </aside>
  </div>

  <script>
  /**********************
   * CONFIG
   **********************/
  const GEMINI_PROXY_URL = "https://catalogo.ezequiel-galarza.workers.dev/?model=gemini-1.5-flash";
  const FILES = { productividad:'productividad.csv', calidad:'calidad.csv', base:'base.csv', lideres:'lideres.csv' };
  const SHEETS_WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbxqTzxdY090fV2JWIFxiqAVnkre_dtUw1M09ZMv9mNKYz3GQW-d1ONSP_FIJTswZ9t2qA/exec";

  // Paleta
  const PALETTE = { c0:'#86eae9', c1:'#3edad8', c2:'#37c9ef', c3:'#37c9ef', c4:'#2c92d5', c5:'#13538a' };
  const BAR_BG = 'rgba(55,201,239,0.5)';
  const LINE_ACC = PALETTE.c1;

  Chart.defaults.elements.bar.borderRadius = 6;
  Chart.defaults.elements.line.borderWidth = 4;
  Chart.defaults.elements.point.radius = 3;
  Chart.defaults.elements.point.hoverRadius = 5;
  Chart.defaults.elements.point.borderWidth = 2;
  Chart.defaults.plugins.legend.labels.usePointStyle = true;

  /**********************
   * HELPERS
   **********************/
  const MONTHS_ES = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  const Q_OF_MONTH_INDEX = m => 'Q' + (Math.floor(m/3)+1);

  function ghURL(file){
    const bust = `?v=${Date.now()}`;
    return [ `/metricas/${file}${bust}`, `https://raw.githubusercontent.com/catalogo-meli/metricas/main/${file}${bust}` ];
  }
  async function fetchCSVFile(file){
    const [u1,u2] = ghURL(file);
    let r = await fetch(u1,{cache:'no-store'});
    if(!r.ok) r = await fetch(u2,{cache:'no-store'});
    if(!r.ok) throw new Error(`No pude cargar ${file}. HTTP ${r.status}`);
    return r.text();
  }
  function parseCSV(text){
    const parsed = Papa.parse(text,{ header:true, skipEmptyLines:true, delimitersToGuess:[',',';','\t','|'] });
    return parsed.data.map(row=>{ const out={}; for(const [k,v] of Object.entries(row)) out[k]=normalizeValue(v); return out; });
  }
  function normalizeValue(v){
    if(v===null||v===undefined) return v;
    if(typeof v!=='string') return v;
    const t=v.trim(); if(!t) return '';
    if(t.endsWith('%')){ const n=Number(t.replace('%','').replace(/\./g,'').replace(',','.')); return Number.isFinite(n)? n/100 : t; }
    if(/^-?\d{1,3}(\.\d{3})*,\d+$/.test(t)){ const n=Number(t.replace(/\./g,'').replace(',','.')); return Number.isFinite(n)? n : t; }
    if(/^-?\d+(\.\d+)?$/.test(t)){ const n=Number(t); return Number.isFinite(n)? n : t; }
    return t;
  }
  function parseDateAny(val){
    if(val===null||val===undefined||val==='') return null;
    if(typeof val==='number'){ const ms=Math.round((val-25569)*86400*1000); const d=new Date(ms); return isNaN(d.getTime())? null : d; }
    const s=String(val).trim(); const m=s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
    if(m){ const d=Number(m[1]), mo=Number(m[2])-1, y=Number(m[3].length===2?'20'+m[3]:m[3]); const dt=new Date(y,mo,d); return isNaN(dt.getTime())? null : dt; }
    const dt=new Date(s); return isNaN(dt.getTime())? null : dt;
  }
  function keyIncludes(k,needle){ return k.toLowerCase().includes(needle); }
  function pick(row,needles){ const keys=Object.keys(row); for(const n of needles){ const k=keys.find(k=>keyIncludes(k,n)); if(k) return row[k]; } }
  function correoAUsuario(mail){ if(!mail) return ''; return String(mail).toLowerCase().replace(/\s/g,'').replace(/@mercadolibre\.com/i,''); }

  const fmt = {
    int: n => (n ?? 0).toLocaleString('es-AR'),
    pct: x => (x ?? 0).toLocaleString('es-AR',{style:'percent',minimumFractionDigits:2,maximumFractionDigits:2}),
    dec: x => (x ?? 0).toLocaleString('es-AR',{minimumFractionDigits:2,maximumFractionDigits:2})
  };

  /**********************
   * FILTROS (acordeón con multiselección)
   **********************/
  const FILTERS = [
    {key:'q',      id:'filter-q',       label:'Trimestres', placeholder:'Todos los trimestres'},
    {key:'mes',    id:'filter-mes',     label:'Mes',        placeholder:'Todos los meses'},
    {key:'semana', id:'filter-semana',  label:'Semana',     placeholder:'Todas las semanas'},
    {key:'ubic',   id:'filter-ubicacion',label:'Ubicación', placeholder:'Todas las ubicaciones'},
    {key:'lider',  id:'filter-lider',   label:'Líderes',    placeholder:'Todos los líderes'},
    {key:'user',   id:'filter-usuario', label:'Usuarios',   placeholder:'Todos los usuarios'},
    {key:'flows',  id:'filter-flujo',   label:'Flujo',      placeholder:'Flujo mixto', isFlow:true}
  ];
  const defById = Object.fromEntries(FILTERS.map(d=>[d.id,d]));

  const sel = {
    q:new Set(), mes:new Set(), semana:new Set(), ubic:new Set(), lider:new Set(), user:new Set(),
    flows:new Set(['mixto']) // por defecto
  };

  // Construye 7 acordeones apilados
  function setupAccordions(){
    const wrap = document.getElementById('filters-accordion');
    wrap.innerHTML = FILTERS.map(def=>`
      <div class="acc" id="${def.id}">
        <button type="button" class="acc-btn">
          <div>
            <div class="font-medium text-slate-700">${def.label}</div>
            <div class="summary">${def.placeholder}</div>
          </div>
          <div class="flex items-center gap-3">
            <button class="acc-clear hidden sm:inline-block" data-clear>Limpiar</button>
            <svg class="chev h-5 w-5 text-slate-500" viewBox="0 0 20 20" fill="currentColor">
              <path d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z"/>
            </svg>
          </div>
        </button>
        <div class="acc-panel hidden">
          <div class="acc-tools">
            <input type="text" class="acc-search" placeholder="Buscar...">
            <button class="acc-clear" data-clear>Limpiar ${def.label}</button>
          </div>
          <div class="acc-list"></div>
        </div>
      </div>
    `).join('');

    // listeners por acordeón
    FILTERS.forEach(def=>{
      const root = document.getElementById(def.id);
      const btn  = root.querySelector('.acc-btn');
      const pnl  = root.querySelector('.acc-panel');
      btn.addEventListener('click', (e)=>{
        // Evita que el click en "Limpiar" abra/cierre
        if(e.target.closest('[data-clear]')) return;
        root.classList.toggle('open');
        pnl.classList.toggle('hidden');
      });
      // limpiar individual
      root.querySelectorAll('[data-clear]').forEach(b=>{
        b.addEventListener('click', (e)=>{
          e.preventDefault();
          if(def.isFlow){ sel.flows = new Set(['mixto']); }
          else { sel[def.key].clear(); }
          updateFilterOptions(def.id); // re-render items (checks)
          updateFilterSummary(def.id);
          applyFilters();
        });
      });
      // búsqueda
      root.querySelector('.acc-search').addEventListener('input', (ev)=>{
        const term = ev.target.value.toLowerCase();
        root.querySelectorAll('.acc-item').forEach(it=>{
          const t=it.getAttribute('data-text');
          it.classList.toggle('hidden', t.indexOf(term)===-1);
        });
      });
    });
  }

  function updateFilterSummary(id){
    const def = defById[id];
    const values = Array.from(sel[def.key] || []);
    const el = document.querySelector(`#${id} .summary`);
    if(!values.length){
      el.textContent = def.placeholder;
      return;
    }
    el.textContent = values.length<=2 ? values.join(', ') : `${values.slice(0,2).join(', ')} +${values.length-2}`;
  }

  function updateFilterOptions(id, values=[]){
    const def = defById[id];
    const list = document.querySelector(`#${id} .acc-list`);

    // default opciones para flujo
    if(def.isFlow && values.length===0){
      values = ['mixto','demanda','enhancement'];
    }

    // restringe selección a valores permitidos (salvo flujo)
    if(!def.isFlow){
      const ok = new Set(values);
      sel[def.key] = new Set(Array.from(sel[def.key]).filter(v=>ok.has(v)));
    }

    list.innerHTML = values.map(v=>{
      const checked = (sel[def.key]||new Set()).has(v) ? 'checked' : '';
      return `
        <label class="acc-item" data-text="${String(v).toLowerCase()}">
          <input type="checkbox" class="acc-check" value="${v}" ${checked}>
          <span class="text-sm">${v}</span>
        </label>`;
    }).join('');

    list.querySelectorAll('.acc-check').forEach(chk=>{
      chk.addEventListener('change', ()=>{
        const val = chk.value;
        if(def.isFlow){
          if(val==='mixto' && chk.checked){
            sel.flows = new Set(['mixto']);
          }else{
            sel.flows.delete('mixto');
            if(chk.checked) sel.flows.add(val); else sel.flows.delete(val);
            if(sel.flows.size===0) sel.flows = new Set(['mixto']);
          }
          // re-render por exclusividad
          updateFilterOptions(id, values);
        }else{
          if(chk.checked) sel[def.key].add(val); else sel[def.key].delete(val);
        }
        updateFilterSummary(id);
        applyFilters();
      });
    });

    updateFilterSummary(id);
  }

  /**********************
   * BUILD CONSOLIDADO
   **********************/
  function buildWeeklyRows(prod, cal, base, lideres){
    const P = prod.map(r=>({
      fecha: parseDateAny(pick(r,['fecha'])),
      week:  Number(pick(r,['week'])),
      user:  correoAUsuario(pick(r,['usuario','user'])),
      dem:   Number(pick(r,['tareas de demanda','demanda']))||0,
      enh:   Number(pick(r,['tareas de enhancement','enhancement']))||0,
      total: Number(pick(r,['total tareas','total']))||0,
      idsW:  Number(pick(r,['ids trabaj']))||0
    })).filter(r=>r.fecha && r.week && r.user);

    const C = cal.map(r=>({
      week: Number(pick(r,['week'])),
      user: correoAUsuario(pick(r,['usuario','user'])),
      idsC: Number(pick(r,['ids audit']))||0,
      err:  Number(pick(r,['total error','errores']))||0
    })).filter(r=>r.week && r.user);

    const perfiles = new Map();
    base.forEach(r=>{
      const user = correoAUsuario(pick(r,['mail','email']));
      if(!user) return;
      perfiles.set(user,{ ciudad: pick(r,['ciudad','ubicación'])||'', ingreso: parseDateAny(pick(r,['fecha ingreso','ingreso'])) });
    });

    const liderPorUser = new Map();
    lideres.forEach(r=>{
      const user = correoAUsuario(pick(r,['usuario','user']));
      let lider  = pick(r,['líder','lider']) || '';
      if(String(lider||'').toLowerCase()==='sin líder') return;
      if(user) liderPorUser.set(user, lider);
    });

    const weeks = new Map();
    for(const r of P){
      const y=r.fecha.getFullYear(), m=r.fecha.getMonth();
      const ym=`${y}-${String(m+1).padStart(2,'0')}`;
      const key=`${r.user}|${r.week}|${ym}`;
      if(!weeks.has(key)){
        const perf = perfiles.get(r.user)||{};
        const ingreso = perf.ingreso, hoy=new Date();
        const finAnt = (ingreso && ingreso<=hoy)? hoy : ingreso || hoy;
        const antig = ingreso ? Math.max(0,(finAnt.getFullYear()-ingreso.getFullYear())*12+(finAnt.getMonth()-ingreso.getMonth())) : '';
        weeks.set(key,{
          week:r.week, mes:MONTHS_ES[m], mesIndex:m,
          user:r.user, lider:liderPorUser.get(r.user)||'Sin líder',
          ciudad:perf.ciudad||'', antig,
          dias:new Set(), demand:0, enh:0, total:0, idsWork:0, idsCal:0, errCal:0
        });
      }
      const o=weeks.get(key);
      o.demand+=r.dem; o.enh+=r.enh; o.total+=r.total; o.idsWork+=r.idsW;
      const dKey = `${r.fecha.getFullYear()}-${String(r.fecha.getMonth()+1).padStart(2,'0')}-${String(r.fecha.getDate()).padStart(2,'0')}`;
      o.dias.add(dKey);
    }

    for(const r of C){
      const pref = `${r.user}|${r.week}|`;
      for(const key of weeks.keys()){
        if(key.startsWith(pref)){
          const o = weeks.get(key);
          o.idsCal += r.idsC;
          o.errCal += r.err;
        }
      }
    }

    const rows = Array.from(weeks.values()).sort((a,b)=>a.week-b.week).map(o=>{
      const prom = o.dias.size ? (o.total/o.dias.size) : '';
      const pEf  = o.idsCal>0 ? (1 - (o.errCal/o.idsCal)) : '';
      return {
        week:o.week, mes:o.mes, mesIndex:o.mesIndex, usuario:o.user, líder:o.lider, ciudad:o.ciudad, antigüedad:o.antig,
        promedio_diario: prom, efectividad:pEf,
        tareas_demanda:o.demand, tareas_enhancement:o.enh, total_tareas:o.total,
        ids_trabajados:o.idsWork, correcciones_auditadas:o.idsCal, dias_activos:o.dias.size,
        q: Q_OF_MONTH_INDEX(o.mesIndex)
      };
    });
    return rows;
  }

  /**********************
   * ESTADO GLOBAL
   **********************/
  let originalData = [];
  let currentData  = [];
  const charts = {};
  let nineboxDetailsData = {};

  /**********************
   * NAV + EXPORT + LIMPIAR
   **********************/
  function setupNavigation(){
    const links=[...document.querySelectorAll('#nav-menu a')];
    const mobile=document.getElementById('mobile-nav-menu');
    mobile.innerHTML = links.map(a=>`<a href="${a.getAttribute('href')}" class="block p-3 rounded-lg hover:bg-gray-700">${a.textContent}</a>`).join('');
    links.forEach(a=>{
      a.addEventListener('click', e=>{
        e.preventDefault();
        const target=a.getAttribute('href');
        document.querySelectorAll('.page-section').forEach(s=>s.classList.add('hidden'));
        document.querySelector(target).classList.remove('hidden');
        links.forEach(x=>x.classList.remove('active')); a.classList.add('active');
        document.getElementById('page-title').textContent=a.textContent;
        if(target==='#detalle'){ renderTasksByUser(); updateDetailKPIs(); }
        if(target==='#lideres')      renderTasksByLeader();
        if(target==='#evolucion'){   renderWeeklyEvolution(); updateEvolutionKPIs(); }
        if(target==='#ubicacion')    renderByLocation();
      });
    });

    // menú móvil
    const mobBtn=document.getElementById('mobile-menu-button');
    const mob=document.getElementById('mobile-menu');
    const mobClose=document.getElementById('close-mobile-menu');
    mobBtn.addEventListener('click', ()=>{ mob.classList.remove('hidden'); mob.querySelector('aside').classList.remove('-translate-x-full'); });
    mobClose.addEventListener('click', ()=>{ mob.querySelector('aside').classList.add('-translate-x-full'); setTimeout(()=>mob.classList.add('hidden'),200); });
    mobile.querySelectorAll('a').forEach(a=>{
      a.addEventListener('click', ()=>{ mob.querySelector('aside').classList.add('-translate-x-full'); setTimeout(()=>mob.classList.add('hidden'),200); });
    });

    // Export dropdown
    document.getElementById('btn-export').addEventListener('click', ()=>{
      document.getElementById('export-menu').classList.toggle('hidden');
    });
    document.addEventListener('click', (e)=>{
      const dd = document.getElementById('export-menu');
      if(!dd.contains(e.target) && !document.getElementById('btn-export').contains(e.target)) dd.classList.add('hidden');
    });
    document.querySelectorAll('#export-menu a').forEach(a=>{
      a.addEventListener('click', (e)=>{
        e.preventDefault();
        document.getElementById('export-menu').classList.add('hidden');
        const type = a.getAttribute('data-exp');
        if(type==='csv') exportSectionCSV();
        if(type==='png') exportSectionPNGs();
        if(type==='zip') exportSectionZIP();
        if(type==='sheets') exportToGoogleSheets && exportToGoogleSheets();
      });
    });

    // Limpiar todos los filtros
    document.getElementById('btn-clear-filters').addEventListener('click', ()=>{
      sel.q.clear(); sel.mes.clear(); sel.semana.clear(); sel.ubic.clear(); sel.lider.clear(); sel.user.clear();
      sel.flows = new Set(['mixto']);
      refreshDependentFilters();
      FILTERS.forEach(def=>updateFilterSummary(def.id));
      applyFilters();
    });
  }

  /**********************
   * FILTRADO (multi + dependencias)
   **********************/
  function uniqueSorted(arr){ return Array.from(new Set(arr)).sort(); }
  function uniqueSortedNum(arr){ return Array.from(new Set(arr)).sort((a,b)=>a-b); }

  function getFilterState(){
    return {
      mes:     Array.from(sel.mes),
      semana:  Array.from(sel.semana).map(String),
      ubic:    Array.from(sel.ubic),
      user:    Array.from(sel.user),
      lider:   Array.from(sel.lider),
      q:       Array.from(sel.q),
      flows:   selectedFlows()
    };
  }

  function selectedFlows(){
    const values = Array.from(sel.flows);
    if(values.length===0 || values.includes('mixto')) return ['mixto'];
    return values;
  }
  const tareasByFlows = (r, flows) => {
    if (flows.includes('mixto')) return (r.total_tareas||0);
    let s = 0;
    if (flows.includes('demanda')) s += (r.tareas_demanda||0);
    if (flows.includes('enhancement')) s += (r.tareas_enhancement||0);
    return s;
  };
  function promedioDiario(rows, flows){
    const den = rows.reduce((s,r)=> s + (r.dias_activos||0), 0);
    const num = rows.reduce((s,r)=> s + tareasByFlows(r,flows), 0);
    return den ? num/den : 0;
  }
  function setColor(el, color){
    el.classList.remove('text-red-600','text-yellow-500','text-green-600','text-orange-500');
    if(color) el.classList.add(color);
  }

  // Data filtrada por todo excepto una clave (para recalcular opciones válidas)
  function filteredOriginalDataExcept(exceptKey){
    const v = getFilterState();
    return originalData.filter(r =>
      (exceptKey==='mes'    || v.mes.length===0    || v.mes.includes(r.mes)) &&
      (exceptKey==='semana' || v.semana.length===0 || v.semana.includes(String(r.week))) &&
      (exceptKey==='ubic'   || v.ubic.length===0   || v.ubic.includes(r.ciudad)) &&
      (exceptKey==='user'   || v.user.length===0   || v.user.includes(r.usuario)) &&
      (exceptKey==='lider'  || v.lider.length===0  || v.lider.includes(r['líder'])) &&
      (exceptKey==='q'      || v.q.length===0      || v.q.includes(r.q))
    );
  }

  function refreshDependentFilters(){
    // Q
    {
      const allowed = filteredOriginalDataExcept('q');
      const qs = ['Q1','Q2','Q3','Q4'].filter(q => allowed.some(r=>r.q===q));
      updateFilterOptions('filter-q', qs);
    }
    // Mes
    {
      const allowed = filteredOriginalDataExcept('mes');
      const meses = MONTHS_ES.filter(m => allowed.some(r=>r.mes===m));
      updateFilterOptions('filter-mes', meses);
    }
    // Semana
    {
      const allowed = filteredOriginalDataExcept('semana');
      const semanas = uniqueSortedNum(allowed.map(r=>r.week)).map(String);
      updateFilterOptions('filter-semana', semanas);
    }
    // Ubicación
    {
      const allowed = filteredOriginalDataExcept('ubic');
      const ubic = uniqueSorted(allowed.map(r=>r.ciudad).filter(Boolean));
      updateFilterOptions('filter-ubicacion', ubic);
    }
    // Líder
    {
      const allowed = filteredOriginalDataExcept('lider');
      const lideres = uniqueSorted(allowed.map(r=>r['líder']).filter(l => l && l.toLowerCase()!=='sin líder'));
      updateFilterOptions('filter-lider', lideres);
    }
    // Usuario
    {
      const allowed = filteredOriginalDataExcept('user');
      const usuarios= uniqueSorted(allowed.map(r=>r.usuario));
      updateFilterOptions('filter-usuario', usuarios);
    }
    // Flujo (estático)
    updateFilterOptions('filter-flujo', ['mixto','demanda','enhancement']);
  }

  function applyFilters(){
    refreshDependentFilters(); // recalcula opciones válidas en todos

    const f = getFilterState();
    currentData = originalData.filter(r =>
      (f.mes.length===0    || f.mes.includes(r.mes)) &&
      (f.semana.length===0 || f.semana.includes(String(r.week))) &&
      (f.ubic.length===0   || f.ubic.includes(r.ciudad)) &&
      (f.user.length===0   || f.user.includes(r.usuario)) &&
      (f.lider.length===0  || f.lider.includes(r['líder'])) &&
      (f.q.length===0      || f.q.includes(r.q))
    );

    updateKPIs();
    renderNineBox();
    renderDemandPie();
    renderTasksByUser();
    renderTasksByLeader();
    renderWeeklyEvolution();
    renderByLocation();
    updateEvolutionKPIs();
    updateDetailKPIs();
  }

  /**********************
   * KPI + RENDER
   **********************/
  function updateKPIs(){
    const flows = selectedFlows();

    const totalFlujo = currentData.reduce((s,r)=> s + tareasByFlows(r,flows), 0);
    const idsTrab = currentData.reduce((s,r)=> s + (r.ids_trabajados||0), 0);
    const usuarios = new Set(currentData.map(r=>r.usuario)).size;
    const correcc = currentData.reduce((s,r)=> s + (r.correcciones_auditadas||0), 0);
    const prom = promedioDiario(currentData, flows);
    const vals = currentData.map(r=>r.efectividad).filter(v => v!=='' && v!==null && v!==undefined);
    const ef = vals.length ? vals.reduce((a,b)=>a+b,0)/vals.length : 0;

    const promEl = document.getElementById('kpi-promedio-diario');
    const efEl   = document.getElementById('kpi-efectividad-prom');

    let promColor = (prom<=70) ? 'text-red-600' : (prom>=80) ? 'text-green-600' : 'text-yellow-500';
    setColor(promEl, promColor);

    const efPct = ef*100;
    let efColor = (efPct<=75) ? 'text-red-600'
                 : (efPct<87) ? 'text-orange-500'
                 : (efPct<90) ? 'text-yellow-500'
                 : 'text-green-600';
    setColor(efEl, efColor);

    document.getElementById('kpi-total-tareas').textContent     = fmt.int(totalFlujo);
    document.getElementById('kpi-ids').textContent              = fmt.int(idsTrab);
    document.getElementById('kpi-usuarios').textContent         = fmt.int(usuarios);
    document.getElementById('kpi-correcciones').textContent     = fmt.int(correcc);
    promEl.textContent = fmt.dec(prom);
    efEl.textContent   = fmt.pct(ef);
  }

  // KPIs a la derecha del gráfico en "Evolución Semanal"
  function updateEvolutionKPIs(){
    const flows = selectedFlows();
    const idsTrab = currentData.reduce((s,r)=> s + (r.ids_trabajados||0), 0);
    const usuarios = new Set(currentData.map(r=>r.usuario)).size;
    const prom = promedioDiario(currentData, flows);
    const vals = currentData.map(r=>r.efectividad).filter(v=>v!=='' && v!==null && v!==undefined);
    const ef   = vals.length ? vals.reduce((a,b)=>a+b,0)/vals.length : 0;

    const promEl = document.getElementById('evo-kpi-prom');
    const efEl   = document.getElementById('evo-kpi-ef');
    setColor(promEl, (prom<=70) ? 'text-red-600' : (prom>=80) ? 'text-green-600' : 'text-yellow-500');

    const efPct = ef*100;
    setColor(efEl, (efPct<=75) ? 'text-red-600' : (efPct<87) ? 'text-orange-500' : (efPct<90) ? 'text-yellow-500' : 'text-green-600');

    promEl.textContent = fmt.dec(prom);
    efEl.textContent   = fmt.pct(ef);
    document.getElementById('evo-kpi-ids').textContent   = fmt.int(idsTrab);
    document.getElementById('evo-kpi-users').textContent = fmt.int(usuarios);
  }

  // KPIs a la derecha del gráfico en "Detalle por Usuario"
  function updateDetailKPIs(){
    const flows = selectedFlows();
    const idsTrab = currentData.reduce((s,r)=> s + (r.ids_trabajados||0), 0);
    const prom = promedioDiario(currentData, flows);
    const vals = currentData.map(r=>r.efectividad).filter(v=>v!=='' && v!==null && v!==undefined);
    const ef   = vals.length ? vals.reduce((a,b)=>a+b,0)/vals.length : 0;

    const promEl = document.getElementById('det-kpi-prom');
    const efEl   = document.getElementById('det-kpi-ef');
    setColor(promEl, (prom<=70) ? 'text-red-600' : (prom>=80) ? 'text-green-600' : 'text-yellow-500');

    const efPct = ef*100;
    setColor(efEl, (efPct<=75) ? 'text-red-600' : (efPct<87) ? 'text-orange-500' : (efPct<90) ? 'text-yellow-500' : 'text-green-600');

    promEl.textContent = fmt.dec(prom);
    efEl.textContent   = fmt.pct(ef);
    document.getElementById('det-kpi-ids').textContent = fmt.int(idsTrab);
  }

  function createOrUpdateChart(id, cfg){
    if(charts[id]){ charts[id].data=cfg.data; charts[id].options=cfg.options||{}; charts[id].update(); return charts[id]; }
    const ctx=document.getElementById(id).getContext('2d');
    charts[id]=new Chart(ctx,cfg); return charts[id];
  }
  function barDataset(label, data){
    return {
      type:'bar', label, data, yAxisID:'y',
      backgroundColor: BAR_BG, borderColor:'rgba(0,0,0,0)', order:1, barPercentage:0.8, categoryPercentage:0.8
    };
  }
  function lineEffDataset(label, data){
    return {
      type:'line', label, data, yAxisID:'y1',
      borderColor: LINE_ACC, backgroundColor: LINE_ACC, order:2, fill:false, tension:0.25,
      pointRadius:3, pointHoverRadius:5, pointBackgroundColor:'#ffffff', pointBorderColor:LINE_ACC, borderWidth:3, spanGaps:true
    };
  }

  /* ---------- Nine-box ---------- */
  function renderNineBox(){
    const flows = selectedFlows();

    const map = new Map(); // user -> {num,den, effSum, effN}
    currentData.forEach(r=>{
      const u=r.usuario;
      const o=map.get(u)||{num:0,den:0,effSum:0,effN:0};
      o.num += tareasByFlows(r,flows); o.den += (r.dias_activos||0);
      if(r.efectividad!=='' && r.efectividad!==null && r.efectividad!==undefined){ o.effSum+=r.efectividad; o.effN++; }
      map.set(u,o);
    });

    const users = Array.from(map.entries()).map(([u,o])=>{
      const prom = o.den? o.num/o.den : null;
      const eff  = o.effN? o.effSum/o.effN : null;
      return {u, prom, eff};
    });

    const prodBand = p => (p>=80 ? 'alta' : p>=70 ? 'media' : 'baja');
    const calBand  = e => (e>=0.90 ? 'alta' : e>=0.75 ? 'media' : 'baja');

    const rows=['alta','media','baja'];
    const cols=['alta','media','baja'];

    const buckets = {};
    const details = {};
    rows.forEach(r=>cols.forEach(c=>{ buckets[`${r}-${c}`]=[]; details[`${r}-${c}`]=[]; }));

    const missing = [];
    users.forEach(x=>{
      if(x.prom===null || x.eff===null){
        missing.push(x);
      }else{
        const key = `${prodBand(x.prom)}-${calBand(x.eff)}`;
        buckets[key].push(x.u);
        details[key].push({usuario:x.u, prom:x.prom, eff:x.eff});
      }
    });

    const grid = document.getElementById('ninebox-grid');
    const label = s=> s.charAt(0).toUpperCase()+s.slice(1);
    const cellClass = (r,c)=>{
      if(r==='alta' && c==='alta') return 'nb-green';
      if(r==='alta' && c==='media') return 'nb-yellow';
      if(r==='alta' && c==='baja') return 'nb-orange';
      if(r==='media' && c==='alta') return 'nb-yellow';
      if(r==='media' && c==='media') return 'nb-yellow';
      if(r==='media' && c==='baja') return 'nb-orange';
      if(r==='baja' && c==='alta') return 'nb-yellow';
      if(r==='baja' && c==='media') return 'nb-orange';
      return 'nb-red';
    };
    const hdrCell = (txt)=>`<div class="nb-cell nb-hdr" style="height:42px">${txt}</div>`;

    let html = '';
    html += hdrCell('&nbsp;');
    cols.forEach(c=> html += hdrCell('Calidad '+label(c)));
    rows.forEach(r=>{
      html += hdrCell('Prod. '+label(r));
      cols.forEach(c=>{
        const arr = buckets[`${r}-${c}`]||[];
        html += `<div class="nb-cell ${cellClass(r,c)}" data-bucket="${r}-${c}" title="Prod ${label(r)} / Calidad ${label(c)}">
                  <span class="nb-badge">${arr.length}</span>
                </div>`;
      });
    });
    grid.innerHTML = html;

    nineboxDetailsData = details;

    grid.onclick = (ev)=>{
      const cell = ev.target.closest('.nb-cell[data-bucket]');
      if(!cell) return;
      const key = cell.getAttribute('data-bucket');
      showNineboxDetails(key, label);
    };

    const missDiv = document.getElementById('ninebox-missing');
    if(missing.length){
      const lines = missing
        .sort((a,b)=> (a.u>b.u?1:-1))
        .map(m=>{
          const parts = [];
          if(m.prom!==null) parts.push(`Promedio Diario: ${m.prom.toFixed(2)}`);
          if(m.eff!==null)  parts.push(`% Efectividad: ${(m.eff*100).toFixed(2)}%`);
          return `• ${m.u} — ${parts.join(' | ') || 'sin datos'}`;
        });
      missDiv.innerHTML = `<div class="font-medium mb-1">Perfiles no incluidos por datos faltantes</div><div class="whitespace-pre-line">${lines.join('\n')}</div>`;
    }else{
      missDiv.innerHTML = '';
    }
  }

  function showNineboxDetails(bucketKey, labelFn){
    const box = document.getElementById('ninebox-details');
    const rows = (nineboxDetailsData[bucketKey]||[]).slice().sort((a,b)=>b.prom-a.prom);
    const [prod, cal] = bucketKey.split('-').map(labelFn);
    if(!rows.length){
      box.innerHTML = `
        <div class="flex items-center justify-between mb-2">
          <div class="font-semibold">Prod. ${prod} / Calidad ${cal}</div>
          <button class="text-slate-500 hover:text-slate-700 text-sm" id="nb-close">Cerrar</button>
        </div>
        <div class="text-slate-500 text-sm">Sin perfiles en este cuadrante para los filtros actuales.</div>`;
      box.classList.remove('hidden');
      document.getElementById('nb-close').onclick = ()=> box.classList.add('hidden');
      return;
    }

    const header = `
      <div class="flex items-center justify-between mb-2">
        <div class="font-semibold">Prod. ${prod} / Calidad ${cal} — <span class="text-slate-500 font-normal">${rows.length} perfiles</span></div>
        <button class="text-slate-500 hover:text-slate-700 text-sm" id="nb-close">Cerrar</button>
      </div>`;

    const table = `
      <div class="overflow-x-auto border border-slate-200 rounded-md">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 text-slate-600">
            <tr>
              <th class="text-left px-3 py-2">Usuario</th>
              <th class="text-right px-3 py-2">Prom. Diario</th>
              <th class="text-right px-3 py-2">% Efectividad</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r=>`
              <tr class="border-t">
                <td class="px-3 py-2">${r.usuario}</td>
                <td class="px-3 py-2 text-right">${fmt.dec(r.prom)}</td>
                <td class="px-3 py-2 text-right">${fmt.pct(r.eff)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>`;

    box.innerHTML = header + table;
    box.classList.remove('hidden');
    document.getElementById('nb-close').onclick = ()=> box.classList.add('hidden');
  }

  /* ---------- Demanda vs Enhancement ---------- */
  function renderDemandPie(){
    const demand = currentData.reduce((s,r)=> s + (r.tareas_demanda||0), 0);
    const enh    = currentData.reduce((s,r)=> s + (r.tareas_enhancement||0), 0);
    const tot = demand+enh;
    const pctD = tot? (100*demand/tot) : 0;
    const pctE = tot? (100*enh   /tot) : 0;

    createOrUpdateChart('demandPieChart',{
      type:'pie',
      data:{ labels:['Demanda','Enhancement'], datasets:[{ data:[pctD, pctE], backgroundColor:[PALETTE.c0, PALETTE.c4] }] },
      options:{
        responsive:true,
        plugins:{
          legend:{ position:'bottom' },
          tooltip:{ callbacks:{ label:(ctx)=> `${ctx.label}: ${ctx.parsed.toFixed(1)}%` } }
        }
      }
    });

    document.getElementById('demandTotals').textContent =
      `Total Demanda: ${fmt.int(demand)} — Total Enhancement: ${fmt.int(enh)}`;
  }

  /* ---------- Detalle por usuario ---------- */
  function renderTasksByUser(){
    const flows = selectedFlows();

    const agg = new Map(); // user -> {num,den, effNum, effDen}
    currentData.forEach(r=>{
      const u=r.usuario; const o=agg.get(u)||{num:0,den:0,effNum:0,effDen:0};
      o.num += tareasByFlows(r,flows);
      o.den += (r.dias_activos||0);
      if(r.efectividad!=='' && r.efectividad!==null && r.efectividad!==undefined){
        const w=(r.correcciones_auditadas||0)||1;
        o.effNum += r.efectividad*w; o.effDen += w;
      }
      agg.set(u,o);
    });

    const arr = Array.from(agg.entries()).map(([u,o])=>{
      const prom = o.den? o.num/o.den : 0;
      const effPct = o.effDen? (100*o.effNum/o.effDen) : null;
      return { user:u, prom, effPct };
    }).sort((a,b)=>b.prom-a.prom);

    createOrUpdateChart('tasksByUserChart',{
      data:{
        labels:arr.map(x=>x.user),
        datasets:[
          barDataset('Prom. diario', arr.map(x=>x.prom)),
          lineEffDataset('% Efectividad', arr.map(x=>x.effPct))
        ]
      },
      options:{
        responsive:true,
        scales:{
          y:{ position:'left', ticks:{ callback:v=>Number(v).toLocaleString('es-AR',{minimumFractionDigits:2,maximumFractionDigits:2}) } },
          y1:{ position:'right', grid:{ drawOnChartArea:false }, ticks:{ callback:v=>`${v.toFixed(0)}%` }, suggestedMin: 50, suggestedMax: 100 },
          x:{ ticks:{ autoSkip:false, maxRotation:60, minRotation:45 } }
        }
      }
    });
  }

  /* ---------- Comparativa por equipo ---------- */
  function renderTasksByLeader(){
    const flows = selectedFlows();
    const agg = new Map(); // líder -> {num,den, effNum, effDen}
    currentData.forEach(r=>{
      const l = r['líder']; if(!l || l.toLowerCase()==='sin líder') return;
      const o = agg.get(l) || {num:0,den:0,effNum:0,effDen:0};
      o.num += tareasByFlows(r,flows);
      o.den += (r.dias_activos||0);
      if(r.efectividad!=='' && r.efectividad!==null && r.efectividad!==undefined){
        const w = (r.correcciones_auditadas || 0) || 1;
        o.effNum += r.efectividad * w;
        o.effDen += w;
      }
      agg.set(l,o);
    });
    const arr = Array.from(agg.entries()).map(([l,o])=>{
      const prom = o.den? o.num/o.den : 0;
      const effPct = o.effDen? (100*o.effNum/o.effDen) : null;
      return { lider:l, prom, effPct };
    }).sort((a,b)=>b.prom-a.prom);

    createOrUpdateChart('tasksByLeaderChart',{
      data:{
        labels:arr.map(x=>x.lider),
        datasets:[
          barDataset('Prom. diario', arr.map(x=>x.prom)),
          lineEffDataset('% Efectividad', arr.map(x=>x.effPct))
        ]
      },
      options:{
        responsive:true,
        scales:{
          y:{ position:'left', ticks:{ callback:v=>Number(v).toLocaleString('es-AR',{minimumFractionDigits:2,maximumFractionDigits:2}) } },
          y1:{ position:'right', grid:{ drawOnChartArea:false }, ticks:{ callback:v=>`${v.toFixed(0)}%` }, suggestedMin: 50, suggestedMax: 100 },
          x:{ ticks:{ autoSkip:false, maxRotation:45 } }
        }
      }
    });
  }

  /* ---------- Evolución semanal ---------- */
  function renderWeeklyEvolution(){
    const flows = selectedFlows();
    const agg = new Map(); // week -> {num,den, effNum, effDen}
    currentData.forEach(r=>{
      const w = Number(r.week); if(!Number.isFinite(w)) return;
      const o = agg.get(w)||{num:0,den:0,effNum:0,effDen:0};
      o.num += tareasByFlows(r,flows);
      o.den += (r.dias_activos||0);
      if(r.efectividad!=='' && r.efectividad!==null && r.efectividad!==undefined){
        const weight = (r.correcciones_auditadas||0)||1;
        o.effNum += r.efectividad*weight;
        o.effDen += weight;
      }
      agg.set(w,o);
    });

    const weeks = Array.from(agg.keys());
    if(!weeks.length){
      createOrUpdateChart('weeklyEvolutionChart',{type:'line',data:{labels:[],datasets:[]},options:{}});
      return;
    }
    const minW=Math.min(...weeks), maxW=Math.max(...weeks);
    const labels=[], promValues=[], effValues=[];
    for(let w=minW; w<=maxW; w++){
      labels.push('W'+String(w).padStart(2,'0'));
      const o=agg.get(w)||{num:0,den:0,effNum:0,effDen:0};
      promValues.push((o.den? o.num/o.den : 0));
      effValues.push(o.effDen? 100*o.effNum/o.effDen : null);
    }
    createOrUpdateChart('weeklyEvolutionChart',{
      data:{
        labels,
        datasets:[
          barDataset('Prom. diario', promValues),
          lineEffDataset('% Efectividad', effValues)
        ]
      },
      options:{
        responsive:true,
        plugins:{ legend:{display:true} },
        scales:{
          x:{ ticks:{autoSkip:false,maxRotation:0} },
          y:{ position:'left', ticks:{ callback:v=>Number(v).toLocaleString('es-AR',{minimumFractionDigits:2,maximumFractionDigits:2}) } },
          y1:{ position:'right', grid:{ drawOnChartArea:false }, ticks:{ callback:v=>`${v.toFixed(0)}%` }, suggestedMin: 50, suggestedMax: 100 }
        }
      }
    });
  }

  /* ---------- Ubicación ---------- */
  function renderByLocation(){
    const flows = selectedFlows();
    const byLoc = new Map(); // ciudad -> {num,den}
    const effLoc = new Map(); // ciudad -> {num,den}
    const antig = {}; // ciudad -> {sum, n}

    currentData.forEach(r=>{
      const c=r.ciudad||'Sin ubicación';
      const o=byLoc.get(c)||{num:0,den:0};
      o.num += tareasByFlows(r,flows); o.den += (r.dias_activos||0); byLoc.set(c,o);

      if(r.efectividad!=='' && r.efectividad!==null && r.efectividad!==undefined){
        const w=(r.correcciones_auditadas||0)||1;
        const e=effLoc.get(c)||{num:0,den:0};
        e.num += r.efectividad*w; e.den += w; effLoc.set(c,e);
      }

      const a = Number(r.antigüedad||0);
      if(!antig[c]) antig[c]={sum:0,n:0};
      if(Number.isFinite(a)){ antig[c].sum+=a; antig[c].n++; }
    });

    const labels = Array.from(byLoc.keys()).sort((a,b)=>{
      const va=(byLoc.get(a).den? byLoc.get(a).num/byLoc.get(a).den : 0);
      const vb=(byLoc.get(b).den? byLoc.get(b).num/byLoc.get(b).den : 0);
      return vb-va;
    });

    const promData = labels.map(c=>{ const o=byLoc.get(c); return (o.den? o.num/o.den : 0); });
    const effData  = labels.map(c=>{ const e=effLoc.get(c)||{num:0,den:0}; return e.den? 100*e.num/e.den : null; });

    createOrUpdateChart('locCombinedChart',{
      data:{
        labels,
        datasets:[
          barDataset('Prom. diario', promData),
          lineEffDataset('% Efectividad', effData)
        ]
      },
      options:{
        responsive:true,
        scales:{
          y:{ position:'left', ticks:{ callback:v=>Number(v).toLocaleString('es-AR',{minimumFractionDigits:2,maximumFractionDigits:2}) } },
          y1:{ position:'right', grid:{ drawOnChartArea:false }, ticks:{ callback:v=>`${v.toFixed(0)}%` }, suggestedMin: 50, suggestedMax: 100 },
          x:{ ticks:{ autoSkip:false } }
        },
        plugins:{ legend:{display:true} }
      }
    });

    // Antigüedad tarjetas
    const list = labels.map(loc=>{
      const v=antig[loc]||{sum:0,n:0}; const avg=v.n? v.sum/v.n : 0;
      return [loc, avg];
    }).sort((a,b)=>b[1]-a[1]);

    const grid = document.getElementById('avg-antiguedad-cards');
    grid.innerHTML = list.map(([loc,avg])=>`
      <div class="kpi-card">
        <div class="flex items-baseline justify-between">
          <div class="text-slate-500 font-medium">${loc}</div>
          <div class="text-3xl font-bold">${fmt.dec(avg)}</div>
        </div>
      </div>
    `).join('');
  }

  /**********************
   * EXPORTS
   **********************/
  function getActiveSectionId(){
    const sec=[...document.querySelectorAll('.page-section')].find(s=>!s.classList.contains('hidden'));
    return sec ? sec.id : 'resumen';
  }
  function download(filename, blob){ saveAs(blob, filename); }
  function toCSV(headers, rows){
    const esc=v=> `"${String(v??'').replace(/"/g,'""')}"`;
    const head = headers.map(esc).join(',');
    const body = rows.map(r=> headers.map(h=>esc(r[h])).join(',')).join('\n');
    return head + '\n' + body;
  }

  async function exportSectionPNGs(){
    const id=getActiveSectionId();
    const canvases=[];
    if(id==='resumen'){
      canvases.push(document.getElementById('demandPieChart'));
      const el=document.getElementById('ninebox-card');
      const canvas = await html2canvas(el,{scale:2});
      canvas.toBlob(b=>download('productividad-calidad.png',b));
    }else if(id==='detalle'){
      canvases.push(document.getElementById('tasksByUserChart'));
    }else if(id==='lideres'){
      canvases.push(document.getElementById('tasksByLeaderChart'));
    }else if(id==='evolucion'){
      canvases.push(document.getElementById('weeklyEvolutionChart'));
    }else if(id==='ubicacion'){
      canvases.push(document.getElementById('locCombinedChart'));
    }
    canvases.forEach((c,i)=>{
      if(!c) return;
      const url=c.toDataURL('image/png');
      fetch(url).then(r=>r.blob()).then(b=>download(`${id}-chart${i+1}.png`, b));
    });
  }

  function buildNineboxData(flows) {
    const map = new Map();
    currentData.forEach(r=>{
      const u=r.usuario;
      const o=map.get(u)||{num:0,den:0,effSum:0,effN:0};
      const t = tareasByFlows(r,flows);
      o.num += t; o.den += (r.dias_activos||0);
      if(r.efectividad!=='' && r.efectividad!=null){ o.effSum+=r.efectividad; o.effN++; }
      map.set(u,o);
    });
    const prodBand = p => (p>=80 ? 'Alta' : p>=70 ? 'Media' : 'Baja');
    const calBand  = e => (e>=0.90 ? 'Alta' : e>=0.75 ? 'Media' : 'Baja');
    const buckets = {
      "Prod Alta / Cal Alta":[], "Prod Alta / Cal Media":[], "Prod Alta / Cal Baja":[],
      "Prod Media / Cal Alta":[], "Prod Media / Cal Media":[], "Prod Media / Cal Baja":[],
      "Prod Baja / Cal Alta":[], "Prod Baja / Cal Media":[], "Prod Baja / Cal Baja":[]
    };
    const missing = [];
    Array.from(map.entries()).forEach(([u,o])=>{
      const prom = o.den? o.num/o.den : null;
      const eff  = o.effN? o.effSum/o.effN : null;
      if(prom==null || eff==null){ missing.push({u, prom, eff}); return; }
      const caja = `Prod ${prodBand(prom)} / Cal ${calBand(eff)}`;
      buckets[caja].push(u);
    });
    return { buckets, missing };
  }
  function buildUsersPromEff(flows){
    const agg = new Map();
    currentData.forEach(r=>{
      const u=r.usuario; const o=agg.get(u)||{num:0,den:0,effNum:0,effDen:0};
      const t = tareasByFlows(r,flows);
      o.num += t; o.den += (r.dias_activos||0);
      if(r.efectividad!=='' && r.efectividad!=null){
        const w=(r.correcciones_auditadas||0)||1;
        o.effNum += r.efectividad*w; o.effDen += w;
      }
      agg.set(u,o);
    });
    return Array.from(agg.entries()).map(([user,o])=>({
      user, prom: (o.den? o.num/o.den : 0), eff: (o.effDen? o.effNum/o.effDen : null)
    })).sort((a,b)=>b.prom-a.prom);
  }
  function buildLideresData(flows){
    const agg = new Map();
    currentData.forEach(r=>{
      const l=r['líder']; if(!l || l.toLowerCase()==='sin líder') return;
      const o=agg.get(l)||{num:0,den:0,effNum:0,effDen:0};
      const t = tareasByFlows(r,flows);
      o.num += t; o.den += (r.dias_activos||0);
      if(r.efectividad!=='' && r.efectividad!=null){
        const w=(r.correcciones_auditadas||0)||1;
        o.effNum += r.efectividad*w; o.effDen += w;
      }
      agg.set(l,o);
    });
    return Array.from(agg.entries()).map(([lider,o])=>({
      lider, prom:(o.den? o.num/o.den : 0), eff:(o.effDen? o.effNum/o.effDen : null)
    })).sort((a,b)=>b.prom-a.prom);
  }
  function buildEvolucionData(flows){
    const agg = new Map();
    currentData.forEach(r=>{
      const w=Number(r.week); if(!Number.isFinite(w)) return;
      const o=agg.get(w)||{num:0,den:0,effNum:0,effDen:0};
      const t = tareasByFlows(r,flows);
      o.num+=t; o.den+=(r.dias_activos||0);
      if(r.efectividad!=='' && r.efectividad!=null){
        const wgt=(r.correcciones_auditadas||0)||1;
        o.effNum+=r.efectividad*wgt; o.effDen+=wgt;
      }
      agg.set(w,o);
    });
    const weeks=Array.from(agg.keys());
    const minW=Math.min(...weeks), maxW=Math.max(...weeks);
    const labels=[], values=[], eff=[];
    for(let w=minW; w<=maxW; w++){
      const o=agg.get(w)||{num:0,den:0,effNum:0,effDen:0};
      labels.push('W'+String(w).padStart(2,'0'));
      values.push(o.den? o.num/o.den : 0);
      eff.push(o.effDen? 100*o.effNum/o.effDen : null);
    }
    return { labels, values, eff };
  }
  function buildUbicacionData(flows){
    const byLoc = new Map();
    const effLoc = new Map();
    const antig = {};
    currentData.forEach(r=>{
      const c=r.ciudad||'Sin ubicación';
      const o=byLoc.get(c)||{num:0,den:0};
      const t=tareasByFlows(r,flows);
      o.num+=t; o.den+=(r.dias_activos||0); byLoc.set(c,o);

      if(r.efectividad!=='' && r.efectividad!=null){
        const w=(r.correcciones_auditadas||0)||1;
        const e=effLoc.get(c)||{num:0,den:0};
        e.num+=r.efectividad*w; e.den+=w; effLoc.set(c,e);
      }

      const a = Number(r.antigüedad||0);
      if(!antig[c]) antig[c]={sum:0,n:0};
      if(Number.isFinite(a)){ antig[c].sum+=a; antig[c].n++; }
    });
    const labels = Array.from(byLoc.keys()).sort();
    const prom = labels.map(c=>{ const o=byLoc.get(c)||{num:0,den:0}; return o.den? o.num/o.den : 0; });
    const eff = labels.map(c=>{ const e=effLoc.get(c)||{num:0,den:0}; return e.den? 100*e.num/e.den : null; });
    const antigList = labels.map(c=>{ const v=antig[c]||{sum:0,n:0}; return [c, v.n? v.sum/v.n : 0]; });
    return { labels, prom, eff, antig: antigList };
  }

  async function exportSectionCSV(){
    const id=getActiveSectionId();
    const flows=selectedFlows();

    if(id==='resumen'){
      const demand = currentData.reduce((s,r)=> s + (r.tareas_demanda||0), 0);
      const enh    = currentData.reduce((s,r)=> s + (r.tareas_enhancement||0), 0);
      const tot = demand+enh;
      const rows1 = [
        { Flujo:'Demanda', Total:demand, Porcentaje: tot? (demand/tot) : 0 },
        { Flujo:'Enhancement', Total:enh, Porcentaje: tot? (enh/tot) : 0 }
      ];
      const csv1 = toCSV(['Flujo','Total','Porcentaje'], rows1);
      download('resumen_demanda_enhancement.csv', new Blob([csv1],{type:'text/csv;charset=utf-8'}));

      const nb = buildNineboxData(flows);
      const headers=['Caja','Usuarios','Conteo'];
      const rows=[];
      Object.entries(nb.buckets).forEach(([k,arr])=>{
        rows.push({Caja:k,Usuarios:arr.join(' | '),Conteo:arr.length});
      });
      const csv2 = toCSV(headers, rows);
      download('resumen_productividad_calidad.csv', new Blob([csv2],{type:'text/csv;charset=utf-8'}));
      if(nb.missing.length){
        const csv3 = toCSV(['Usuario','Promedio_Diario','Efectividad'],
          nb.missing.map(m=>({Usuario:m.u, Promedio_Diario: (m.prom==null?'':m.prom), Efectividad:(m.eff==null?'':m.eff)})));
        download('resumen_productividad_calidad_faltantes.csv', new Blob([csv3],{type:'text/csv;charset=utf-8'}));
      }

    }else if(id==='detalle'){
      const data = buildUsersPromEff(flows);
      const rows = data.map(d=>({Usuario:d.user, Promedio_Diario:d.prom, Efectividad:d.eff}));
      const csv=toCSV(['Usuario','Promedio_Diario','Efectividad'], rows);
      download('detalle_por_usuario.csv', new Blob([csv],{type:'text/csv;charset=utf-8'}));

    }else if(id==='lideres'){
      const data = buildLideresData(flows);
      const rows = data.map(d=>({Lider:d.lider, Promedio_Diario:d.prom, Efectividad:d.eff}));
      const csv = toCSV(['Lider','Promedio_Diario','Efectectividad'], rows);
      download('comparativa_equipo.csv', new Blob([csv],{type:'text/csv;charset=utf-8'}));

    }else if(id==='evolucion'){
      const series = buildEvolucionData(flows);
      const rows = series.labels.map((lab,i)=>({Semana:lab, Promedio_Diario:series.values[i], Efectividad:series.eff[i]}));
      const csv = toCSV(['Semana','Promedio_Diario','Efectividad'], rows);
      download('evolucion_promedio_y_efectividad.csv', new Blob([csv],{type:'text/csv;charset=utf-8'}));

    }else if(id==='ubicacion'){
      const data = buildUbicacionData(flows);
      const rows = data.labels.map((lab,i)=>({Ubicacion:lab, Promedio_Diario:data.prom[i], Efectividad:data.eff[i]}));
      const csv = toCSV(['Ubicacion','Promedio_Diario','Efectividad'], rows);
      download('ubicacion_prom_y_efectividad.csv', new Blob([csv],{type:'text/csv;charset=utf-8'}));

      const rows2 = data.antig.map(([loc,avg])=>({Ubicacion:loc, Antiguedad_Promedio:avg}));
      const csv2=toCSV(['Ubicacion','Antiguedad_Promedio'], rows2);
      download('ubicacion_antiguedad.csv', new Blob([csv2],{type:'text/csv;charset=utf-8'}));
    }
  }

  async function exportSectionZIP(){
    const id=getActiveSectionId();
    const flows=selectedFlows();
    const zip=new JSZip();

    function addCSV(name, headers, rows){
      zip.file(name, toCSV(headers, rows));
    }
    if(id==='resumen'){
      const demand = currentData.reduce((s,r)=> s + (r.tareas_demanda||0), 0);
      const enh    = currentData.reduce((s,r)=> s + (r.tareas_enhancement||0), 0);
      const tot = demand+enh;
      addCSV('resumen_demanda_enhancement.csv',
        ['Flujo','Total','Porcentaje'],
        [{Flujo:'Demanda',Total:demand,Porcentaje:tot?demand/tot:0},{Flujo:'Enhancement',Total:enh,Porcentaje:tot?enh/tot:0}]
      );
      const nb = buildNineboxData(flows);
      const rows=[]; Object.entries(nb.buckets).forEach(([k,arr])=> rows.push({Caja:k,Usuarios:arr.join(' | '),Conteo:arr.length}));
      addCSV('resumen_productividad_calidad.csv', ['Caja','Usuarios','Conteo'], rows);
      if(nb.missing.length){
        addCSV('resumen_productividad_calidad_faltantes.csv', ['Usuario','Promedio_Diario','Efectividad'],
          nb.missing.map(m=>({Usuario:m.u,Promedio_Diario:(m.prom==null?'':m.prom),Efectividad:(m.eff==null?'':m.eff)})));
      }
      const el=document.getElementById('ninebox-card');
      const canvas = await html2canvas(el,{scale:2});
      const blobNb = await new Promise(res=>canvas.toBlob(res));
      zip.file('productividad-calidad.png', blobNb);
      const c1=document.getElementById('demandPieChart');
      const b1=await (await fetch(c1.toDataURL('image/png'))).blob();
      zip.file('demanda_enhancement.png', b1);

    }else if(id==='detalle'){
      const data = buildUsersPromEff(flows);
      addCSV('detalle_por_usuario.csv', ['Usuario','Promedio_Diario','Efectividad'],
             data.map(d=>({Usuario:d.user,Promedio_Diario:d.prom,Efectividad:d.eff})));
      const c1=document.getElementById('tasksByUserChart');
      const b1=await (await fetch(c1.toDataURL('image/png'))).blob();
      zip.file('detalle_prom_efectividad.png', b1);

    }else if(id==='lideres'){
      const data = buildLideresData(flows);
      addCSV('comparativa_equipo.csv', ['Lider','Promedio_Diario','Efectividad'],
             data.map(d=>({Lider:d.lider,Promedio_Diario:d.prom,Efectividad:d.eff})));
      const c=document.getElementById('tasksByLeaderChart');
      const b=await (await fetch(c.toDataURL('image/png'))).blob();
      zip.file('comparativa_equipo.png', b);

    }else if(id==='evolucion'){
      const series=buildEvolucionData(flows);
      addCSV('evolucion_promedio_y_efectividad.csv', ['Semana','Promedio_Diario','Efectividad'],
             series.labels.map((lab,i)=>({Semana:lab,Promedio_Diario:series.values[i],Efectividad:series.eff[i]})));
      const c=document.getElementById('weeklyEvolutionChart');
      const b=await (await fetch(c.toDataURL('image/png'))).blob();
      zip.file('evolucion.png', b);

    }else if(id==='ubicacion'){
      const data=buildUbicacionData(flows);
      addCSV('ubicacion_prom_y_efectividad.csv',['Ubicacion','Promedio_Diario','Efectividad'],
             data.labels.map((lab,i)=>({Ubicacion:lab,Promedio_Diario:data.prom[i],Efectividad:data.eff[i]})));
      addCSV('ubicacion_antiguedad.csv',['Ubicacion','Antiguedad_Promedio'],
             data.antig.map(([loc,avg])=>({Ubicacion:loc,Antiguedad_Promedio:avg})));
      const c=document.getElementById('locCombinedChart');
      const b=await (await fetch(c.toDataURL('image/png'))).blob();
      zip.file('ubicacion.png', b);
    }

    const blob = await zip.generateAsync({type:'blob'});
    download(`export_${id}.zip`, blob);
  }

  /**********************
   * GEMINI (prompts + render enriquecido)
   **********************/
  function filtersSummary() {
    const f = getFilterState();
    return {
      Trimestre: f.q.join(', ') || 'Todos',
      Mes: f.mes.join(', ') || 'Todos',
      Semana: f.semana.join(', ') || 'Todas',
      Ubicacion: f.ubic.join(', ') || 'Todas',
      Lider: f.lider.join(', ') || 'Todos',
      Usuario: f.user.join(', ') || 'Todos',
      Flujo: f.flows.join(' + ')
    };
  }

  function buildNineboxPrompt(){
    const flows=selectedFlows();
    const filtros_activos = JSON.stringify(filtersSummary());
    const total_tareas = currentData.reduce((s,r)=>s+tareasByFlows(r,flows),0);
    const promedio_diario = promedioDiario(currentData,flows).toFixed(2);
    const efVals= currentData.map(r=>r.efectividad).filter(v=>v!==''&&v!=null);
    const efectividad = (efVals.length? (100*efVals.reduce((a,b)=>a+b,0)/efVals.length) : 0).toFixed(2);

    const prodBand=p=>(p>=80?'Alta':p>=70?'Media':'Baja');
    const calBand=e=>(e>=0.90?'Alta':e>=0.75?'Media':'Baja');
    const buckets = { 'Prod Alta / Cal Alta':0,'Prod Alta / Cal Media':0,'Prod Alta / Cal Baja':0,'Prod Media / Cal Alta':0,'Prod Media / Cal Media':0,'Prod Media / Cal Baja':0,'Prod Baja / Cal Alta':0,'Prod Baja / Cal Media':0,'Prod Baja / Cal Baja':0 };
    const map=new Map();
    currentData.forEach(r=>{
      const u=r.usuario; const o=map.get(u)||{num:0,den:0,effSum:0,effN:0};
      o.num += tareasByFlows(r,flows); o.den += (r.dias_activos||0);
      if(r.efectividad!=='' && r.efectividad!=null){ o.effSum+=r.efectividad; o.effN++; }
      map.set(u,o);
    });
    Array.from(map.values()).forEach(o=>{
      const prom = o.den?o.num/o.den:null, eff=o.effN?o.effSum/o.effN:null;
      if(prom==null||eff==null) return;
      buckets[`Prod ${prodBand(prom)} / Cal ${calBand(eff)}`]++;
    });
    const distribucion_ninebox = Object.entries(buckets).map(([k,v])=>`• ${k}: ${v}`).join('\n');

    return `🔹 Prompt 1: *Análisis Nine-box con foco en Productividad x Calidad*

Actuá como analista operativo de Catálogo (Netkel). Tu objetivo es identificar focos de mejora en productividad sin comprometer la calidad.

🎯 Objetivo: Sostener o elevar Promedio Diario (target ≥80) con % Efectividad ≥90%.

📊 Filtros activos: ${filtros_activos}
📈 KPIs:
• Total tareas: ${total_tareas}
• Prom. Diario: ${promedio_diario}
• % Efectividad: ${efectividad}%

📦 Distribución actual de perfiles (Nine-box Prod x Calidad):
${distribucion_ninebox}

🛑 Importante:
• Una alta concentración en “Prod Alta / Cal Alta” es positiva. No lo señales como problema.
• No generes alertas si no hay perfiles en cuadrantes problemáticos.
• Enfocá el análisis SOLO en cuadrantes con baja calidad: “Prod Alta / Cal Baja” y “Prod Baja / Cal Alta”.

🧩 Instrucciones:
1. Listá 4 a 6 hallazgos RELEVANTES y accionables (sin suposiciones sin data).
2. Proponé 3 acciones concretas solo para perfiles fuera de target (según la tabla LOW actual).
   - Usá solo herramientas internas: BTC, feedback 1:1, checklist, acompañamiento individual, plan 3 semanas.
3. En la sección de diferenciación, explicá qué harías si hubiera perfiles en:
   - “Prod Alta / Cal Baja” → foco en aumentar calidad
   - “Prod Baja / Cal Alta” → foco en aumentar productividad

📝 Formato:
• Bullets claros
• Cada acción debe incluir responsable y plazo
• No inventes datos. Sé empático y específico`;
  }

  function buildGlobalInsightsPrompt(){
    const flows=selectedFlows();
    const filtros_activos = JSON.stringify(filtersSummary());
    const usuarios = new Set(currentData.map(r=>r.usuario)).size;
    const ids = currentData.reduce((s,r)=>s+(r.ids_trabajados||0),0);
    const prom = promedioDiario(currentData,flows).toFixed(2);
    const efVals= currentData.map(r=>r.efectividad).filter(v=>v!==''&&v!=null);
    const ef = (efVals.length? (100*efVals.reduce((a,b)=>a+b,0)/efVals.length) : 0).toFixed(2);

    return `🔹 Prompt 2: *Análisis Global para Coordinación*

Sos analista de mejora continua de Catálogo (Netkel). Buscás mantener una operación productiva sin sacrificar calidad (targets: PD ≥80, Efectividad ≥90%).

📊 Filtros aplicados: ${filtros_activos}
📌 Datos clave:
• Usuarios activos: ${usuarios}
• IDs trabajados: ${ids}
• Prom. Diario: ${prom}
• % Efectividad: ${ef}

🛑 Consideraciones:
• Si la mayoría está on target, es positivo. No señales como problema.
• No recomiendes revisar métricas, metodología o distribución si no hay señales claras.
• Enfocá el análisis en:
   - Casos recurrentes de baja calidad
   - Perfiles en plan de trabajo (Low Grave / Low Moderado)
   - Desvíos sostenidos <90%

🧠 Qué necesito:
1. Foto general en 4 bullets: qué va bien / qué podría mejorar (solo si hay data)
2. Identificá perfiles LOW:
   - Ocasionales: bajan 1 semana y recuperan
   - Recurrentes: bajan sostenidamente
3. Proponé 3–5 acciones reales usando solo:
   - BTC con casos
   - Feedback 1:1 por error frecuente
   - Checklist personalizada
   - Plan 3 semanas (según categoría)
   - Acompañamiento individual

📢 Formato:
• Bullets concretos
• Perfiles LOW → acción específica → plazo → responsable
• No inventes ni generalices
• Tono interno, claro y accionable`;
  }

  async function geminiRequest(prompt) {
    if (!GEMINI_PROXY_URL) return "Configura GEMINI_PROXY_URL.";
    const attempts = [{ prompt: String(prompt) }, { contents: [{ parts: [{ text: String(prompt) }]}] }];
    let lastErr;
    for (const body of attempts) {
      try {
        const r = await fetch(GEMINI_PROXY_URL, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(body) });
        const raw = await r.text();
        if (!r.ok) throw new Error(raw || `HTTP ${r.status}`);
        let data; try { data = JSON.parse(raw); } catch { return raw; }
        const out = data?.candidates?.[0]?.content?.parts?.[0]?.text ?? data?.text ?? data?.output ?? data;
        return (typeof out === 'string') ? out : JSON.stringify(out);
      } catch (e) { lastErr = e; }
    }
    throw lastErr || new Error('Gemini request failed');
  }

  function setupGeminiFeatures(){
    document.getElementById('generate-summary-btn').addEventListener('click', async ()=>{
      const block = document.getElementById('ninebox-missing');
      block.classList.remove('hidden');
      block.textContent='Generando…';
      try{
        const resp = await geminiRequest(buildNineboxPrompt());
        block.innerHTML = resp; // HTML enriquecido
      }catch(e){ block.textContent = e.message; }
    });

    document.getElementById('generate-insights-btn').addEventListener('click', async ()=>{
      const out = document.getElementById('insights-output');
      out.classList.remove('hidden');
      out.textContent = 'Analizando…';
      try{
        const resp = await geminiRequest(buildGlobalInsightsPrompt());
        out.innerHTML = resp; // HTML enriquecido
      }catch(e){ out.textContent = e.message; }
    });
  }

  /**********************
   * INIT
   **********************/
  function setupFilters(){
    setupAccordions();

    // opciones iniciales desde los datos
    const meses   = MONTHS_ES.filter(m => originalData.some(r=>r.mes===m));
    const semanas = uniqueSortedNum(originalData.map(r=>r.week)).map(String);
    const ubic    = uniqueSorted(originalData.map(r=>r.ciudad).filter(Boolean));
    const usuarios= uniqueSorted(originalData.map(r=>r.usuario));
    const lideres = uniqueSorted(originalData.map(r=>r['líder']).filter(l => l && l.toLowerCase()!=='sin líder'));
    const qs      = ['Q1','Q2','Q3','Q4'].filter(q => originalData.some(r=>r.q===q));

    updateFilterOptions('filter-mes', meses);
    updateFilterOptions('filter-semana', semanas);
    updateFilterOptions('filter-ubicacion', ubic);
    updateFilterOptions('filter-usuario', usuarios);
    updateFilterOptions('filter-lider', lideres);
    updateFilterOptions('filter-q', qs);
    updateFilterOptions('filter-flujo', ['mixto','demanda','enhancement']);
  }

  document.addEventListener('DOMContentLoaded', async ()=>{
    try{
      const [tProd,tCal,tBase,tLid] = await Promise.all([
        fetchCSVFile(FILES.productividad),
        fetchCSVFile(FILES.calidad),
        fetchCSVFile(FILES.base),
        fetchCSVFile(FILES.lideres)
      ]);
      const prod = parseCSV(tProd);
      const cal  = parseCSV(tCal);
      const base = parseCSV(tBase);
      const lids = parseCSV(tLid);

      originalData = buildWeeklyRows(prod, cal, base, lids);

      setupFilters();
      setupNavigation();
      setupGeminiFeatures();

      currentData = originalData.slice();
      applyFilters();
    }catch(err){
      console.error(err);
      document.body.innerHTML = `<div class="p-8 text-center text-red-600 bg-red-100">${err.message}</div>`;
    }
  });
  </script>
</body>
</html>
