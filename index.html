<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard de Productividad con IA</title>

  <!-- UI & Charts -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .sidebar-link { transition: all 0.2s ease-in-out; }
    .sidebar-link:hover, .sidebar-link.active { background-color: #0369a1; color: #fff; transform: translateX(4px); }
    .kpi-card { background-color: #fff; border-radius: 0.75rem; padding: 1.5rem;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
    .chart-container { height: 400px; }
    #debug-panel code { background: #0b1020; color: #a7f3d0; padding: 0.25rem 0.5rem; border-radius: 6px; display: inline-block; }
    table.preview { border-collapse: collapse; font-size: 12px; }
    table.preview th, table.preview td { border: 1px solid #e5e7eb; padding: 4px 6px; white-space: nowrap; }
  </style>
</head>

<body class="bg-slate-100 text-slate-800">
  <div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside id="sidebar" class="hidden md:flex w-64 flex-col bg-sky-800 text-sky-100 p-4">
      <div class="flex items-center mb-8">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3 text-white" viewBox="0 0 20 20" fill="currentColor">
          <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>
        </svg>
        <h1 class="text-2xl font-bold text-white">Dashboard</h1>
      </div>
      <nav id="nav-menu" class="flex-1 space-y-2">
        <a href="#resumen" class="sidebar-link active flex items-center p-3 rounded-lg">Resumen General</a>
        <a href="#productividad" class="sidebar-link flex items-center p-3 rounded-lg">Productividad por Usuario</a>
        <a href="#lideres" class="sidebar-link flex items-center p-3 rounded-lg">Comparativa de L√≠deres</a>
        <a href="#evolucion" class="sidebar-link flex items-center p-3 rounded-lg">Evoluci√≥n Semanal</a>
        <a href="#ubicacion" class="sidebar-link flex items-center p-3 rounded-lg">An√°lisis por Ubicaci√≥n</a>
        <a href="#proyecciones" class="sidebar-link flex items-center p-3 rounded-lg">Proyecciones</a>
        <a href="#analisis" class="sidebar-link flex items-center p-3 rounded-lg">An√°lisis Inteligente</a>
      </nav>
    </aside>

    <!-- Main -->
    <main class="flex-1 overflow-x-hidden overflow-y-auto bg-slate-100">
      <div class="container mx-auto px-6 py-8">
        <div class="flex justify-between items-center mb-6">
          <h2 id="page-title" class="text-3xl font-bold text-slate-700">Resumen General</h2>
        </div>

        <!-- Avisos -->
        <div id="mapping-warning" class="hidden mb-4 p-4 rounded-lg border border-amber-300 bg-amber-50 text-amber-800"></div>
        <div id="fatal-error" class="hidden mb-4 p-4 rounded-lg border border-red-300 bg-red-50 text-red-800"></div>

        <!-- Debug visible -->
        <details id="debug-panel" class="mb-6">
          <summary class="cursor-pointer text-slate-600">üß™ Debug de datos (encabezados, filas y mapeo)</summary>
          <div class="mt-3 space-y-3 text-sm">
            <div>Filas le√≠das: <span id="dbg-rows" class="font-semibold">0</span></div>
            <div>Separador detectado: <code id="dbg-delim">?</code></div>
            <div>Encabezados detectados:</div>
            <div id="dbg-headers" class="p-2 bg-white rounded border text-xs"></div>
            <div>Mapeo de columnas (clave ‚Üí encabezado):</div>
            <pre id="dbg-map" class="p-3 bg-white rounded border overflow-auto text-xs"></pre>
            <div>Preview (primeras 10 filas):</div>
            <div id="dbg-preview" class="p-2 bg-white rounded border overflow-auto"></div>
          </div>
        </details>

        <!-- Filtros (ahora con 5 columnas, incluye Usuario) -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
          <select id="filter-mes" class="w-full p-2 border rounded-md bg-white shadow-sm"></select>
          <select id="filter-semana" class="w-full p-2 border rounded-md bg-white shadow-sm"></select>
          <select id="filter-lider" class="w-full p-2 border rounded-md bg-white shadow-sm"></select>
          <select id="filter-ubicacion" class="w-full p-2 border rounded-md bg-white shadow-sm"></select>
          <select id="filter-usuario" class="w-full p-2 border rounded-md bg-white shadow-sm"></select>
        </div>

        <!-- Resumen -->
        <section id="resumen" class="page-section">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <div class="kpi-card text-center">
              <h3 class="text-slate-500 font-medium">Total Tareas</h3>
              <p id="kpi-total-tareas" class="text-4xl font-bold mt-2">‚Äî</p>
            </div>
            <div class="kpi-card text-center">
              <h3 class="text-slate-500 font-medium">% Efectividad Prom.</h3>
              <p id="kpi-efectividad-prom" class="text-4xl font-bold mt-2 text-green-600">‚Äî</p>
            </div>
            <div class="kpi-card text-center">
              <h3 class="text-slate-500 font-medium">Correcciones Totales</h3>
              <p id="kpi-correcciones" class="text-4xl font-bold mt-2 text-amber-600">‚Äî</p>
            </div>
            <div class="kpi-card text-center">
              <h3 class="text-slate-500 font-medium">Usuarios Activos</h3>
              <p id="kpi-usuarios" class="text-4xl font-bold mt-2">‚Äî</p>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="kpi-card">
              <h3 class="text-xl font-semibold mb-4">Top 10 Usuarios por Tareas</h3>
              <div class="chart-container"><canvas id="tasksByUserChart"></canvas></div>
            </div>
            <div class="kpi-card">
              <h3 class="text-xl font-semibold mb-4">Tareas: Demanda vs. Enhancement</h3>
              <div class="chart-container relative mx-auto" style="height:300px;width:100%;max-width:360px">
                <canvas id="demandPieChart"></canvas>
              </div>
            </div>
          </div>
        </section>

        <!-- Productividad por Usuario -->
        <section id="productividad" class="page-section hidden">
          <div class="kpi-card"><h3 class="text-xl font-semibold mb-4">Detalle por Usuario (semanal)</h3>
            <div class="chart-container"><canvas id="userDetailChart"></canvas></div>
            <p id="user-detail-hint" class="text-slate-500 mt-3">Eleg√≠ un <strong>Usuario</strong> en el filtro superior para ver su evoluci√≥n semanal.</p>
          </div>
        </section>

        <!-- Comparativa de L√≠deres -->
        <section id="lideres" class="page-section hidden">
          <div class="kpi-card"><h3 class="text-xl font-semibold mb-4">Comparativa por L√≠der</h3>
            <div class="chart-container"><canvas id="tasksByLeaderChart"></canvas></div>
          </div>
        </section>

        <!-- Evoluci√≥n Semanal -->
        <section id="evolucion" class="page-section hidden">
          <div class="kpi-card"><h3 class="text-xl font-semibold mb-4">Evoluci√≥n Semanal de Tareas</h3>
            <div class="chart-container"><canvas id="weeklyEvolutionChart"></canvas></div>
          </div>
        </section>

        <!-- An√°lisis por Ubicaci√≥n -->
        <section id="ubicacion" class="page-section hidden">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="kpi-card"><h3 class="text-xl font-semibold mb-4">Total por Ubicaci√≥n</h3>
              <div class="chart-container"><canvas id="tasksByLocationChart"></canvas></div>
            </div>
            <div class="kpi-card"><h3 class="text-xl font-semibold mb-4">Antig√ºedad Promedio (meses)</h3>
              <div id="avg-antiguedad-list" class="grid grid-cols-1 sm:grid-cols-2 gap-2"></div>
            </div>
          </div>
        </section>

        <!-- Proyecciones (placeholder) -->
        <section id="proyecciones" class="page-section hidden">
          <div class="kpi-card"><h3 class="text-xl font-semibold mb-4">Proyecci√≥n (pr√≥ximos pasos)</h3>
            <p class="text-slate-600">Podemos aplicar regresi√≥n lineal sobre los datos semanales filtrados. Lo activo si te sirve.</p>
          </div>
        </section>

        <!-- An√°lisis Inteligente -->
        <section id="analisis" class="page-section hidden">
          <div class="kpi-card">
            <h3 class="text-xl font-semibold mb-2">An√°lisis Inteligente (Gemini)</h3>
            <p class="text-slate-600 mb-4">Genera insights con IA a partir de los datos filtrados actuales.</p>
            <div class="flex gap-3 items-center mb-3">
              <button id="generate-insights-btn" class="bg-sky-600 text-white px-5 py-2 rounded-lg hover:bg-sky-700">
                ‚ú® Generar insights
              </button>
              <span id="insights-status" class="text-slate-500"></span>
            </div>
            <div id="insights-output" class="p-4 bg-slate-50 rounded-md border border-slate-200 hidden"></div>
            <p class="mt-3 text-xs text-slate-500">
              Nota: por seguridad, el front llama a un <em>proxy</em> (serverless) que usa tu clave de Gemini. Nunca publiques la API key en el cliente.
            </p>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- App -->
  <script>
    /********** CONFIG GEMINI (proxy) **********/
    // Cambi√° esta URL por la de tu funci√≥n/proxy (Cloud Functions, Cloud Run, Vercel/Netlify Functions, etc.)
    const GEMINI_PROXY_URL = "https://TU-ENDPOINT-DE-PROXY/gemini"; // <- reemplazar

    /********** ESTADO **********/
    let originalData = [];
    let charts = {};
    let COL = {};
    let DETECTED_DELIM = ',';

    /********** NORMALIZACI√ìN **********/
    const removeAccents = s => String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    const normKey = s => removeAccents(String(s||'').toLowerCase().trim().replace(/\s+/g,' ').replace(/[^\w %/()-]/g,''));

    function normalizeValue(v) {
      if (v === null || v === undefined) return v;
      if (typeof v !== 'string') return v;
      const t = v.trim();
      const isPercent = t.endsWith('%');
      const cleaned = t.replace('%','').replace(/\./g,'').replace(',','.');
      const n = Number(cleaned);
      if (Number.isFinite(n)) return isPercent ? n/100 : n;
      return t;
    }

    /********** CSV **********/
    function parseCSV(text) {
      if (!text) return [];
      if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
      const semi = (text.match(/;/g)||[]).length;
      const coma = (text.match(/,/g)||[]).length;
      DETECTED_DELIM = semi > coma ? ';' : ',';

      const parsed = Papa.parse(text, { header: true, skipEmptyLines: true, delimiter: DETECTED_DELIM });
      return parsed.data.map(row => {
        const out = {};
        for (const [k, v] of Object.entries(row)) out[String(k).trim()] = normalizeValue(v);
        return out;
      });
    }

    function buildColumnMap(rows) {
      const headers = Object.keys(rows[0] || {});
      const idx = {}; headers.forEach(h => idx[normKey(h)] = h);

      const want = {
        mes: ['mes'],
        semana: ['semana'],
        usuario: ['usuario','agente','user'],
        efectividad: ['% de efectividad','efectividad','porcentaje efectividad','efectividad %'],
        prom_diario: ['promedio diario','promedio','promedio_diario'],
        tareas_demanda: ['tareas demanda','demanda','cantidad demanda'],
        tareas_enh: ['tareas enhancement','enhancement','cantidad enhancement','mejoras','enhanced'],
        pct_demanda: ['% demanda','porcentaje demanda'],
        pct_enh: ['% enhancement','porcentaje enhancement','% mejoras'],
        total_tareas: ['total tareas','tareas totales','total'],
        ids_trab: ['ids trabajados','ids','ids_trabajados'],
        correcciones: ['correcciones auditadas','correcciones','auditorias','auditadas'],
        lider: ['l√≠der','lider','team leader','tl','leader'],
        antiguedad: ['antig√ºedad (meses)','antiguedad','antiguedad meses'],
        ubicacion: ['ubicaci√≥n','ubicacion','site','sede','location']
      };

      const findCol = candidates => {
        for (const c of candidates) {
          const nk = normKey(c);
          if (idx[nk]) return idx[nk];
          const hit = headers.find(h => normKey(h).includes(nk));
          if (hit) return hit;
        }
        return null;
      };

      const map = {};
      for (const key of Object.keys(want)) map[key] = findCol(want[key]);

      // Fallback: si no hay total_tareas, elegimos la columna num√©rica con mayor suma
      if (!map.total_tareas) {
        const numericCols = headers.filter(h => {
          const nk = normKey(h);
          const looksPercent = nk.includes('%') || nk.includes('porcentaje');
          return !looksPercent;
        });
        let best = null, bestSum = -Infinity;
        numericCols.forEach(h => {
          const s = rows.reduce((acc,r)=> acc + (Number(r[h])||0), 0);
          if (s > bestSum) { bestSum = s; best = h; }
        });
        if (best) map.total_tareas = best;
      }

      return { map, headers };
    }

    /********** HELPERS **********/
    const uniq = arr => Array.from(new Set(arr.filter(x => x !== '' && x != null)));
    const sum = arr => arr.reduce((a,b) => a + (Number(b)||0), 0);
    const avg = arr => arr.length ? sum(arr)/arr.length : 0;
    const q = id => document.getElementById(id);
    const getValue = (row, colName) => colName ? row[colName] : undefined;

    const MONTHS = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
    const monthIndex = m => {
      const i = MONTHS.indexOf(String(m||'').toLowerCase());
      return i === -1 ? 99 : i;
    };

    /********** FILTROS **********/
    function setupFilters(data, col) {
      const meses = uniq(data.map(r => getValue(r, col.mes))).sort((a,b)=> monthIndex(a) - monthIndex(b));
      const semanas = uniq(data.map(r => getValue(r, col.semana))).sort((a,b)=> (a||0)-(b||0));
      const lideres = uniq(data.map(r => getValue(r, col.lider)))
        .filter(v => v && !/sin\s*l[i√≠]der/i.test(String(v))) // fuera "Sin l√≠der"
        .sort((a,b)=> String(a).localeCompare(String(b), 'es'));
      const ubic = uniq(data.map(r => getValue(r, col.ubicacion))).sort((a,b)=> String(a).localeCompare(String(b),'es'));
      const usuarios = uniq(data.map(r => getValue(r, col.usuario))).sort((a,b)=> String(a).localeCompare(String(b),'es'));

      const fill = (sel, values, label) => {
        sel.innerHTML = '';
        const optAll = document.createElement('option');
        optAll.value = ''; optAll.textContent = `Todos ${label||''}`.trim();
        sel.appendChild(optAll);
        values.forEach(v => {
          const o = document.createElement('option');
          o.value = v; o.textContent = v;
          sel.appendChild(o);
        });
      };

      fill(q('filter-mes'), meses, 'los meses');
      fill(q('filter-semana'), semanas, 'las semanas');
      fill(q('filter-lider'), lideres, 'los l√≠deres');
      fill(q('filter-ubicacion'), ubic, 'las ubicaciones');
      fill(q('filter-usuario'), usuarios, 'los usuarios');

      ['filter-mes','filter-semana','filter-lider','filter-ubicacion','filter-usuario'].forEach(id => {
        q(id).addEventListener('change', applyFilters);
      });
    }

    function getActiveFilters() {
      const v = id => q(id) ? q(id).value : '';
      return {
        mes: v('filter-mes') || null,
        semana: v('filter-semana') || null,
        lider: v('filter-lider') || null,
        ubicacion: v('filter-ubicacion') || null,
        usuario: v('filter-usuario') || null,
      };
    }

    /********** CHARTS **********/
    function createOrUpdateChart(id, type, data, options) {
      const ctx = q(id);
      if (!ctx) return;
      if (charts[id]) charts[id].destroy();
      charts[id] = new Chart(ctx, { type, data, options });
    }

    /********** RENDER POR SECCI√ìN **********/
    function renderResumen(rows) {
      const totalTareas = COL.total_tareas
        ? sum(rows.map(r => getValue(r, COL.total_tareas)))
        : sum(rows.map(r => (getValue(r, COL.tareas_demanda)||0) + (getValue(r, COL.tareas_enh)||0)));

      const efectProm = COL.efectividad ? (avg(rows.map(r => getValue(r, COL.efectividad))) * 100) : null;
      const correcciones = COL.correcciones ? sum(rows.map(r => getValue(r, COL.correcciones))) : 0;
      const usuariosActivos = COL.usuario ? uniq(rows.map(r => getValue(r, COL.usuario))).length : 0;

      q('kpi-total-tareas').textContent = Number(totalTareas||0).toLocaleString('es-AR');
      q('kpi-efectividad-prom').textContent = (efectProm != null && isFinite(efectProm)) ? (efectProm.toFixed(2) + '%') : '‚Äî';
      q('kpi-correcciones').textContent = Number(correcciones||0).toLocaleString('es-AR');
      q('kpi-usuarios').textContent = Number(usuariosActivos||0).toLocaleString('es-AR');

      // Pie Demanda vs Enhancement
      const totDem = sum(rows.map(r => getValue(r, COL.tareas_demanda)));
      const totEnh = sum(rows.map(r => getValue(r, COL.tareas_enh)));
      createOrUpdateChart('demandPieChart', 'pie', {
        labels: ['Demanda', 'Enhancement'],
        datasets: [{ data: [totDem, totEnh] }]
      }, { responsive: true });

      // Barras por usuario (Top 10)
      const byUser = {};
      rows.forEach(r => {
        const u = getValue(r, COL.usuario) || '‚Äî';
        const t = COL.total_tareas
          ? (getValue(r, COL.total_tareas) || 0)
          : (getValue(r, COL.tareas_demanda)||0) + (getValue(r, COL.tareas_enh)||0);
        byUser[u] = (byUser[u] || 0) + (Number(t)||0);
      });
      const ranked = Object.entries(byUser).sort((a,b)=>b[1]-a[1]).slice(0,10);
      createOrUpdateChart('tasksByUserChart', 'bar', {
        labels: ranked.map(x => x[0]),
        datasets: [{ label: 'Tareas', data: ranked.map(x => x[1]) }]
      }, { responsive: true, plugins: { legend: { display:false } }, scales: { y: { beginAtZero: true } } });
    }

    function renderProductividad(rows, filters) {
      const hint = q('user-detail-hint');
      if (!filters.usuario) {
        hint.classList.remove('hidden');
        createOrUpdateChart('userDetailChart', 'line', { labels: [], datasets: [] }, { });
        return;
      }
      hint.classList.add('hidden');

      // Agrupo por semana para el usuario
      const userRows = rows.filter(r => getValue(r, COL.usuario) == filters.usuario);
      const map = {};
      userRows.forEach(r => {
        const w = getValue(r, COL.semana);
        const t = COL.total_tareas
          ? (getValue(r, COL.total_tareas) || 0)
          : (getValue(r, COL.tareas_demanda)||0) + (getValue(r, COL.tareas_enh)||0);
        map[w] = (map[w] || 0) + (Number(t)||0);
      });
      const weeks = Object.keys(map).sort((a,b)=>(a||0)-(b||0));
      const values = weeks.map(w => map[w]);

      createOrUpdateChart('userDetailChart', 'line', {
        labels: weeks,
        datasets: [{ label: `Tareas de ${filters.usuario}`, data: values, fill:false, tension:0.2 }]
      }, { responsive:true, plugins:{ legend:{ display:true } }, scales:{ y:{ beginAtZero:true } } });
    }

    function renderLideres(rows) {
      const byLead = {};
      rows.forEach(r => {
        const lead = getValue(r, COL.lider);
        if (!lead || /sin\s*l[i√≠]der/i.test(String(lead))) return;
        const t = COL.total_tareas
          ? (getValue(r, COL.total_tareas) || 0)
          : (getValue(r, COL.tareas_demanda)||0) + (getValue(r, COL.tareas_enh)||0);
        byLead[lead] = (byLead[lead] || 0) + (Number(t)||0);
      });
      const ranked = Object.entries(byLead).sort((a,b)=>b[1]-a[1]);
      createOrUpdateChart('tasksByLeaderChart', 'bar', {
        labels: ranked.map(x => x[0]),
        datasets: [{ label: 'Tareas', data: ranked.map(x => x[1]) }]
      }, { responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } });
    }

    function renderEvolucion(rows) {
      const byWeek = {};
      rows.forEach(r => {
        const w = getValue(r, COL.semana);
        const t = COL.total_tareas
          ? (getValue(r, COL.total_tareas) || 0)
          : (getValue(r, COL.tareas_demanda)||0) + (getValue(r, COL.tareas_enh)||0);
        byWeek[w] = (byWeek[w] || 0) + (Number(t)||0);
      });
      const weeks = Object.keys(byWeek).sort((a,b)=>(a||0)-(b||0));
      const vals = weeks.map(w => byWeek[w]);

      createOrUpdateChart('weeklyEvolutionChart', 'line', {
        labels: weeks,
        datasets: [{ label: 'Tareas totales', data: vals, fill:false, tension:0.2 }]
      }, { responsive:true, plugins:{ legend:{ display:true } }, scales:{ y:{ beginAtZero:true } } });
    }

    function renderUbicacion(rows) {
      const byLoc = {};
      const age = {};
      rows.forEach(r => {
        const loc = getValue(r, COL.ubicacion) || '‚Äî';
        const t = COL.total_tareas
          ? (getValue(r, COL.total_tareas) || 0)
          : (getValue(r, COL.tareas_demanda)||0) + (getValue(r, COL.tareas_enh)||0);
        byLoc[loc] = (byLoc[loc] || 0) + (Number(t)||0);

        const a = Number(getValue(r, COL.antiguedad));
        if (Number.isFinite(a)) {
          if (!age[loc]) age[loc] = [];
          age[loc].push(a);
        }
      });
      const labels = Object.keys(byLoc).sort((a,b)=> String(a).localeCompare(String(b),'es'));
      const values = labels.map(l => byLoc[l]);

      createOrUpdateChart('tasksByLocationChart', 'bar', {
        labels, datasets: [{ label: 'Tareas', data: values }]
      }, { responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } });

      const cont = q('avg-antiguedad-list');
      cont.innerHTML = '';
      Object.keys(age).sort((a,b)=> String(a).localeCompare(String(b),'es')).forEach(loc => {
        const v = avg(age[loc]);
        const item = document.createElement('div');
        item.className = 'p-2 border rounded bg-white';
        item.textContent = `${loc}: ${v.toFixed(1)} meses`;
        cont.appendChild(item);
      });
    }

    /********** APLICAR FILTROS (actualiza TODO) **********/
    function applyFilters() {
      if (!originalData.length) return;

      const f = getActiveFilters();
      const rows = originalData.filter(r => {
        const okMes = !f.mes || getValue(r, COL.mes) == f.mes;
        const okSem = !f.semana || getValue(r, COL.semana) == f.semana;
        const okLid = !f.lider || getValue(r, COL.lider) == f.lider;
        const okUbi = !f.ubicacion || getValue(r, COL.ubicacion) == f.ubicacion;
        const okUsr = !f.usuario || getValue(r, COL.usuario) == f.usuario;
        return okMes && okSem && okLid && okUbi && okUsr;
      });

      // Render de todas las secciones con el subset filtrado
      renderResumen(rows);
      renderProductividad(rows, f);
      renderLideres(rows);
      renderEvolucion(rows);
      renderUbicacion(rows);

      // Aviso de mapeo faltante
      const missing = [];
      if (!COL.usuario) missing.push('Usuario');
      if (!COL.total_tareas && !COL.tareas_demanda && !COL.tareas_enh) missing.push('Total Tareas o Demanda/Enhancement');
      const warn = q('mapping-warning');
      if (missing.length) {
        warn.classList.remove('hidden');
        warn.innerHTML = `<strong>Atenci√≥n:</strong> columnas no detectadas: ${missing.join(', ')}. Revis√° encabezados del CSV.`;
      } else {
        warn.classList.add('hidden'); warn.textContent = '';
      }
    }

    /********** NAVEGACI√ìN **********/
    function setupNavigation() {
      const links = document.querySelectorAll('#nav-menu a');
      const sections = document.querySelectorAll('.page-section');
      links.forEach(link => {
        link.addEventListener('click', e => {
          e.preventDefault();
          links.forEach(l => l.classList.remove('active'));
          link.classList.add('active');
          sections.forEach(s => s.classList.add('hidden'));
          const target = document.querySelector(link.getAttribute('href'));
          if (target) target.classList.remove('hidden');
          q('page-title').textContent = link.textContent.trim();
          // Redibujo por si cambian tama√±os al mostrar/ocultar
          applyFilters();
        });
      });
    }

    /********** INSIGHTS (Gemini v√≠a proxy) **********/
    async function generateInsights(currentRows) {
      const status = q('insights-status');
      const out = q('insights-output');
      out.classList.add('hidden');
      status.textContent = 'Generando...';

      // Compacto la data: resumen + primeras 100 filas para contexto
      const summary = {
        filas: currentRows.length,
        total_tareas: currentRows.reduce((a,r)=>a + ((COL.total_tareas?Number(r[COL.total_tareas]):(Number(r[COL.tareas_demanda])||0)+(Number(r[COL.tareas_enh])||0))||0), 0),
        efectividad_prom: COL.efectividad ? avg(currentRows.map(r => Number(r[COL.efectividad]||0))) : null,
        por_lider: Object.entries(currentRows.reduce((acc,r)=>{
          const k = r[COL.lider] || '‚Äî';
          const t = COL.total_tareas ? Number(r[COL.total_tareas]||0) : (Number(r[COL.tareas_demanda])||0)+(Number(r[COL.tareas_enh])||0);
          acc[k]=(acc[k]||0)+t; return acc;
        }, {})).sort((a,b)=>b[1]-a[1]).slice(0,10),
      };
      const sample = currentRows.slice(0, 100);

      try {
        const resp = await fetch(GEMINI_PROXY_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt: `Sos un analista de operaciones. Dame 6 insights accionables, 3 riesgos y 3 recomendaciones priorizadas (con bullets breves) a partir de este dataset filtrado. Responde en espa√±ol, claro y directo.`,
            data: { summary, sample }
          })
        });
        if (!resp.ok) throw new Error('Error del proxy de Gemini');
        const json = await resp.json();
        out.innerHTML = `<div class="prose whitespace-pre-wrap">${json.text || json.output || JSON.stringify(json)}</div>`;
        out.classList.remove('hidden');
        status.textContent = '';
      } catch (e) {
        status.textContent = '';
        out.classList.remove('hidden');
        out.innerHTML = `<div class="text-red-700">No pude obtener insights. Revis√° el GEMINI_PROXY_URL o los logs del proxy.</div>`;
      }
    }

    /********** CARGA CSV **********/
    async function fetchCSV() {
      const rel = './datos.csv?v=' + Date.now();
      const base = '/metricas/datos.csv?v=' + Date.now();
      const raw  = 'https://raw.githubusercontent.com/catalogo-meli/metricas/main/datos.csv?v=' + Date.now();
      let resp = await fetch(rel, { cache: 'no-store' });
      if (!resp.ok) resp = await fetch(base, { cache: 'no-store' });
      if (!resp.ok) resp = await fetch(raw, { cache: 'no-store' });
      if (!resp.ok) throw new Error('No pude cargar datos.csv. HTTP ' + resp.status);
      return resp.text();
    }

    /********** INIT **********/
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        setupNavigation();

        const csvText = await fetchCSV();
        originalData = parseCSV(csvText);

        if (!originalData.length) {
          q('fatal-error').classList.remove('hidden');
          q('fatal-error').textContent = 'El CSV est√° vac√≠o o no se pudo parsear. Verific√° separador y encabezados.';
          return;
        }

        const headers = Object.keys(originalData[0]);
        const { map } = buildColumnMap(originalData);
        COL = map;

        // Debug visible
        q('dbg-rows').textContent = String(originalData.length);
        q('dbg-delim').textContent = DETECTED_DELIM;
        q('dbg-headers').textContent = headers.join(' | ');
        q('dbg-map').textContent = JSON.stringify(COL, null, 2);
        // Preview
        (function renderPreview(){
          const cont = q('dbg-preview'); cont.innerHTML = '';
          const table = document.createElement('table'); table.className = 'preview';
          const thead = document.createElement('thead'); const trh = document.createElement('tr');
          headers.forEach(h => { const th = document.createElement('th'); th.textContent = h; trh.appendChild(th); });
          thead.appendChild(trh); table.appendChild(thead);
          const tbody = document.createElement('tbody');
          originalData.slice(0,10).forEach(r => {
            const tr = document.createElement('tr');
            headers.forEach(h => { const td = document.createElement('td'); td.textContent = r[h]; tr.appendChild(td); });
            tbody.appendChild(tr);
          });
          table.appendChild(tbody); cont.appendChild(table);
        })();

        setupFilters(originalData, COL);
        applyFilters();

        q('generate-insights-btn').addEventListener('click', () => {
          const f = getActiveFilters();
          const rows = originalData.filter(r => {
            const okMes = !f.mes || getValue(r, COL.mes) == f.mes;
            const okSem = !f.semana || getValue(r, COL.semana) == f.semana;
            const okLid = !f.lider || getValue(r, COL.lider) == f.lider;
            const okUbi = !f.ubicacion || getValue(r, COL.ubicacion) == f.ubicacion;
            const okUsr = !f.usuario || getValue(r, COL.usuario) == f.usuario;
            return okMes && okSem && okLid && okUbi && okUsr;
          });
          generateInsights(rows);
        });

      } catch (err) {
        console.error(err);
        q('fatal-error').classList.remove('hidden');
        q('fatal-error').textContent = err.message;
      }
    });
  </script>
</body>
</html>
