<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Catálogo · Dashboard de Métricas</title>

<!-- Favicon -->
<link rel="icon" type="image/png" href="logo-meli.png?v=1" sizes="32x32">
<link rel="apple-touch-icon" href="logo-meli.png?v=1" sizes="180x180">

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Chart.js + adapter fechas -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<!-- PapaParse -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<!-- Export helpers -->
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<!-- Montserrat -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#f1f5f9; --panel:#fff; --panel-2:#f8fafc; --text:#0f172a; --muted:#64748b; --border:#e2e8f0; --shadow:0 8px 24px rgba(15,23,42,.08);
    --sidebar:#6b7280; --accent:#0ea5e9; --success:#16a34a; --warn:#f59e0b;
    --pie1:#86eae9; --pie2:#2c92d5; --pie3:#8b5cf6; --pie4:#f59e0b; --pie5:#fb923c; --pie6:#10b981; --pie7:#f87171;
    --nine-green:#dcfce7; --nine-yellow:#fef9c3; --nine-orange:#ffedd5; --nine-red:#fee2e2;
  }
  [data-theme="dark"]{
    --bg:#0b1220; --panel:#0f1b2d; --panel-2:#0c1626; --text:#e2e8f0; --muted:#a3b2c7; --border:#1e293b; --shadow:0 10px 28px rgba(0,0,0,.45);
    --sidebar:#3b4756; --accent:#22c3ee;
    --pie1:#6ee7e7; --pie2:#1d8bd9; --pie3:#8b5cf6; --pie4:#f59e0b; --pie5:#fb923c; --pie6:#10b981; --pie7:#f87171;
    --nine-green:#0f3c36; --nine-yellow:#3b3416; --nine-orange:#422006; --nine-red:#3f1d1d;
  }
  html,body{height:100%}
  body{font-family:'Montserrat',sans-serif;background:var(--bg);color:var(--text)}
  .kpi-card{background:var(--panel);border:1px solid var(--border);border-radius:1rem;box-shadow:var(--shadow);padding:1.2rem}
  .kpi-title{color:var(--muted);font-weight:600}
  .kpi-value{font-weight:800;letter-spacing:.3px;text-align:center;font-size:clamp(1.4rem,3.2vw,2.5rem);line-height:1.1;white-space:nowrap}
  .sidebar{background:var(--sidebar)}
  .sidebar-link{transition:all .2s ease-in-out;border-radius:.75rem}
  .sidebar-link:hover,.sidebar-link.active{background:rgba(255,255,255,.15);color:#fff;transform:translateX(4px)}
  .pill{display:flex;align-items:center;gap:.5rem;background:var(--panel);border:1px solid var(--border);border-radius:.9rem;padding:.45rem .7rem;box-shadow:var(--shadow)}
  .pill .prefix{color:var(--muted);font-size:.82rem}
  .pill .value{font-weight:600;color:var(--text);font-size:.9rem;max-width:14rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .pill .chev{color:var(--muted)}
  .menu{position:absolute;z-index:50;top:110%;left:0;min-width:260px;background:var(--panel);border:1px solid var(--border);border-radius:.9rem;box-shadow:0 18px 30px -12px rgba(0,0,0,.35);display:none}
  .menu.open{display:block}
  .menu .head{display:flex;align-items:center;justify-content:space-between;padding:.6rem .75rem;border-bottom:1px solid var(--border)}
  .menu .search{width:100%;padding:.5rem .75rem;border:1px solid var(--border);border-radius:.5rem;background:var(--panel-2);font-size:.9rem;color:var(--text)}
  .menu .clear{font-size:.85rem;color:var(--accent)}
  .menu .list{max-height:260px;overflow:auto;padding:.5rem}
  .menu .item{display:flex;align-items:center;gap:.6rem;padding:.42rem .35rem;border-radius:.5rem;cursor:pointer;color:var(--text)}
  .menu .item:hover{background:var(--panel-2)}
  .menu .foot{padding:.6rem .75rem;border-top:1px solid var(--border);font-size:.83rem;color:var(--muted)}
  .dropdown{position:relative;display:inline-block;}
  .dropdown-menu{position:absolute;right:0;top:100%;background:var(--panel);border:1px solid var(--border);border-radius:.75rem;box-shadow:var(--shadow);min-width:260px;z-index:50}
  .dropdown-menu a{display:block;padding:.68rem .9rem;font-size:.95rem;color:var(--text)}
  .dropdown-menu a:hover{background:var(--panel-2)}
  .nb-cell{display:flex;align-items:center;justify-content:center;height:84px;border-radius:.7rem;border:1px solid var(--border)}
  .nb-hdr{font-weight:700;color:var(--muted)}
  .nb-badge{font-size:1.6rem;font-weight:800}
  .nb-cell[data-bucket]{cursor:pointer}
  .nb-green{background:var(--nine-green)}
  .nb-yellow{background:var(--nine-yellow)}
  .nb-orange{background:var(--nine-orange)}
  .nb-red{background:var(--nine-red)}
  .btn{border-radius:.8rem;padding:.6rem .9rem;font-weight:700}
  .btn-ghost{background:var(--panel);border:1px solid var(--border);color:var(--text)}
  .btn-sky{background:var(--accent);color:#fff}
  .btn-sky:hover{filter:brightness(0.95)}
</style>
</head>

<body data-theme="dark">
<div class="flex h-screen overflow-hidden">
  <!-- Sidebar -->
  <aside class="hidden md:flex w-64 flex-col sidebar text-white p-4">
    <div class="flex items-center mb-8">
      <img src="logo-meli.png?v=1" alt="MELI" class="h-7 w-7 mr-3"/>
      <h1 class="text-2xl font-extrabold">Catálogo</h1>
    </div>
    <nav id="nav-menu" class="flex-1 space-y-2">
      <a href="#resumen"   class="sidebar-link active flex items-center p-3">Visión Global</a>
      <a href="#detalle"   class="sidebar-link flex items-center p-3">Detalle por Colaborador</a>
      <a href="#lideres"   class="sidebar-link flex items-center p-3">Comparativa por Equipo</a>
      <a href="#evolucion" class="sidebar-link flex items-center p-3">Evolución Semanal</a>
      <a href="#ubicacion" class="sidebar-link flex items-center p-3">Análisis por Ubicación</a>
      <a href="#analisis"  class="sidebar-link flex items-center p-3">Insights Avanzados</a>
    </nav>
  </aside>

  <!-- Main -->
  <main class="flex-1 overflow-x-hidden overflow-y-auto">
    <div class="container mx-auto px-6 py-8">
      <!-- Header -->
      <div class="flex flex-wrap justify-between items-center mb-6 gap-3">
        <h2 id="page-title" class="text-3xl font-extrabold">Visión Global</h2>

        <div class="flex items-center gap-2">
          <button id="btn-clear-filters" class="btn btn-ghost text-sm">Limpiar todos los filtros</button>
          <button id="theme-toggle" class="btn btn-ghost" title="Cambiar tema">
            <span id="icon-moon" class="inline-block" aria-hidden="true">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
            </span>
            <span id="icon-sun" class="hidden" aria-hidden="true">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"><path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.8 1.42-1.42zm10.48 0l1.8-1.79 1.41 1.41-1.79 1.8-1.42-1.42zM12 4V1h-0v3h0zM4 13H1v-2h3v2zm19 0h-3v-2h3v2zM6.76 19.16l-1.42 1.42-1.79-1.8 1.41-1.41 1.8 1.79zm10.48 0l1.42 1.42 1.79-1.8-1.41-1.41-1.8 1.79zM12 23h-0v-3h0v3zM12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12z"/></svg>
            </span>
          </button>

          <div class="dropdown">
            <button id="btn-export" class="btn btn-sky text-sm">Exportar</button>
            <div id="export-menu" class="dropdown-menu hidden">
              <a href="#" data-exp="gs">Enviar sección a Google Sheets</a>
              <a href="#" data-exp="png">Exportar gráficos (PNG)</a>
            </div>
          </div>
        </div>
      </div>

      <!-- Barra de filtros -->
      <div id="filters-bar" class="flex flex-wrap gap-3 mb-8"></div>

      <!-- Secciones -->
      <div id="dashboard-content">
        <!-- Resumen -->
        <section id="resumen" class="page-section">
          <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-6 gap-6 mb-6">
            <div class="kpi-card text-center"><div class="kpi-title mb-2">Total Tareas</div><div id="kpi-total-tareas" class="kpi-value">—</div></div>
            <div class="kpi-card text-center"><div class="kpi-title mb-2">IDs trabajados</div><div id="kpi-ids" class="kpi-value">—</div></div>
            <div class="kpi-card text-center"><div class="kpi-title mb-2">Promedio Diario</div><div id="kpi-promedio-diario" class="kpi-value">—</div></div>
            <div class="kpi-card text-center"><div class="kpi-title mb-2">% Efectividad</div><div id="kpi-efectividad-prom" class="kpi-value">—</div></div>
            <div class="kpi-card text-center"><div class="kpi-title mb-2">Correcciones Auditadas</div><div id="kpi-correcciones" class="kpi-value">—</div></div>
            <div class="kpi-card text-center"><div class="kpi-title mb-2">Usuarios Activos</div><div id="kpi-usuarios" class="kpi-value">—</div></div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div id="ninebox-card" class="kpi-card">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Productividad - Calidad</h3>
                <button id="generate-summary-btn" class="btn btn-sky text-sm">✨ Generar Resumen</button>
              </div>
              <div id="ninebox-grid" class="grid grid-cols-4 gap-2"></div>
              <p class="mt-3 text-xs" style="color:var(--muted)">
                PM: Prod. Alta ≥80; Media 70–&lt;80 · KV: Prod. Alta ≥28; Media 24–&lt;28 (equivalente diario).<br>
                Calidad (ambos): Alta ≥90%; Media 75%–&lt;90%; Baja &lt;75%.
              </p>
              <div id="ninebox-missing" class="mt-4 text-sm"></div>
              <div id="ninebox-details" class="mt-4 hidden"></div>
            </div>

            <div class="kpi-card">
              <h3 class="text-xl font-semibold mb-4">Tareas por Flujo</h3>
              <div class="relative mx-auto" style="height:320px;max-width:520px"><canvas id="demandPieChart"></canvas></div>
              <div id="demandTotals" class="mt-3 text-center text-sm" style="color:var(--muted)"></div>
            </div>
          </div>
        </section>

        <!-- Detalle por Usuario -->
        <section id="detalle" class="page-section hidden">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="kpi-card lg:col-span-2"><h3 class="text-xl font-semibold mb-4">Promedio Diario - % Efectividad</h3><div class="h-[400px]"><canvas id="tasksByUserChart"></canvas></div></div>
            <div class="grid grid-cols-1 gap-4">
              <div class="kpi-card text-center"><div class="kpi-title mb-2">Promedio Diario</div><div id="det-kpi-prom" class="kpi-value"></div></div>
              <div class="kpi-card text-center"><div class="kpi-title mb-2">% Efectividad</div><div id="det-kpi-ef" class="kpi-value"></div></div>
              <div class="kpi-card text-center"><div class="kpi-title mb-2">IDs trabajados</div><div id="det-kpi-ids" class="kpi-value"></div></div>
            </div>
          </div>
        </section>

        <!-- Comparativa por equipo -->
        <section id="lideres" class="page-section hidden">
          <div class="kpi-card"><h3 class="text-xl font-semibold mb-4">Comparativa por Equipo</h3><div class="h-[400px]"><canvas id="tasksByLeaderChart"></canvas></div></div>
        </section>

        <!-- Evolución semanal -->
        <section id="evolucion" class="page-section hidden">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="kpi-card lg:col-span-2"><h3 class="text-xl font-semibold mb-4">Promedio Diario - % Efectividad</h3><div class="h-[400px]"><canvas id="weeklyEvolutionChart"></canvas></div></div>
            <div class="grid grid-cols-1 gap-4">
              <div class="kpi-card text-center"><div class="kpi-title mb-2">Promedio Diario</div><div id="evo-kpi-prom" class="kpi-value"></div></div>
              <div class="kpi-card text-center"><div class="kpi-title mb-2">% Efectividad</div><div id="evo-kpi-ef" class="kpi-value"></div></div>
              <div class="kpi-card text-center"><div class="kpi-title mb-2">IDs trabajados</div><div id="evo-kpi-ids" class="kpi-value"></div></div>
              <div class="kpi-card text-center"><div class="kpi-title mb-2">Usuarios Activos</div><div id="evo-kpi-users" class="kpi-value"></div></div>
            </div>
          </div>
        </section>

        <!-- Ubicación -->
        <section id="ubicacion" class="page-section hidden">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="kpi-card"><h3 class="text-xl font-semibold mb-4">Promedio Diario - % Efectividad</h3><div class="h-[400px]"><canvas id="locCombinedChart"></canvas></div></div>
            <div class="kpi-card"><h3 class="text-xl font-semibold mb-4">Antigüedad Promedio (meses)</h3><div id="avg-antiguedad-cards" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div></div>
          </div>
          <div class="kpi-card mt-6"><h3 class="text-xl font-semibold mb-4">Evolutivo por Ubicación (Promedio Diario)</h3><div class="h-[420px]"><canvas id="locTimeChart"></canvas></div></div>
        </section>

        <!-- IA -->
        <section id="analisis" class="page-section hidden">
          <div class="kpi-card">
            <h3 class="text-xl font-semibold mb-2">Análisis Inteligente con Gemini</h3>
            <p class="mb-4" style="color:var(--muted)">Insights basados en los datos y filtros actuales.</p>
            <button id="generate-insights-btn" class="btn btn-sky text-base">✨ Analizar Datos y Generar Sugerencias</button>
            <div id="insights-output" class="mt-6 p-4 rounded-md border hidden" style="background:var(--panel-2);border-color:var(--border)"></div>
          </div>
        </section>
      </div>
    </div>
  </main>
</div>

<script>
/**********************
 * CONFIG
 **********************/
const SHEETS_WEB_APP = "https://script.google.com/macros/s/AKfycbxqTzxdY090fV2JWIFxiqAVnkre_dtUw1M09ZMv9mNKYz3GQW-d1ONSP_FIJTswZ9t2qA/exec";
const GEMINI_PROXY_URL = "https://catalogo.ezequiel-galarza.workers.dev/?model=gemini-1.5-flash";

// Después (PM opcional; KV usa productividad.csv)
const FILES_PM = { productividad:'productividad.csv', calidad:'calidad.csv', base:'base.csv', lideres:'lideres.csv' };
const FILES_KV = {
  productividad:'productividad-kv.csv',          // <- así como está en el repo
  calidad_crea:'calidad-creacion-kv.csv',
  calidad_merge:'calidad-merge-kv.csv'
};

/* Paleta charts */
const PALETTE = { c0:'#86eae9', c1:'#3edad8', c2:'#37c9ef', c3:'#8b5cf6', c4:'#2c92d5', c5:'#13538a', c6:'#f59e0b', c7:'#fb923c', c8:'#10b981', c9:'#f87171' };
const BAR_BG = 'rgba(55,201,239,0.45)';
const LINE_ACC = '#22c3ee';

/* Chart defaults */
Chart.defaults.elements.bar.borderRadius = 6;
Chart.defaults.elements.line.borderWidth = 4;
Chart.defaults.elements.point.radius = 3;
Chart.defaults.elements.point.hoverRadius = 5;
Chart.defaults.elements.point.borderWidth = 2;
Chart.defaults.plugins.legend.labels.usePointStyle = true;
const charts = {};
function createOrUpdateChart(id, cfg){
  if (charts[id]) { charts[id].data=cfg.data; charts[id].options=cfg.options||{}; charts[id].update(); return charts[id]; }
  const ctx=document.getElementById(id)?.getContext('2d'); if(!ctx) return null;
  charts[id]=new Chart(ctx,cfg); return charts[id];
}
function barDataset(label, data){ return { type:'bar', label, data, yAxisID:'y', backgroundColor:BAR_BG, borderColor:'rgba(0,0,0,0)', order:1, barPercentage:0.8, categoryPercentage:0.8 }; }
function lineEffDataset(label, data){ return { type:'line', label, data, yAxisID:'y1', borderColor:LINE_ACC, backgroundColor:LINE_ACC, order:2, fill:false, tension:0.25, pointRadius:3, pointHoverRadius:5, pointBackgroundColor:'#fff', pointBorderColor:LINE_ACC, borderWidth:3, spanGaps:true }; }
function lineDataset(label,data,color,yAxis='y'){ return { type:'line', label, data, yAxisID:yAxis, borderColor:color, backgroundColor:color, order:2, fill:false, tension:0.25, pointRadius:2, pointHoverRadius:4, pointBackgroundColor:'#fff', pointBorderColor:color, borderWidth:2, spanGaps:true }; }

/**********************
 * HELPERS
 **********************/
const MONTHS_ES = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const Q_OF_MONTH_INDEX = m => 'Q' + (Math.floor(m/3)+1);

/* ISO week (W01..W53) */
function isoWeekNumber(date){
  const d=new Date(Date.UTC(date.getFullYear(),date.getMonth(),date.getDate()));
  const dayNum=d.getUTCDay()||7;
  d.setUTCDate(d.getUTCDate()+4-dayNum);
  const yearStart=new Date(Date.UTC(d.getUTCFullYear(),0,1));
  return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
}

/* Equipo config */
const TEAM_CONFIG = {
  'PM': { prodDaily: { low:70, high:80 }, flows: ['demanda','enhancement'] },
  'KV': { prodDaily: { low:24, high:28 }, flows: ['outsiders','creacion','merge1','merge2','adhoc'], defaultLeader: 'Celeste Cignoli' },
  'Matchers': { prodDaily: { low:70, high:80 }, flows: [] }
};

/* KV: mapeo tarea_detalle → clave interna */
function kvFlowKey(codeRaw){
  const s = String(codeRaw || '').toUpperCase().replace(/[^A-Z0-9]+/g,' ');
  if (/\bOUTSIDER/.test(s)) return 'outsiders';
  if (/\bADHOC\b/.test(s) || /AD HOC/.test(s)) return 'adhoc';
  if (/\bCREATION\b/.test(s) || /\bCREA(CION|CIONAMIENTO)?\b/.test(s)) return 'creacion';
  if (/\bMERGE\b/.test(s)) {
    if (/DA\b/.test(s) || /\b2\b/.test(s) || /\bSEGUNDA\b/.test(s)) return 'merge2';
    return 'merge1';
  }
  // fallback: a veces viene el nombre del flujo solo
  if (/\bKNOWN VALUE\b/.test(s)) return 'creacion';
  return null;
}

function flowTitle(key){
  switch(key){
    case 'demanda': return 'Demanda';
    case 'enhancement': return 'Enhancement';
    case 'outsiders': return 'Outsiders';
    case 'creacion': return 'Creación';
    case 'merge1': return 'Merge 1ª Revisión';
    case 'merge2': return 'Merge 2ª Revisión';
    case 'adhoc': return 'Tareas Adhoc';
    default: return key;
  }
}

/* IO helpers */
function ghURL(file){
  const bust = `?v=${Date.now()}`;
  return [
    file + bust,                 // mismo directorio que index.html
    './' + file + bust,          // explícito relativo
    '/' + file + bust,           // raíz del sitio
    '/metricas/' + file + bust,  // subcarpeta (para cuando lo publiques ahí)
    'https://raw.githubusercontent.com/catalogo-meli/metricas/main/' + file + bust
  ];
}

async function fetchCSVFile(file){
  const urls = ghURL(file);
  for (const u of urls) {
    try {
      const r = await fetch(u, { cache: 'no-store' });
      if (r.ok) return r.text();
    } catch (_) {}
  }
  throw new Error(`No pude cargar ${file}`);
}

function parseCSV(text){
  const parsed = Papa.parse(text,{ header:true, skipEmptyLines:true, delimitersToGuess:[',',';','\t','|'] });
  return parsed.data.map(row=>{ const out={}; for(const [k,v] of Object.entries(row)) out[k]=normalizeValue(v); return out; });
}
function normalizeValue(v){
  if(v===null||v===undefined) return v;
  if(typeof v!=='string') return v;
  const t=v.trim(); if(!t) return '';
  if(t.endsWith('%')){ const n=Number(t.replace('%','').replace(/\./g,'').replace(',','.')); return Number.isFinite(n)? n/100 : t; }
  if(/^-?\d{1,3}(\.\d{3})*,\d+$/.test(t)){ const n=Number(t.replace(/\./g,'').replace(',','.')); return Number.isFinite(n)? n : t; }
  if(/^-?\d+(\.\d+)?$/.test(t)){ const n=Number(t); return Number.isFinite(n)? n : t; }
  return t;
}
function parseDateAny(val){
  if(val===null||val===undefined||val==='') return null;
  if(typeof val==='number'){ const ms=Math.round((val-25569)*86400*1000); const d=new Date(ms); return isNaN(d.getTime())? null : d; }
  const s=String(val).trim(); const m=s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
  if(m){ const d=Number(m[1]), mo=Number(m[2])-1, y=Number(m[3].length===2?'20'+m[3]:m[3]); const dt=new Date(y,mo,d); return isNaN(dt.getTime())? null : dt; }
  const dt=new Date(s); return isNaN(dt.getTime())? null : dt;
}
function keyIncludes(k,needle){ return k.toLowerCase().includes(needle); }
function pick(row,needles){ const keys=Object.keys(row); for(const n of needles){ const k=keys.find(k=>keyIncludes(k,n)); if(k) return row[k]; } }
function correoAUsuario(mail){ if(!mail) return ''; return String(mail).toLowerCase().replace(/\s/g,'').replace(/@mercadolibre\.com/i,''); }
const fmt = { int: n => (n ?? 0).toLocaleString('es-AR'), pct: x => (x ?? 0).toLocaleString('es-AR',{style:'percent',minimumFractionDigits:2,maximumFractionDigits:2}), dec: x => (x ?? 0).toLocaleString('es-AR',{minimumFractionDigits:2,maximumFractionDigits:2}) };
function setColor(el, color){ el.classList.remove('text-red-600','text-yellow-500','text-green-600','text-orange-500'); if(color) el.classList.add(color); }

/**********************
 * LÍDERES MAP
 **********************/
function buildLeadersMap(lideresRows){
  const map = new Map();
  lideresRows.forEach(r=>{
    const user = correoAUsuario(pick(r,['usuario','user','mail','email']));
    const lider= pick(r,['líder','lider']) || '';
    if(user && lider && !String(lider).toLowerCase().startsWith('sin ')) map.set(user,lider);
  });
  return map;
}

/**********************
 * CONSOLIDADO – PM
 **********************/
function buildPMRows(prod, cal, base, leadersMap){
  const P = prod.map(r=>({
    fecha: parseDateAny(pick(r,['fecha'])),
    week:  Number(pick(r,['week'])),
    user:  correoAUsuario(pick(r,['usuario','user','mail','email'])),
    dem:   Number(pick(r,['tareas de demanda','demanda']))||0,
    enh:   Number(pick(r,['tareas de enhancement','enhancement']))||0,
    total: Number(pick(r,['total tareas','total']))||0,
    idsW:  Number(pick(r,['ids trabaj']))||0
  })).filter(r=>r.fecha && r.week && r.user);

  const C = cal.map(r=>({
    week: Number(pick(r,['week'])),
    user: correoAUsuario(pick(r,['usuario','user','mail','email'])),
    idsC: Number(pick(r,['ids audit']))||0,
    err:  Number(pick(r,['total error','errores']))||0
  })).filter(r=>r.week && r.user);

  const perfiles = new Map();
  base.forEach(r=>{
    const user = correoAUsuario(pick(r,['mail','email','usuario'])); if(!user) return;
    perfiles.set(user,{ ciudad: pick(r,['ciudad','ubicación','ubicacion'])||'', ingreso: parseDateAny(pick(r,['fecha ingreso','ingreso'])) });
  });

  const weeks = new Map();
  for(const r of P){
    const y=r.fecha.getFullYear(), m=r.fecha.getMonth();
    const ym=`${y}-${String(m+1).padStart(2,'0')}`;
    const key=`${r.user}|${r.week}|${ym}`;
    if(!weeks.has(key)){
      const perf = perfiles.get(r.user)||{};
      const ingreso = perf.ingreso, hoy=new Date();
      const finAnt = (ingreso && ingreso<=hoy)? hoy : ingreso || hoy;
      const antig = ingreso ? Math.max(0,(finAnt.getFullYear()-ingreso.getFullYear())*12+(finAnt.getMonth()-ingreso.getMonth())) : '';
      weeks.set(key,{ week:r.week, mes:MONTHS_ES[m], mesIndex:m, user:r.user, lider:leadersMap.get(r.user)||'Sin líder', ciudad:perf.ciudad||'', antig, dias:new Set(), demand:0, enh:0, total:0, idsWork:0, idsCal:0, errCal:0 });
    }
    const o=weeks.get(key);
    o.demand+=r.dem; o.enh+=r.enh; o.total+=r.total; o.idsWork+=r.idsW;
    const dKey = `${r.fecha.getFullYear()}-${String(r.fecha.getMonth()+1).padStart(2,'0')}-${String(r.fecha.getDate()).padStart(2,'0')}`;
    o.dias.add(dKey);
  }

  for(const r of C){
    const pref = `${r.user}|${r.week}|`;
    for(const key of weeks.keys()){
      if(key.startsWith(pref)){ const o = weeks.get(key); o.idsCal += r.idsC; o.errCal += r.err; }
    }
  }

  return Array.from(weeks.values()).sort((a,b)=>a.week-b.week).map(o=>{
    const prom = o.dias.size ? (o.total/o.dias.size) : '';
    const pEf  = o.idsCal>0 ? (1 - (o.errCal/o.idsCal)) : '';
    return { equipo:'PM', flujo:null, week:o.week, mes:o.mes, mesIndex:o.mesIndex, q:Q_OF_MONTH_INDEX(o.mesIndex), usuario:o.user, 'líder':o.lider, ciudad:o.ciudad, antigüedad:o.antig, promedio_diario: prom, efectividad:pEf, tareas_demanda:o.demand, tareas_enhancement:o.enh, total_tareas:o.total, ids_trabajados:o.idsWork, correcciones_auditadas:o.idsCal, dias_activos:o.dias.size };
  });
}

/**********************
 * CONSOLIDADO – KV (productividad-kv + calidades)
 **********************/
function normalizeWeekLabel(w){
  if(w==null||w==='') return null;
  if(typeof w==='number') return Number(w);
  const s=String(w).trim();
  const wMatch = s.match(/W\s*?(\d{1,2})/i); if(wMatch) return Number(wMatch[1]);
  const nums = Array.from(s.matchAll(/(\d{1,2})/g)).map(m=>Number(m[1]));
  const cand = nums.reverse().find(n=>n>=1 && n<=53);
  return cand || null;
}

/* Calidad: agrega auditados/errores por (usuario, semana) usando esquema PM */
function buildKVQualityMaps(qCreaRows, qMergeRows){
  const map = new Map(); // key u|w -> {aud: n, err: e}
  function add(u, w, isError){
    if(!u||!w) return;
    const k=`${u}|${w}`; const o=map.get(k)||{aud:0, err:0};
    o.aud += 1; if(isError) o.err += 1; map.set(k,o);
  }

  // Creación: Week_Accionamiento, Usuario, Decision (correcta/incorrecta)
  (qCreaRows||[]).forEach(r=>{
    const week = normalizeWeekLabel(r.Week_Accionamiento || r['Week Accionamiento'] || r.Week || r.Semana);
    const user = correoAUsuario(r.Usuario || r.User || r.Mail || r.Email);
    const dec  = String(r.Decision||'').toLowerCase();
    const isError = dec && !dec.includes('correcta'); // incorrecta => error
    add(user, week, isError);
  });

  // Merge: acepto Decision o booleanos típicos
  (qMergeRows||[]).forEach(r=>{
    const week = normalizeWeekLabel(r.Week_Accionamiento || r['Week Accionamiento'] || r.Week || r.Semana);
    const user = correoAUsuario(r.Usuario || r.User || r.Mail || r.Email);
    let isError = false;
    if(r.Decision!=null){
      const dec = String(r.Decision).toLowerCase();
      isError = dec && !dec.includes('correcta');
    }else{
      const val = String(r.Valor_Correcto_Audit_TL ?? r.Correcto ?? r.Resultado ?? '').toLowerCase();
      if(val!==''){ isError = (val==='false' || val==='incorrecto' || val==='incorrecta' || val==='error'); }
    }
    add(user, week, isError);
  });

  return map; // {aud,err}
}

function buildKVRows(prodRows, qCreaRows, qMergeRows, leadersMap){
  const quality = buildKVQualityMaps(qCreaRows, qMergeRows);

  // Función auxiliar para detectar el flujo con múltiples variantes
  function readFlow(r){
    const raw = pick(r, [
      'tarea_detalle','tarea detalle','detalle tarea','detalle',
      'flujo','flow','task_detail','task detail','accion','accionamiento'
    ]);
    return kvFlowKey(raw);
  }

  // Lee fecha o semana (si no hay fecha)
  function readWeek(r){
    const fechaRaw = pick(r, ['fecha','date','día','dia','fecha accion','fecha acc','created','creation date']);
    const semanaRaw = pick(r, ['week','semana','week_accionamiento','week accionamiento','w']);

    let fecha = parseDateAny(fechaRaw);
    if (fecha) return { week: isoWeekNumber(fecha), mesIndex: fecha.getMonth(), fecha };

    const w = normalizeWeekLabel(semanaRaw);
    if (w) return { week: w, mesIndex: null, fecha: null };

    return { week: null, mesIndex: null, fecha: null };
  }

  // Lee usuario y cantidad de tareas con variantes
  function readUser(r){
    return correoAUsuario(pick(r, ['usuario','user','mail','email','operador','agent','owner']));
  }
  function readCount(r){
    return Number(
      pick(r, [
        'tareas realizadas','tareas','cantidad','total','count','items','qty','quantity'
      ])
    ) || 1;
  }

  // Agrego productividad por (usuario, semana, flujo)
  const agg = new Map(); // u|w|flow -> {usuario, week, mesIndex, dias:Set, tareas, flow}
  (prodRows||[]).forEach(r=>{
    const { week, mesIndex, fecha } = readWeek(r);
    const usuario = readUser(r);
    const flowKey = readFlow(r);
    if(!usuario || !week || !flowKey) return;

    const tareas = readCount(r);
    const k = `${usuario}|${week}|${flowKey}`;
    const o = agg.get(k) || {usuario, week, mesIndex: (mesIndex ?? (fecha? fecha.getMonth():0)), dias:new Set(), tareas:0, flow:flowKey};
    o.tareas += tareas;
    if (fecha) o.dias.add(fecha.toDateString());     // si no hay fecha, luego “relleno” días
    agg.set(k,o);
  });

  const rows = [];

/**********************
 * ESTADO
 **********************/
let originalData = [];
let currentData  = [];
let nineboxDetailsData = {};

const state = {
  filtros: { equipo: [], q: [], mes: [], semana: [], ubic: [], lider: [], usuario: [], flujo: [] },
  theme: (localStorage.getItem('theme') || 'dark')
};

/**********************
 * UI FILTROS
 **********************/
const FILTER_ORDER  = ['equipo','q','mes','semana','ubic','lider','usuario','flujo'];
const FILTER_PREFIX = { equipo:'Equipo', q:'Trimestre', mes:'Mes', semana:'Semana', ubic:'Ubicación', lider:'Líder', usuario:'Usuario', flujo:'Flujo' };

function uniqueSorted(arr){ return Array.from(new Set(arr)).sort(); }
function uniqueSortedNum(arr){ return Array.from(new Set(arr)).sort((a,b)=>a-b); }

function filteredOriginalDataExcept(exceptKeys){
  const v = state.filtros; const exc = new Set([].concat(exceptKeys||[]));
  return originalData.filter(r =>
    (exc.has('equipo') || v.equipo.length===0  || v.equipo.includes(r.equipo)) &&
    (exc.has('mes')    || v.mes.length===0     || v.mes.includes(r.mes)) &&
    (exc.has('semana') || v.semana.length===0  || v.semana.includes(String(r.week))) &&
    (exc.has('ubic')   || v.ubic.length===0    || v.ubic.includes(r.ciudad)) &&
    (exc.has('usuario')|| v.usuario.length===0 || v.usuario.includes(r.usuario)) &&
    (exc.has('lider')  || v.lider.length===0   || v.lider.includes(r['líder'])) &&
    (exc.has('q')      || v.q.length===0       || v.q.includes(r.q))
  );
}
function flowsForSelectedEquipos(){
  const eq = state.filtros.equipo; const teams = (eq.length===0) ? ['PM','KV'] : eq;
  const set = new Set(); teams.forEach(t => (TEAM_CONFIG[t]?.flows||[]).forEach(f=>set.add(f))); return Array.from(set);
}
function computeFilterOptions(){
  const forQ      = filteredOriginalDataExcept('q');
  const forMes    = filteredOriginalDataExcept('mes');
  const forSemana = filteredOriginalDataExcept('semana');
  const forUbic   = filteredOriginalDataExcept('ubic');
  const forLider  = filteredOriginalDataExcept('lider');
  const forUser   = filteredOriginalDataExcept('usuario');
  return {
    equipo: ['PM','KV','Matchers'],
    q: ['Q1','Q2','Q3','Q4'].filter(q => forQ.some(r=>r.q===q)),
    mes: MONTHS_ES.filter(m => forMes.some(r=>r.mes===m)),
    semana: uniqueSortedNum(forSemana.map(r=>r.week)).map(String),
    ubic: uniqueSorted(forUbic.map(r=>r.ciudad).filter(Boolean)),
    lider: uniqueSorted(forLider.map(r=>r['líder']).filter(l => l && !String(l).toLowerCase().startsWith('sin '))),
    usuario: uniqueSorted(forUser.map(r=>r.usuario)),
    flujo: flowsForSelectedEquipos()
  };
}
function pillValueText(key){
  const sel = state.filtros[key];
  const pluralTodos = (key==='semana' || key==='ubic') ? 'Todas' : 'Todos';
  if(key==='flujo'){ if(sel.length===0) return 'Todos'; if(sel.length===1) return flowTitle(sel[0]); return `${sel.length} seleccionados`; }
  if(sel.length===0) return pluralTodos;
  if(sel.length===1) return sel[0];
  return `${sel.length} seleccionados`;
}
function closeAllMenus(){ document.querySelectorAll('.menu').forEach(m=>m.classList.remove('open')); }
function renderFiltersBar(){
  const opts = computeFilterOptions(); const bar = document.getElementById('filters-bar'); bar.innerHTML = '';
  FILTER_ORDER.forEach(key=>{
    const pill = document.createElement('div'); pill.className = 'pill relative';
    pill.innerHTML = `
      <span class="prefix">${FILTER_PREFIX[key]}</span>
      <span class="value">${pillValueText(key)}</span>
      <span class="chev">▾</span>
      <div class="menu"><div class="head"><input type="text" class="search" placeholder="Buscar..."/><button class="clear">Limpiar</button></div><div class="list"></div><div class="foot text-xs">Selección múltiple</div></div>`;
    bar.appendChild(pill);
    const menu = pill.querySelector('.menu'); const list = menu.querySelector('.list'); const search = menu.querySelector('.search');
    function labelize(v){ return key==='flujo'? flowTitle(v) : v; }
    function buildList(){
      list.innerHTML='';
      const values = opts[key].filter(v => String(labelize(v)).toLowerCase().includes(search.value.trim().toLowerCase()));
      values.forEach(v=>{
        const id = `${key}-${v}`.replace(/\s+/g,'_'); const selected = state.filtros[key].includes(v);
        const item = document.createElement('label'); item.className='item';
        item.innerHTML = `<input type="checkbox" class="opt" id="${id}" value="${v}" ${selected?'checked':''}/><span>${labelize(v)}</span>`;
        list.appendChild(item);
      });
      list.style.scrollbarWidth='thin';
    }
    buildList();
    pill.addEventListener('click',(e)=>{ const open = menu.classList.contains('open'); if(!e.target.closest('.menu')){ closeAllMenus(); if(!open) menu.classList.add('open'); }});
    search.addEventListener('input', buildList);
    menu.addEventListener('change', ()=>{ const selected = Array.from(menu.querySelectorAll('.opt')).filter(i=>i.checked).map(i=>i.value); state.filtros[key] = selected; pill.querySelector('.value').textContent = pillValueText(key); applyFilters(); });
    menu.querySelector('.clear').addEventListener('click',(e)=>{ e.stopPropagation(); state.filtros[key]= []; pill.querySelector('.value').textContent = pillValueText(key); renderFiltersBar(); applyFilters(); });
  });
  document.addEventListener('click', (ev)=>{ if(!bar.contains(ev.target)) closeAllMenus(); }, { once:true });
}

/**********************
 * NAV + EXPORT + THEME
 **********************/
function setupNavigation(){
  const links=[...document.querySelectorAll('#nav-menu a')];
  links.forEach(a=>{
    a.addEventListener('click', e=>{
      e.preventDefault();
      const target=a.getAttribute('href');
      document.querySelectorAll('.page-section').forEach(s=>s.classList.add('hidden'));
      document.querySelector(target).classList.remove('hidden');
      links.forEach(x=>x.classList.remove('active')); a.classList.add('active');
      document.getElementById('page-title').textContent=a.textContent;
      if(target==='#detalle'){ renderTasksByUser(); updateDetailKPIs(); }
      if(target==='#lideres') renderTasksByLeader();
      if(target==='#evolucion'){ renderWeeklyEvolution(); updateEvolutionKPIs(); }
      if(target==='#ubicacion'){ renderByLocation(); renderLocationTimeline(); }
    });
  });

  // Export
  document.getElementById('btn-export').addEventListener('click', ()=>{ document.getElementById('export-menu').classList.toggle('hidden'); });
  document.addEventListener('click',(e)=>{
    const dd=document.getElementById('export-menu');
    if(!dd.contains(e.target) && !document.getElementById('btn-export').contains(e.target)) dd.classList.add('hidden');
  });
  document.querySelectorAll('#export-menu a').forEach(a=>{
    a.addEventListener('click', async (e)=>{
      e.preventDefault();
      document.getElementById('export-menu').classList.add('hidden');
      const type=a.getAttribute('data-exp');
      if(type==='png') exportSectionPNGs();
      if(type==='gs')  sendSectionToGoogleSheets();
    });
  });

  // Clear all
  document.getElementById('btn-clear-filters').addEventListener('click', ()=>{
    state.filtros = { equipo:[], q:[], mes:[], semana:[], ubic:[], lider:[], usuario:[], flujo:[] };
    renderFiltersBar(); applyFilters();
  });

  // Theme
  function applyTheme(){
    document.body.setAttribute('data-theme',state.theme);
    const isDark = state.theme==='dark';
    document.getElementById('icon-moon').classList.toggle('hidden', !isDark);
    document.getElementById('icon-sun').classList.toggle('hidden', isDark);
    const col = getComputedStyle(document.body).getPropertyValue('--text').trim() || '#e2e8f0';
    Chart.defaults.color = col;
    Object.values(charts).forEach(c=>c?.update());
  }
  document.getElementById('theme-toggle').addEventListener('click',()=>{ state.theme = (state.theme==='dark')?'light':'dark'; localStorage.setItem('theme', state.theme); applyTheme(); });
  applyTheme();
}

/**********************
 * FLOWS HELPERS
 **********************/
function selectedFlows(){
  let s = state.filtros.flujo;
  if(!s || s.length===0) s = flowsForSelectedEquipos();
  return new Set(s);
}
function tareasByFlows(row, flowsSet){
  const f = flowsSet || selectedFlows();
  if(row.equipo==='PM'){
    let sum=0;
    if(f.has('demanda')) sum += (row.tareas_demanda||0);
    if(f.has('enhancement')) sum += (row.tareas_enhancement||0);
    if(f.has('demanda') && f.has('enhancement') && sum===0) sum = row.total_tareas||0;
    return sum;
  }
  if(row.equipo==='KV'){ return f.has(row.flujo) ? (row.total_tareas||0) : 0; }
  return row.total_tareas||0;
}
function promedioDiario(rows){
  const f = selectedFlows();
  const den = rows.reduce((s,r)=> s + (r.dias_activos||0), 0);
  const num = rows.reduce((s,r)=> s + tareasByFlows(r,f), 0);
  return den ? num/den : 0;
}

/**********************
 * APLICAR FILTROS
 **********************/
function applyFilters(){
  const f = state.filtros;
  currentData = originalData.filter(r =>
    (f.equipo.length===0 || f.equipo.includes(r.equipo)) &&
    (f.mes.length===0    || f.mes.includes(r.mes)) &&
    (f.semana.length===0 || f.semana.includes(String(r.week))) &&
    (f.ubic.length===0   || f.ubic.includes(r.ciudad)) &&
    (f.usuario.length===0|| f.usuario.includes(r.usuario)) &&
    (f.lider.length===0  || f.lider.includes(r['líder'])) &&
    (f.q.length===0      || f.q.includes(r.q))
  );

  renderFiltersBar();
  updateKPIs();
  renderNineBox();
  renderDemandPie();
  renderTasksByUser();
  renderTasksByLeader();
  renderWeeklyEvolution();
  renderByLocation();
  renderLocationTimeline();
  updateEvolutionKPIs();
  updateDetailKPIs();
}

/**********************
 * KPI + RENDER
 **********************/
function updateKPIs(){
  const idsTrab = currentData.reduce((s,r)=> s + (r.ids_trabajados||0), 0);
  const usuarios = new Set(currentData.map(r=>r.usuario)).size;
  const correcc = currentData.reduce((s,r)=> s + (r.correcciones_auditadas||0), 0);
  const prom = promedioDiario(currentData);
  const vals = currentData.map(r=>r.efectividad).filter(v => v!=='' && v!==null && v!==undefined);
  const ef = vals.length ? vals.reduce((a,b)=>a+b,0)/vals.length : 0;
  const totalFlujo = currentData.reduce((s,r)=> s + tareasByFlows(r), 0);

  const promEl = document.getElementById('kpi-promedio-diario');
  const efEl   = document.getElementById('kpi-efectividad-prom');
  setColor(promEl, (prom<=70) ? 'text-red-600' : (prom>=80) ? 'text-green-600' : 'text-yellow-500');
  const efPct = ef*100;
  setColor(efEl, (efPct<=75) ? 'text-red-600' : (efPct<87) ? 'text-orange-500' : (efPct<90) ? 'text-yellow-500' : 'text-green-600');

  document.getElementById('kpi-total-tareas').textContent = fmt.int(totalFlujo);
  document.getElementById('kpi-ids').textContent          = fmt.int(idsTrab);
  document.getElementById('kpi-usuarios').textContent     = fmt.int(usuarios);
  document.getElementById('kpi-correcciones').textContent = fmt.int(correcc);
  promEl.textContent = fmt.dec(prom);
  efEl.textContent   = fmt.pct(ef);
}
function updateEvolutionKPIs(){
  const idsTrab = currentData.reduce((s,r)=> s + (r.ids_trabajados||0), 0);
  const usuarios = new Set(currentData.map(r=>r.usuario)).size;
  const prom = promedioDiario(currentData);
  const vals = currentData.map(r=>r.efectividad).filter(v=>v!=='' && v!==null && v!==undefined);
  const ef   = vals.length ? vals.reduce((a,b)=>a+b,0)/vals.length : 0;

  const promEl = document.getElementById('evo-kpi-prom');
  const efEl   = document.getElementById('evo-kpi-ef');
  setColor(promEl, (prom<=70) ? 'text-red-600' : (prom>=80) ? 'text-green-600' : 'text-yellow-500');
  const efPct = ef*100;
  setColor(efEl, (efPct<=75) ? 'text-red-600' : (efPct<87) ? 'text-orange-500' : (efPct<90) ? 'text-yellow-500' : 'text-green-600');

  promEl.textContent = fmt.dec(prom);
  efEl.textContent   = fmt.pct(ef);
  document.getElementById('evo-kpi-ids').textContent   = fmt.int(idsTrab);
  document.getElementById('evo-kpi-users').textContent = fmt.int(usuarios);
}
function updateDetailKPIs(){
  const idsTrab = currentData.reduce((s,r)=> s + (r.ids_trabajados||0), 0);
  const prom = promedioDiario(currentData);
  const vals = currentData.map(r=>r.efectividad).filter(v=>v!=='' && v!==null && v!==undefined);
  const ef   = vals.length ? vals.reduce((a,b)=>a+b,0)/vals.length : 0;

  const promEl = document.getElementById('det-kpi-prom');
  const efEl   = document.getElementById('det-kpi-ef');
  setColor(promEl, (prom<=70) ? 'text-red-600' : (prom>=80) ? 'text-green-600' : 'text-yellow-500');
  const efPct = ef*100;
  setColor(efEl, (efPct<=75) ? 'text-red-600' : (efPct<87) ? 'text-orange-500' : (efPct<90) ? 'text-yellow-500' : 'text-green-600');

  promEl.textContent = fmt.dec(prom);
  efEl.textContent   = fmt.pct(ef);
  document.getElementById('det-kpi-ids').textContent = fmt.int(idsTrab);
}

/* ---------- Nine-box ---------- */
function prodBandByTeam(value, team){
  const cfg = TEAM_CONFIG[team] || TEAM_CONFIG['PM'];
  const { low, high } = cfg.prodDaily;
  if(value>=high) return 'alta';
  if(value>=low)  return 'media';
  return 'baja';
}
function renderNineBox(){
  const flows = selectedFlows();
  const map = new Map(); // user -> {num,den, effSum, effN, team:Set}
  currentData.forEach(r=>{
    const u=r.usuario;
    const o=map.get(u)||{num:0,den:0,effSum:0,effN:0, teams:new Set()};
    o.num += tareasByFlows(r,flows); o.den += (r.dias_activos||0);
    if(r.efectividad!=='' && r.efectividad!==null && r.efectividad!==undefined){ o.effSum+=r.efectividad; o.effN++; }
    if(r.equipo) o.teams.add(r.equipo);
    map.set(u,o);
  });

  const users = Array.from(map.entries()).map(([u,o])=>{
    const prom = o.den? o.num/o.den : null;
    const eff  = o.effN? o.effSum/o.effN : null;
    const team = o.teams.values().next().value || 'PM';
    return {u, prom, eff, team};
  });

  const calBand  = e => (e>=0.90 ? 'alta' : e>=0.75 ? 'media' : 'baja');
  const rows=['alta','media','baja']; const cols=['alta','media','baja'];
  const buckets = {}; const details = {};
  rows.forEach(r=>cols.forEach(c=>{ buckets[`${r}-${c}`]=[]; details[`${r}-${c}`]=[]; }));

  const missing = [];
  users.forEach(x=>{
    if(x.prom===null || x.eff===null){ missing.push(x); }
    else{
      const key = `${prodBandByTeam(x.prom,x.team)}-${calBand(x.eff)}`;
      buckets[key].push(x.u);
      details[key].push({usuario:x.u, prom:x.prom, eff:x.eff});
    }
  });

  const grid = document.getElementById('ninebox-grid');
  const label = s=> s.charAt(0).toUpperCase()+s.slice(1);
  const cellClass = (r,c)=>{
    if(r==='alta' && c==='alta') return 'nb-green';
    if(r==='alta' && c==='media') return 'nb-yellow';
    if(r==='alta' && c==='baja') return 'nb-orange';
    if(r==='media' && c==='alta') return 'nb-yellow';
    if(r==='media' && c==='media') return 'nb-yellow';
    if(r==='media' && c==='baja') return 'nb-orange';
    if(r==='baja' && c==='alta') return 'nb-yellow';
    if(r==='baja' && c==='media') return 'nb-orange';
    return 'nb-red';
  };
  const hdrCell = (txt)=>`<div class="nb-cell nb-hdr" style="height:42px">${txt}</div>`;

  let html = '';
  html += hdrCell('&nbsp;');
  cols.forEach(c=> html += hdrCell('Calidad '+label(c)));
  rows.forEach(r=>{
    html += hdrCell('Prod. '+label(r));
    cols.forEach(c=>{
      const arr = buckets[`${r}-${c}`]||[];
      html += `<div class="nb-cell ${cellClass(r,c)}" data-bucket="${r}-${c}" title="Prod ${label(r)} / Calidad ${label(c)}"><span class="nb-badge">${arr.length}</span></div>`;
    });
  });
  grid.innerHTML = html;

  nineboxDetailsData = details;

  grid.onclick = (ev)=>{ const cell = ev.target.closest('.nb-cell[data-bucket]'); if(!cell) return; const key = cell.getAttribute('data-bucket'); showNineboxDetails(key, label); };

  const missDiv = document.getElementById('ninebox-missing');
  if(missing.length){
    const lines = missing.sort((a,b)=> (a.u>b.u?1:-1)).map(m=>{
      const parts=[]; if(m.prom!==null) parts.push(`Promedio Diario: ${m.prom?.toFixed(2)}`); if(m.eff!==null) parts.push(`% Efectividad: ${(m.eff*100)?.toFixed(2)}%`);
      return `• ${m.u} — ${parts.join(' | ') || 'sin datos'}`;
    });
   if (missing.length) {
  const lines = missing
    .sort((a, b) => (a.u > b.u ? 1 : -1))
    .map(m => {
      const parts = [];
      if (m.prom !== null) parts.push(`Promedio Diario: ${m.prom?.toFixed(2)}`);
      if (m.eff  !== null) parts.push(`% Efectividad: ${(m.eff * 100)?.toFixed(2)}%`);
      return `• ${m.u} — ${parts.join(' | ') || 'sin datos'}`;
    });

  missDiv.innerHTML = `
    <div class="font-medium mb-1">Perfiles no incluidos por datos faltantes</div>
    <div class="whitespace-pre-line">${lines.join('\n')}</div>`;
} else {
  missDiv.innerHTML = '';
}
}

function showNineboxDetails(bucketKey, labelFn) {
  const box = document.getElementById('ninebox-details');
  const rows = (nineboxDetailsData[bucketKey] || [])
    .slice()
    .sort((a, b) => b.prom - a.prom);

  const [prod, cal] = bucketKey.split('-').map(labelFn);

  const header = `
    <div class="flex items-center justify-between mb-2">
      <div class="font-semibold">
        Prod. ${prod} / Calidad ${cal}
        — <span class="font-normal" style="color:var(--muted)">${rows.length} perfiles</span>
      </div>
      <button class="text-sm" style="color:var(--muted)" id="nb-close">Cerrar</button>
    </div>`;

  const table = rows.length ? `
    <div class="overflow-x-auto border rounded-md" style="border-color:var(--border)">
      <table class="min-w-full text-sm">
        <thead style="background:var(--panel-2);color:var(--muted)">
          <tr>
            <th class="text-left px-3 py-2">Usuario</th>
            <th class="text-right px-3 py-2">Prom. Diario</th>
            <th class="text-right px-3 py-2">% Efectividad</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(r => `
            <tr style="border-top:1px solid var(--border)">
              <td class="px-3 py-2">${r.usuario}</td>
              <td class="px-3 py-2 text-right">${(r.prom ?? 0).toLocaleString('es-AR',{minimumFractionDigits:2,maximumFractionDigits:2})}</td>
              <td class="px-3 py-2 text-right">${((r.eff ?? 0)*100).toLocaleString('es-AR',{minimumFractionDigits:2,maximumFractionDigits:2})}%</td>
            </tr>`).join('')}
        </tbody>
      </table>
    </div>` : `
    <div class="text-sm" style="color:var(--muted)">
      Sin perfiles en este cuadrante para los filtros actuales.
    </div>`;

  box.innerHTML = header + table;
  box.classList.remove('hidden');
  document.getElementById('nb-close').onclick = () => box.classList.add('hidden');
}

/* ---------- Tareas por Flujo (pie) ---------- */
function renderDemandPie(){
  const flows = selectedFlows();
  const css = (v)=> getComputedStyle(document.body).getPropertyValue(v).trim();
  const colorsVars = {
    demanda: css('--pie1')||PALETTE.c0,
    enhancement: css('--pie2')||PALETTE.c4,
    creacion: css('--pie3')||PALETTE.c3,
    merge1: css('--pie4')||PALETTE.c6,
    merge2: css('--pie5')||PALETTE.c7,
    outsiders: css('--pie6')||PALETTE.c8,
    adhoc: css('--pie7')||PALETTE.c9
  };

  const labels=[]; const values=[]; const colors=[];
  function push(flowKey, value){ labels.push(flowTitle(flowKey)); values.push(value); colors.push(colorsVars[flowKey]); }

  if(flows.has('demanda'))     push('demanda',     currentData.reduce((s,r)=> s + (r.tareas_demanda||0), 0));
  if(flows.has('enhancement')) push('enhancement', currentData.reduce((s,r)=> s + (r.tareas_enhancement||0), 0));

  const sumKV = (k)=> currentData.filter(r=>r.equipo==='KV' && r.flujo===k).reduce((s,r)=> s + (r.total_tareas||0), 0);
  ['outsiders','creacion','merge1','merge2','adhoc'].forEach(k=>{ if(flows.has(k)) push(k, sumKV(k)); });

  const tot = values.reduce((a,b)=>a+b,0);

  createOrUpdateChart('demandPieChart',{
    type:'pie',
    data:{ labels, datasets:[{ data: values, backgroundColor: colors }] },
    options:{
      responsive:true,
      plugins:{
        legend:{
          position:'bottom',
          labels:{
            generateLabels:(chart)=> chart.data.labels.map((lbl,i)=>{
              const ds=chart.data.datasets[0]; const v=ds.data[i]; const p = tot? (100*v/tot) : 0;
              return { text: `${lbl} (${fmt.int(v)} · ${p.toFixed(1)}%)`, fillStyle: ds.backgroundColor[i], strokeStyle: ds.backgroundColor[i], lineWidth:1, index:i };
            })
          }
        },
        tooltip:{ callbacks:{ label:(ctx)=> `${ctx.label}: ${fmt.int(ctx.parsed)} (${(tot? (100*ctx.parsed/tot):0).toFixed(1)}%)` } }
      }
    }
  });

  const pairs = labels.map((l,i)=>`${l}: ${fmt.int(values[i])}`).join(' | ');
  document.getElementById('demandTotals').textContent = `Total Tareas: ${fmt.int(tot)} — ${pairs}`;
}

/* ---------- Detalle por usuario ---------- */
function renderTasksByUser(){
  const flows = selectedFlows();
  const agg = new Map(); // user -> {num,den, effNum, effDen}
  currentData.forEach(r=>{
    const u=r.usuario; const o=agg.get(u)||{num:0,den:0,effNum:0,effDen:0};
    o.num += tareasByFlows(r,flows); o.den += (r.dias_activos||0);
    if(r.efectividad!=='' && r.efectividad!==null && r.efectividad!==undefined){
      const w=(r.correcciones_auditadas||0)||1;
      o.effNum += r.efectividad*w; o.effDen += w;
    }
    agg.set(u,o);
  });

  const arr = Array.from(agg.entries()).map(([u,o])=>{
    const prom = o.den? o.num/o.den : 0;
    const effPct = o.effDen? (100*o.effNum/o.effDen) : null;
    return { user:u, prom, effPct };
  }).sort((a,b)=>b.prom-a.prom);

  createOrUpdateChart('tasksByUserChart',{
    data:{ labels:arr.map(x=>x.user), datasets:[ barDataset('Prom. diario', arr.map(x=>x.prom)), lineEffDataset('% Efectividad', arr.map(x=>x.effPct)) ] },
    options:{
      responsive:true,
      scales:{
        y:{ position:'left', ticks:{ callback:v=>Number(v).toLocaleString('es-AR',{minimumFractionDigits:2,maximumFractionDigits:2}) } },
        y1:{ position:'right', grid:{ drawOnChartArea:false }, ticks:{ callback:v=>`${v.toFixed(0)}%` }, suggestedMin: 50, suggestedMax: 100 },
        x:{ ticks:{ autoSkip:false, maxRotation:60, minRotation:45 } }
      }
    }
  });
}

/* ---------- Comparativa por líder ---------- */
function renderTasksByLeader(){
  const flows = selectedFlows();
  const agg = new Map(); // líder -> {num,den, effNum, effDen}
  currentData.forEach(r=>{
    const l = r['líder']; if(!l || String(l).toLowerCase().startsWith('sin ')) return;
    const o = agg.get(l) || {num:0,den:0,effNum:0,effDen:0};
    o.num += tareasByFlows(r,flows);
    o.den += (r.dias_activos||0);
    if(r.efectividad!=='' && r.efectividad!==null && r.efectividad!==undefined){
      const w = (r.correcciones_auditadas || 0) || 1;
      o.effNum += r.efectividad * w;
      o.effDen += w;
    }
    agg.set(l,o);
  });
  const arr = Array.from(agg.entries()).map(([l,o])=>{
    const prom = o.den? o.num/o.den : 0;
    const effPct = o.effDen? (100*o.effNum/o.effDen) : null;
    return { lider:l, prom, effPct };
  }).sort((a,b)=>b.prom-a.prom);

  createOrUpdateChart('tasksByLeaderChart',{
    data:{ labels:arr.map(x=>x.lider), datasets:[ barDataset('Prom. diario', arr.map(x=>x.prom)), lineEffDataset('% Efectividad', arr.map(x=>x.effPct)) ] },
    options:{
      responsive:true,
      scales:{
        y:{ position:'left', ticks:{ callback:v=>Number(v).toLocaleString('es-AR',{minimumFractionDigits:2,maximumFractionDigits:2}) } },
        y1:{ position:'right', grid:{ drawOnChartArea:false }, ticks:{ callback:v=>`${v.toFixed(0)}%` }, suggestedMin: 50, suggestedMax: 100 },
        x:{ ticks:{ autoSkip:false, maxRotation:45 } }
      }
    }
  });
}

/* ---------- Evolución semanal ---------- */
function renderWeeklyEvolution(){
  const flows = selectedFlows();
  const agg = new Map(); // week -> {num,den, effNum, effDen}
  currentData.forEach(r=>{
    const w = Number(r.week); if(!Number.isFinite(w)) return;
    const o = agg.get(w)||{num:0,den:0,effNum:0,effDen:0};
    o.num += tareasByFlows(r,flows);
    o.den += (r.dias_activos||0);
    if(r.efectividad!=='' && r.efectividad!==null && r.efectividad!==undefined){
      const weight = (r.correcciones_auditadas||0)||1;
      o.effNum += r.efectividad*weight;
      o.effDen += weight;
    }
    agg.set(w,o);
  });

  const weeks = Array.from(agg.keys());
  if(!weeks.length){ createOrUpdateChart('weeklyEvolutionChart',{type:'line',data:{labels:[],datasets:[]},options:{}}); return; }
  const minW=Math.min(...weeks), maxW=Math.max(...weeks);
  const labels=[], promValues=[], effValues=[];
  for(let w=minW; w<=maxW; w++){
    labels.push('W'+String(w).padStart(2,'0'));
    const o=agg.get(w)||{num:0,den:0,effNum:0,effDen:0};
    promValues.push((o.den? o.num/o.den : 0));
    effValues.push(o.effDen? 100*o.effNum/o.effDen : null);
  }
  createOrUpdateChart('weeklyEvolutionChart',{
    data:{ labels, datasets:[ barDataset('Prom. diario', promValues), lineEffDataset('% Efectividad', effValues) ] },
    options:{
      responsive:true,
      plugins:{ legend:{display:true} },
      scales:{
        x:{ ticks:{autoSkip:false,maxRotation:0} },
        y:{ position:'left', ticks:{ callback:v=>Number(v).toLocaleString('es-AR',{minimumFractionDigits:2,maximumFractionDigits:2}) } },
        y1:{ position:'right', grid:{ drawOnChartArea:false }, ticks:{ callback:v=>`${v.toFixed(0)}%` }, suggestedMin: 50, suggestedMax: 100 }
      }
    }
  });
}

/* ---------- Ubicación (comparativo y evolutivo) ---------- */
function renderByLocation(){
  const flows = selectedFlows();
  const byLoc = new Map();  // ciudad -> {num,den}
  const effLoc = new Map(); // ciudad -> {num,den}
  const antig = {};
  currentData.forEach(r=>{
    const c=r.ciudad||'Sin ubicación';
    const o=byLoc.get(c)||{num:0,den:0};
    o.num += tareasByFlows(r,flows); o.den += (r.dias_activos||0); byLoc.set(c,o);

    if(r.efectividad!=='' && r.efectividad!==null && r.efectividad!==undefined){
      const w=(r.correcciones_auditadas||0)||1;
      const e=effLoc.get(c)||{num:0,den:0};
      e.num += r.efectividad*w; e.den += w; effLoc.set(c,e);
    }
    const a = Number(r.antigüedad||0); if(!antig[c]) antig[c]={sum:0,n:0}; if(Number.isFinite(a)){ antig[c].sum+=a; antig[c].n++; }
  });

  const labels = Array.from(byLoc.keys()).sort((a,b)=>{
    const va=(byLoc.get(a).den? byLoc.get(a).num/byLoc.get(a).den : 0);
    const vb=(byLoc.get(b).den? byLoc.get(b).num/byLoc.get(b).den : 0);
    return vb-va;
  });

  const promData = labels.map(c=>{ const o=byLoc.get(c); return (o.den? o.num/o.den : 0); });
  const effData  = labels.map(c=>{ const e=effLoc.get(c)||{num:0,den:0}; return e.den? 100*e.num/e.den : null; });

  createOrUpdateChart('locCombinedChart',{
    data:{ labels, datasets:[ barDataset('Prom. diario', promData), lineEffDataset('% Efectividad', effData) ] },
    options:{
      responsive:true,
      scales:{ y:{ position:'left', ticks:{ callback:v=>Number(v).toLocaleString('es-AR',{minimumFractionDigits:2,maximumFractionDigits:2}) } }, y1:{ position:'right', grid:{ drawOnChartArea:false }, ticks:{ callback:v=>`${v.toFixed(0)}%` }, suggestedMin: 50, suggestedMax: 100 }, x:{ ticks:{ autoSkip:false } } },
      plugins:{ legend:{display:true} }
    }
  });

  const list = labels.map(loc=>{ const v=antig[loc]||{sum:0,n:0}; const avg=v.n? v.sum/v.n : 0; return [loc, avg]; }).sort((a,b)=>b[1]-a[1]);
  const grid = document.getElementById('avg-antiguedad-cards');
  grid.innerHTML = list.map(([loc,avg])=>`<div class="kpi-card"><div class="flex items-baseline justify-between"><div class="kpi-title">${loc}</div><div class="kpi-value">${fmt.dec(avg)}</div></div></div>`).join('');
}
function renderLocationTimeline(){
  const flows = selectedFlows();
  const byWeekCity = new Map(); // week -> city -> {num, den}
  currentData.forEach(r=>{
    const w = Number(r.week); if(!Number.isFinite(w)) return;
    const c = r.ciudad || 'Sin ubicación';
    const wk = byWeekCity.get(w) || new Map();
    const o = wk.get(c) || {num:0, den:0};
    o.num += tareasByFlows(r,flows);
    o.den += (r.dias_activos||0);
    wk.set(c,o); byWeekCity.set(w, wk);
  });

  const weeks = Array.from(byWeekCity.keys()).sort((a,b)=>a-b);
  if(!weeks.length){ createOrUpdateChart('locTimeChart',{type:'line',data:{labels:[],datasets:[]},options:{}}); return; }

  const totalsByCity = new Map();
  byWeekCity.forEach((wk)=> wk.forEach((o,city)=> totalsByCity.set(city, (totalsByCity.get(city)||0)+o.num)));
  const topCities = Array.from(totalsByCity.entries()).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([city])=>city);

  const labels = weeks.map(w=>'W'+String(w).padStart(2,'0'));
  const colors = [PALETTE.c2, PALETTE.c4, PALETTE.c1, PALETTE.c0, PALETTE.c6];
  const datasets = topCities.map((city,idx)=>{
    const data = weeks.map(w=>{
      const wk = byWeekCity.get(w)||new Map();
      const o = wk.get(city)||{num:0,den:0};
      return o.den ? (o.num/o.den) : null;
    });
    return lineDataset(city, data, colors[idx%colors.length], 'y');
  });

  createOrUpdateChart('locTimeChart',{
    data:{ labels, datasets },
    options:{ responsive:true, plugins:{ legend:{ position:'bottom'} }, scales:{ y:{ position:'left', ticks:{ callback:v=>Number(v).toLocaleString('es-AR',{minimumFractionDigits:2,maximumFractionDigits:2}) } }, x:{ ticks:{ autoSkip:false, maxRotation:0 } } } }
  });
}

/**********************
 * EXPORTS
 **********************/
function getActiveSectionId(){ const sec=[...document.querySelectorAll('.page-section')].find(s=>!s.classList.contains('hidden')); return sec ? sec.id : 'resumen'; }
function download(filename, blob){ saveAs(blob, filename); }
async function exportSectionPNGs(){
  const id=getActiveSectionId();
  const canvases=[];
  if(id==='resumen'){
    canvases.push(document.getElementById('demandPieChart'));
    const el=document.getElementById('ninebox-card');
    const canvas = await html2canvas(el,{scale:2,backgroundColor:null});
    canvas.toBlob(b=>download('productividad-calidad.png',b));
  }else if(id==='detalle'){ canvases.push(document.getElementById('tasksByUserChart'));
  }else if(id==='lideres'){ canvases.push(document.getElementById('tasksByLeaderChart'));
  }else if(id==='evolucion'){ canvases.push(document.getElementById('weeklyEvolutionChart'));
  }else if(id==='ubicacion'){ canvases.push(document.getElementById('locCombinedChart')); canvases.push(document.getElementById('locTimeChart')); }
  canvases.forEach((c,i)=>{ if(!c) return; const url=c.toDataURL('image/png'); fetch(url).then(r=>r.blob()).then(b=>download(`${id}-chart${i+1}.png`, b)); });
}
async function sendSectionToGoogleSheets(){
  const section = getActiveSectionId();
  const flows = Array.from(selectedFlows());
  const payload = { section, filters:{...state.filtros}, generatedAt:new Date().toISOString(), data: buildSectionDataForExport(section, flows) };
  try{
    const r = await fetch(SHEETS_WEB_APP, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload), mode:'cors' });
    if(!r.ok) throw new Error(`HTTP ${r.status}`); alert('✅ Enviado a Google Sheets');
  }catch(e){ alert('❌ No pude enviar a Google Sheets: ' + e.message); }
}
function buildSectionDataForExport(section, flows){
  if(section==='resumen'){
    const rows=[];
    const add=(key, total)=>{ if(flows.includes(key)) rows.push({ Flujo: flowTitle(key), Total: total }); };
    add('demanda',     currentData.reduce((s,r)=> s + (r.tareas_demanda||0), 0));
    add('enhancement', currentData.reduce((s,r)=> s + (r.tareas_enhancement||0), 0));
    const sumKV = (k)=> currentData.filter(r=>r.equipo==='KV' && r.flujo===k).reduce((s,r)=> s + (r.total_tareas||0), 0);
    ['outsiders','creacion','merge1','merge2','adhoc'].forEach(k=> add(k, sumKV(k)));
    return rows;
  }
  if(section==='detalle'){
    const agg = new Map();
    currentData.forEach(r=>{ const u=r.usuario; const o=agg.get(u)||{num:0,den:0}; o.num += tareasByFlows(r); o.den += (r.dias_activos||0); agg.set(u,o); });
    return Array.from(agg.entries()).map(([user,o])=>({Usuario:user, Promedio:o.den?o.num/o.den:0}));
  }
  return currentData;
}

/**********************
 * GEMINI (opcional)
 **********************/
function filtersSummary() {
  const f = state.filtros;
  const flows = (f.flujo.length===0) ? 'Todos' : f.flujo.map(flowTitle).join(' + ');
  return { Equipo: f.equipo.join(' | ') || '', Trimestre: f.q.join(' | ') || '', Mes: f.mes.join(' | ') || '', Semana: f.semana.join(' | ') || '', Ubicacion: f.ubic.join(' | ') || '', Lider: f.lider.join(' | ') || '', Usuario: f.usuario.join(' | ') || '', Flujo: flows };
}
function buildNineboxPrompt(){
  const filtros_activos = JSON.stringify(filtersSummary());
  const total_tareas = currentData.reduce((s,r)=>s+tareasByFlows(r),0);
  const promedio = promedioDiario(currentData).toFixed(2);
  const efVals= currentData.map(r=>r.efectividad).filter(v=>v!==''&&v!=null);
  const efectividad = (efVals.length? (100*efVals.reduce((a,b)=>a+b,0)/efVals.length) : 0).toFixed(2);

  const prodBand=p=>(p>=80?'Alta':p>=70?'Media':'Baja'); const calBand=e=>(e>=0.90?'Alta':e>=0.75?'Media':'Baja');
  const buckets = { 'Prod Alta / Cal Alta':0,'Prod Alta / Cal Media':0,'Prod Alta / Cal Baja':0,'Prod Media / Cal Alta':0,'Prod Media / Cal Media':0,'Prod Media / Cal Baja':0,'Prod Baja / Cal Alta':0,'Prod Baja / Cal Media':0,'Prod Baja / Cal Baja':0 };
  const map=new Map();
  currentData.forEach(r=>{
    const u=r.usuario; const o=map.get(u)||{num:0,den:0,effSum:0,effN:0};
    o.num += tareasByFlows(r); o.den += (r.dias_activos||0);
    if(r.efectividad!=='' && r.efectividad!=null){ o.effSum+=r.efectividad; o.effN++; }
    map.set(u,o);
  });
  Array.from(map.values()).forEach(o=>{
    const prom = o.den?o.num/o.den:null, eff=o.effN?o.effSum/o.effN:null;
    if(prom==null||eff==null) return;
    buckets[`Prod ${prodBand(prom)} / Cal ${calBand(eff)}`]++;
  });
  const distrib = Object.entries(buckets).map(([k,v])=>`• ${k}: ${v}`).join('\n');

  return `🔹 Análisis Nine-box (Productividad x Calidad)
Filtros: ${filtros_activos}
KPIs: Total=${total_tareas} | Promedio=${promedio} | Efectividad=${efectividad}%

Distribución:
${distrib}

Instrucciones:
1) Lista 4–6 hallazgos accionables (sin inventar).
2) 3 acciones concretas para perfiles fuera de target (BTC, 1:1, checklist, acompañamiento, plan 3 semanas).
3) Diferenciar qué hacer en Prod Alta/Cal Baja vs Prod Baja/Cal Alta.
Formato bullets.`;
}
function buildGlobalInsightsPrompt(){
  const f = JSON.stringify(filtersSummary());
  const usuarios = new Set(currentData.map(r=>r.usuario)).size;
  const ids = currentData.reduce((s,r)=>s+(r.ids_trabajados||0),0);
  const prom = promedioDiario(currentData).toFixed(2);
  const efVals= currentData.map(r=>r.efectividad).filter(v=>v!==''&&v!=null);
  const ef = (efVals.length? (100*efVals.reduce((a,b)=>a+b,0)/efVals.length) : 0).toFixed(2);
  return `🔹 Análisis Global
Filtros: ${f}
Usuarios=${usuarios} | IDs=${ids} | Promedio=${prom} | Efectividad=${ef}%

Necesito:
• 4 bullets: qué va bien / qué mejorar (con datos)
• Detectar perfiles LOW (ocasional vs recurrente)
• 3–5 acciones (BTC con casos, 1:1 por error, checklist, plan 3 semanas, acompañamiento)
Formato conciso, sin generalidades.`;
}
async function geminiRequest(prompt) {
  if (!GEMINI_PROXY_URL) return "Configura GEMINI_PROXY_URL.";
  const attempts = [{ prompt: String(prompt) }, { contents: [{ parts: [{ text: String(prompt) }]}] }];
  let lastErr;
  for (const body of attempts) {
    try {
      const r = await fetch(GEMINI_PROXY_URL, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(body) });
      const raw = await r.text();
      if (!r.ok) throw new Error(raw || `HTTP ${r.status}`);
      let data; try { data = JSON.parse(raw); } catch { return raw; }
      const out = data?.candidates?.[0]?.content?.parts?.[0]?.text ?? data?.text ?? data?.output ?? data;
      return (typeof out === 'string') ? out : JSON.stringify(out);
    } catch (e) { lastErr = e; }
  }
  throw lastErr || new Error('Gemini request failed');
}
function setupGeminiFeatures(){
  document.getElementById('generate-summary-btn').addEventListener('click', async ()=>{
    const block = document.getElementById('ninebox-missing');
    block.classList.remove('hidden'); block.innerHTML = 'Generando…';
    try{ const resp = await geminiRequest(buildNineboxPrompt()); block.innerHTML = resp; }
    catch(e){ block.textContent = e.message; }
  });

  document.getElementById('generate-insights-btn').addEventListener('click', async ()=>{
    const out = document.getElementById('insights-output');
    out.classList.remove('hidden'); out.innerHTML = 'Analizando…';
    try{ const resp = await geminiRequest(buildGlobalInsightsPrompt()); out.innerHTML = resp; }
    catch(e){ out.textContent = e.message; }
  });
}

/**********************
 * INIT
 **********************/
document.addEventListener('DOMContentLoaded', async ()=>{
  try{
    // Helper: intenta; si falla, devuelve string vacío
    const tryFetch = async (file) => {
      try { return await fetchCSVFile(file); } catch { return ''; }
    };

    // Traigo todo (algunos pueden no existir)
    const [tProdPM,tCalPM,tBase,tLids,tKvProd,tKvQCrea,tKvQMerge] = await Promise.all([
      tryFetch(FILES_PM.productividad),
      tryFetch(FILES_PM.calidad),
      tryFetch(FILES_PM.base),
      tryFetch(FILES_PM.lideres),
      fetchCSVFile(FILES_KV.productividad),   // este sí es requerido
      tryFetch(FILES_KV.calidad_crea),
      tryFetch(FILES_KV.calidad_merge)
    ]);

    const prodPM = tProdPM ? parseCSV(tProdPM) : [];
    const calPM  = tCalPM  ? parseCSV(tCalPM)  : [];
    const base   = tBase   ? parseCSV(tBase)   : [];
    const lids   = tLids   ? parseCSV(tLids)   : [];
    const leadersMap = buildLeadersMap(lids);

    const kvProd   = parseCSV(tKvProd);
    const kvQCrea  = tKvQCrea  ? parseCSV(tKvQCrea)  : [];
    const kvQMerge = tKvQMerge ? parseCSV(tKvQMerge) : [];

    const pmRows = (prodPM.length && calPM.length && base.length)
      ? buildPMRows(prodPM, calPM, base, leadersMap)
      : [];
    const kvRows = buildKVRows(kvProd, kvQCrea, kvQMerge, leadersMap);

    originalData = [...pmRows, ...kvRows];

    renderFiltersBar();
    setupNavigation();
    setupGeminiFeatures();

    currentData = originalData.slice();
    applyFilters();
  }catch(err){
    console.error(err);
    document.body.innerHTML = `<div class="p-8 text-center text-red-600" style="background:#fee2e2">${err.message}</div>`;
  }
});

</script>
</body>
</html>





