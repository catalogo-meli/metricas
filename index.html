<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard de Productividad con IA</title>

  <!-- UI & Charts -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .sidebar-link { transition: all 0.2s ease-in-out; }
    .sidebar-link:hover, .sidebar-link.active {
      background-color: #0369a1; color: #fff; transform: translateX(4px);
    }
    .kpi-card {
      background-color: #fff; border-radius: 0.75rem; padding: 1.5rem;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .kpi-card:hover { transform: translateY(-4px);
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
    .chart-container { height: 400px; }
    #mobile-menu { transition: transform 0.3s ease-in-out; }
    .prose { line-height: 1.6; }
    .prose strong { color: #0f172a; }
    .prose li { margin-top: 0.5rem; }
  </style>
</head>

<body class="bg-slate-100 text-slate-800">
  <div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside id="sidebar" class="hidden md:flex w-64 flex-col bg-sky-800 text-sky-100 p-4 transition-all duration-300">
      <div class="flex items-center mb-8">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3 text-white" viewBox="0 0 20 20" fill="currentColor">
          <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>
        </svg>
        <h1 class="text-2xl font-bold text-white">Dashboard</h1>
      </div>
      <nav id="nav-menu" class="flex-1 space-y-2">
        <a href="#resumen" class="sidebar-link active flex items-center p-3 rounded-lg">Resumen General</a>
        <a href="#productividad" class="sidebar-link flex items-center p-3 rounded-lg">Productividad por Usuario</a>
        <a href="#lideres" class="sidebar-link flex items-center p-3 rounded-lg">Comparativa de Líderes</a>
        <a href="#evolucion" class="sidebar-link flex items-center p-3 rounded-lg">Evolución Semanal</a>
        <a href="#ubicacion" class="sidebar-link flex items-center p-3 rounded-lg">Análisis por Ubicación</a>
        <a href="#proyecciones" class="sidebar-link flex items-center p-3 rounded-lg">Proyecciones</a>
        <a href="#analisis" class="sidebar-link flex items-center p-3 rounded-lg">Análisis Inteligente</a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-x-hidden overflow-y-auto bg-slate-100">
      <div class="container mx-auto px-6 py-8">
        <!-- Header y Menú Móvil -->
        <div class="flex justify-between items-center mb-6">
          <button id="mobile-menu-button" class="md:hidden text-slate-600">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
          </button>
          <h2 id="page-title" class="text-3xl font-bold text-slate-700">Resumen General</h2>
        </div>

        <!-- Filters -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
          <select id="filter-mes" class="w-full p-2 border rounded-md bg-white shadow-sm"></select>
          <select id="filter-semana" class="w-full p-2 border rounded-md bg-white shadow-sm"></select>
          <select id="filter-lider" class="w-full p-2 border rounded-md bg-white shadow-sm"></select>
          <select id="filter-ubicacion" class="w-full p-2 border rounded-md bg-white shadow-sm"></select>
        </div>

        <!-- Dashboard Sections -->
        <div id="dashboard-content">
          <!-- Resumen General -->
          <section id="resumen" class="page-section">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
              <div class="kpi-card text-center">
                <h3 class="text-slate-500 font-medium">Total Tareas</h3>
                <p id="kpi-total-tareas" class="text-4xl font-bold mt-2"></p>
              </div>
              <div class="kpi-card text-center">
                <h3 class="text-slate-500 font-medium">% Efectividad Prom.</h3>
                <p id="kpi-efectividad-prom" class="text-4xl font-bold mt-2 text-green-600"></p>
              </div>
              <div class="kpi-card text-center">
                <h3 class="text-slate-500 font-medium">Correcciones Totales</h3>
                <p id="kpi-correcciones" class="text-4xl font-bold mt-2 text-amber-600"></p>
              </div>
              <div class="kpi-card text-center">
                <h3 class="text-slate-500 font-medium">Usuarios Activos</h3>
                <p id="kpi-usuarios" class="text-4xl font-bold mt-2"></p>
              </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div class="kpi-card">
                <div class="flex justify-between items-center mb-4">
                  <h3 class="text-xl font-semibold">Top 10 Usuarios por Tareas</h3>
                </div>
                <div class="chart-container"><canvas id="tasksByUserChart"></canvas></div>
              </div>
              <div class="kpi-card">
                <h3 class="text-xl font-semibold mb-4">Tareas: Demanda vs. Enhancement</h3>
                <div class="chart-container relative mx-auto" style="height:300px;width:100%;max-width:360px">
                  <canvas id="demandPieChart"></canvas>
                </div>
              </div>
            </div>
          </section>

          <!-- Productividad por Usuario -->
          <section id="productividad" class="page-section hidden">
            <div class="kpi-card">
              <h3 class="text-xl font-semibold mb-4">Detalle de Productividad (selección futura)</h3>
              <div class="chart-container"><canvas id="userDetailChart"></canvas></div>
            </div>
          </section>

          <!-- Comparativa de Líderes -->
          <section id="lideres" class="page-section hidden">
            <div class="kpi-card">
              <h3 class="text-xl font-semibold mb-4">Comparativa por Líder (placeholder)</h3>
              <div class="chart-container"><canvas id="tasksByLeaderChart"></canvas></div>
            </div>
          </section>

          <!-- Evolución Semanal -->
          <section id="evolucion" class="page-section hidden">
            <div class="kpi-card">
              <h3 class="text-xl font-semibold mb-4">Evolución Semanal (placeholder)</h3>
              <div class="chart-container"><canvas id="weeklyEvolutionChart"></canvas></div>
            </div>
          </section>

          <!-- Análisis por Ubicación -->
          <section id="ubicacion" class="page-section hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div class="kpi-card">
                <h3 class="text-xl font-semibold mb-4">Total de Tareas por Ubicación</h3>
                <div class="chart-container"><canvas id="tasksByLocationChart"></canvas></div>
              </div>
              <div class="kpi-card">
                <h3 class="text-xl font-semibold mb-4">Antigüedad Promedio por Ubicación (meses)</h3>
                <div id="avg-antiguedad-list"></div>
              </div>
            </div>
          </section>

          <!-- Proyecciones -->
          <section id="proyecciones" class="page-section hidden">
            <div class="kpi-card">
              <h3 class="text-xl font-semibold mb-4">Proyección de Tareas Totales (placeholder)</h3>
              <div class="chart-container"><canvas id="projectionsChart"></canvas></div>
            </div>
          </section>

          <!-- Análisis Inteligente -->
          <section id="analisis" class="page-section hidden">
            <div class="kpi-card">
              <h3 class="text-xl font-semibold mb-2">Análisis Inteligente (placeholder)</h3>
              <p class="text-slate-600">Acá se engancha Gemini luego.</p>
            </div>
          </section>
        </div>
      </div>
    </main>
  </div>

  <!-- Menú móvil -->
  <div id="mobile-menu" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden">
    <aside class="absolute top-0 left-0 h-full w-64 bg-sky-800 text-sky-100 p-4 transform -translate-x-full transition-transform duration-300">
      <div class="flex justify-between items-center mb-8">
        <h1 class="text-2xl font-bold text-white">Menú</h1>
        <button id="close-mobile-menu">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <nav id="mobile-nav-menu" class="flex-1 space-y-2"></nav>
    </aside>
  </div>

  <!-- PapaParse para CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- App script: carga CSV + dashboard -->
  <script>
    // ====== Estado global ======
    let originalData = [];
    let charts = {};

    // ====== Normalización ======
    const removeAccents = s => s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    const normKey = s => removeAccents(String(s).toLowerCase().trim().replace(/\s+/g,' ').replace(/[^\w %/()-]/g,''));

    function normalizeValue(v) {
      if (v === null || v === undefined) return v;
      if (typeof v !== 'string') return v;
      const t = v.trim();
      const isPercent = t.endsWith('%');
      const cleaned = t.replace('%','').replace(/\./g,'').replace(',','.');
      const n = Number(cleaned);
      if (Number.isFinite(n)) return isPercent ? n/100 : n;
      return t;
    }

    function parseCSV(text) {
      const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
      return parsed.data.map(row => {
        const out = {};
        for (const [k, v] of Object.entries(row)) out[k] = normalizeValue(v);
        return out;
      });
    }

    // ====== Detección flexible de columnas ======
    function buildColumnMap(rows) {
      const headers = Object.keys(rows[0] || {});
      const map = {};
      const want = {
        mes: ['mes'],
        semana: ['semana'],
        usuario: ['usuario','agente','user'],
        efectividad: ['% de efectividad','efectividad','porcentaje efectividad','efectividad %'],
        prom_diario: ['promedio diario','promedio','promedio_diario'],
        tareas_demanda: ['tareas demanda','demanda','cantidad demanda'],
        tareas_enh: ['tareas enhancement','enhancement','cantidad enhancement','enhanced'],
        pct_demanda: ['% demanda','porcentaje demanda'],
        pct_enh: ['% enhancement','porcentaje enhancement'],
        total_tareas: ['total tareas','tareas totales','total'],
        ids_trab: ['ids trabajados','ids','ids_trabajados'],
        correcciones: ['correcciones auditadas','correcciones','auditorias','auditadas'],
        lider: ['líder','lider','team leader','tl','leader'],
        antiguedad: ['antigüedad (meses)','antiguedad','antiguedad meses'],
        ubicacion: ['ubicación','ubicacion','site','sede','location']
      };
      // índice normalizado
      const idx = {};
      headers.forEach(h => idx[normKey(h)] = h);

      const findCol = candidates => {
        for (const c of candidates) {
          const nk = normKey(c);
          // match exacto de la lista
          if (idx[nk]) return idx[nk];
          // búsqueda laxa: contiene palabra clave
          const hit = headers.find(h => normKey(h).includes(nk));
          if (hit) return hit;
        }
        return null;
      };

      for (const key of Object.keys(want)) {
        map[key] = findCol(want[key]);
      }
      return map;
    }

    // ====== Helpers ======
    const uniq = arr => Array.from(new Set(arr.filter(x => x !== '' && x != null)));
    const sum = arr => arr.reduce((a,b) => a + (Number(b)||0), 0);
    const avg = arr => arr.length ? sum(arr)/arr.length : 0;

    function getValue(row, colName) {
      return colName ? row[colName] : undefined;
    }

    // ====== Filtros ======
    function setupFilters(data, col) {
      const q = (id) => document.getElementById(id);

      const mes = uniq(data.map(r => getValue(r, col.mes))).sort();
      const semana = uniq(data.map(r => getValue(r, col.semana))).sort((a,b)=> (a||0)-(b||0));
      const lider = uniq(data.map(r => getValue(r, col.lider))).sort();
      const ubic = uniq(data.map(r => getValue(r, col.ubicacion))).sort();

      const fill = (sel, values, label) => {
        sel.innerHTML = '';
        const optAll = document.createElement('option');
        optAll.value = ''; optAll.textContent = `Todos ${label||''}`.trim();
        sel.appendChild(optAll);
        values.forEach(v => {
          const o = document.createElement('option');
          o.value = v; o.textContent = v;
          sel.appendChild(o);
        });
      };

      fill(q('filter-mes'), mes, 'los meses');
      fill(q('filter-semana'), semana, 'las semanas');
      fill(q('filter-lider'), lider, 'los líderes');
      fill(q('filter-ubicacion'), ubic, 'las ubicaciones');

      ['filter-mes','filter-semana','filter-lider','filter-ubicacion'].forEach(id => {
        q(id).addEventListener('change', applyFilters);
      });
    }

    function getActiveFilters() {
      const v = id => document.getElementById(id).value;
      return {
        mes: v('filter-mes') || null,
        semana: v('filter-semana') || null,
        lider: v('filter-lider') || null,
        ubicacion: v('filter-ubicacion') || null,
      };
    }

    // ====== Charts ======
    function createOrUpdateChart(id, type, data, options) {
      const ctx = document.getElementById(id);
      if (!ctx) return;
      if (charts[id]) charts[id].destroy();
      charts[id] = new Chart(ctx, { type, data, options });
    }

    // ====== Render principal ======
    let COL = {};

    function applyFilters() {
      if (!originalData.length) return;
      if (!COL.total_tareas && !(COL.tareas_demanda || COL.tareas_enh)) {
        console.warn('No se detectó columna de Total Tareas ni Demanda/Enhancement. KPIs limitados.');
      }

      const f = getActiveFilters();
      const rows = originalData.filter(r => {
        const okMes = !f.mes || getValue(r, COL.mes) == f.mes;
        const okSem = !f.semana || getValue(r, COL.semana) == f.semana;
        const okLid = !f.lider || getValue(r, COL.lider) == f.lider;
        const okUbi = !f.ubicacion || getValue(r, COL.ubicacion) == f.ubicacion;
        return okMes && okSem && okLid && okUbi;
      });

      // KPIs
      const totalTareas = COL.total_tareas
        ? sum(rows.map(r => getValue(r, COL.total_tareas)))
        : sum(rows.map(r => (getValue(r, COL.tareas_demanda)||0) + (getValue(r, COL.tareas_enh)||0)));

      const efectProm = COL.efectividad ? (avg(rows.map(r => getValue(r, COL.efectividad))) * 100) : null;
      const correcciones = COL.correcciones ? sum(rows.map(r => getValue(r, COL.correcciones))) : 0;
      const usuariosActivos = COL.usuario ? uniq(rows.map(r => getValue(r, COL.usuario))).length : 0;

      document.getElementById('kpi-total-tareas').textContent = totalTareas.toLocaleString('es-AR');
      document.getElementById('kpi-efectividad-prom').textContent = (efectProm != null) ? (efectProm.toFixed(2) + '%') : '—';
      document.getElementById('kpi-correcciones').textContent = correcciones.toLocaleString('es-AR');
      document.getElementById('kpi-usuarios').textContent = usuariosActivos.toLocaleString('es-AR');

      // Pie Demanda vs Enhancement
      const totDem = sum(rows.map(r => getValue(r, COL.tareas_demanda)));
      const totEnh = sum(rows.map(r => getValue(r, COL.tareas_enh)));
      createOrUpdateChart('demandPieChart', 'pie', {
        labels: ['Demanda', 'Enhancement'],
        datasets: [{ data: [totDem, totEnh] }]
      }, { responsive: true });

      // Barras por usuario (Top 10)
      const byUser = {};
      rows.forEach(r => {
        const u = getValue(r, COL.usuario) || '—';
        const t = COL.total_tareas
          ? (getValue(r, COL.total_tareas) || 0)
          : (getValue(r, COL.tareas_demanda)||0) + (getValue(r, COL.tareas_enh)||0);
        byUser[u] = (byUser[u] || 0) + t;
      });
      const ranked = Object.entries(byUser).sort((a,b)=>b[1]-a[1]).slice(0,10);
      createOrUpdateChart('tasksByUserChart', 'bar', {
        labels: ranked.map(x => x[0]),
        datasets: [{ label: 'Tareas', data: ranked.map(x => x[1]) }]
      }, {
        responsive: true,
        plugins: { legend: { display:false } },
        scales: { y: { beginAtZero: true } }
      });
    }

    // ====== Navegación simple (mostrar/ocultar secciones) ======
    function setupNavigation() {
      const links = document.querySelectorAll('#nav-menu a');
      const sections = document.querySelectorAll('.page-section');
      links.forEach(link => {
        link.addEventListener('click', e => {
          e.preventDefault();
          links.forEach(l => l.classList.remove('active'));
          link.classList.add('active');
          sections.forEach(s => s.classList.add('hidden'));
          const target = document.querySelector(link.getAttribute('href'));
          if (target) target.classList.remove('hidden');
          document.getElementById('page-title').textContent = link.textContent.trim();
        });
      });
    }

    // ====== Carga robusta del CSV ======
    async function fetchCSV() {
      const rel = './datos.csv?v=' + Date.now();          // relativo (funciona en Pages)
      const base = '/metricas/datos.csv?v=' + Date.now(); // base del project page
      const raw  = 'https://raw.githubusercontent.com/catalogo-meli/metricas/main/datos.csv?v=' + Date.now();

      let resp = await fetch(rel, { cache: 'no-store' });
      if (!resp.ok) resp = await fetch(base, { cache: 'no-store' });
      if (!resp.ok) resp = await fetch(raw, { cache: 'no-store' });
      if (!resp.ok) throw new Error('No pude cargar datos.csv. HTTP ' + resp.status);
      return resp.text();
    }

    // ====== INIT ÚNICO ======
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        setupNavigation(); // nav listo

        const csvText = await fetchCSV();
        originalData = parseCSV(csvText);

        if (!originalData.length) throw new Error('El CSV está vacío o sin encabezados.');
        COL = buildColumnMap(originalData);

        // Debug en consola para ver mapeo de columnas
        console.log('Column map:', COL);
        console.log('Primer registro:', originalData[0]);

        setupFilters(originalData, COL);
        applyFilters(); // primer render
      } catch (err) {
        console.error(err);
        document.body.innerHTML = `<div class="p-8 text-center text-red-600 bg-red-100">${err.message}</div>`;
      }
    });
  </script>
</body>
</html>
