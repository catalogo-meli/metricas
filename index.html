<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard de Productividad con IA</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js + adapter fechas -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; }
    .sidebar-link { transition: all .2s ease-in-out; }
    .sidebar-link:hover, .sidebar-link.active { background-color:#0369a1; color:#fff; transform: translateX(4px); }
    .kpi-card{background:#fff;border-radius:.75rem;padding:1.5rem;box-shadow:0 4px 6px -1px rgb(0 0 0 / 0.1),0 2px 4px -2px rgb(0 0 0 / 0.1);transition:transform .2s, box-shadow .2s;}
    .kpi-card:hover{transform:translateY(-4px);box-shadow:0 10px 15px -3px rgb(0 0 0 / .1),0 4px 6px -4px rgb(0 0 0 / .1);}
    .chart-container{height:400px;}
    #mobile-menu{transition: transform .3s ease-in-out;}
  </style>
</head>

<body class="bg-slate-100 text-slate-800">
  <div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside id="sidebar" class="hidden md:flex w-64 flex-col bg-sky-800 text-sky-100 p-4">
      <div class="flex items-center mb-8">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3 text-white" viewBox="0 0 20 20" fill="currentColor">
          <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>
        </svg>
        <h1 class="text-2xl font-bold text-white">Dashboard</h1>
      </div>
      <nav id="nav-menu" class="flex-1 space-y-2">
        <a href="#resumen" class="sidebar-link active flex items-center p-3 rounded-lg">Resumen General</a>
        <a href="#productividad" class="sidebar-link flex items-center p-3 rounded-lg">Productividad por Usuario</a>
        <a href="#lideres" class="sidebar-link flex items-center p-3 rounded-lg">Comparativa de Líderes</a>
        <a href="#evolucion" class="sidebar-link flex items-center p-3 rounded-lg">Evolución Semanal</a>
        <a href="#ubicacion" class="sidebar-link flex items-center p-3 rounded-lg">Análisis por Ubicación</a>
        <a href="#proyecciones" class="sidebar-link flex items-center p-3 rounded-lg">Proyecciones</a>
        <a href="#analisis" class="sidebar-link flex items-center p-3 rounded-lg">Análisis Inteligente</a>
      </nav>
    </aside>

    <!-- Main -->
    <main class="flex-1 overflow-x-hidden overflow-y-auto">
      <div class="container mx-auto px-6 py-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
          <button id="mobile-menu-button" class="md:hidden text-slate-600">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
          </button>
          <h2 id="page-title" class="text-3xl font-bold text-slate-700">Resumen General</h2>
        </div>

        <!-- Filtros -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4 mb-8">
          <select id="filter-mes" class="w-full p-2 border rounded-md bg-white shadow-sm"></select>
          <select id="filter-semana" class="w-full p-2 border rounded-md bg-white shadow-sm"></select>
          <select id="filter-q" class="w-full p-2 border rounded-md bg-white shadow-sm"></select>
          <select id="filter-lider" class="w-full p-2 border rounded-md bg-white shadow-sm"></select>
          <select id="filter-ubicacion" class="w-full p-2 border rounded-md bg-white shadow-sm"></select>
          <select id="filter-usuario" class="w-full p-2 border rounded-md bg-white shadow-sm"></select>
        </div>

        <!-- Secciones -->
        <div id="dashboard-content">
          <!-- Resumen -->
          <section id="resumen" class="page-section">
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-6 mb-6">
              <div class="kpi-card text-center">
                <h3 class="text-slate-500 font-medium">Total Tareas</h3>
                <p id="kpi-total-tareas" class="text-4xl font-bold mt-2"></p>
              </div>
              <div class="kpi-card text-center">
                <h3 class="text-slate-500 font-medium">% Efectividad Prom.</h3>
                <p id="kpi-efectividad-prom" class="text-4xl font-bold mt-2 text-green-600"></p>
              </div>
              <div class="kpi-card text-center">
                <h3 class="text-slate-500 font-medium">Correcciones auditadas</h3>
                <p id="kpi-correcciones" class="text-4xl font-bold mt-2 text-amber-600"></p>
              </div>
              <div class="kpi-card text-center">
                <h3 class="text-slate-500 font-medium">Usuarios Activos</h3>
                <p id="kpi-usuarios" class="text-4xl font-bold mt-2"></p>
              </div>
              <div class="kpi-card text-center">
                <h3 class="text-slate-500 font-medium">Promedio Diario</h3>
                <p id="kpi-promedio-diario" class="text-4xl font-bold mt-2 text-sky-600"></p>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div class="kpi-card">
                <div class="flex justify-between items-center mb-4">
                  <h3 class="text-xl font-semibold">Top 10 Usuarios por Tareas</h3>
                  <button id="generate-summary-btn" class="bg-sky-500 text-white px-4 py-2 rounded-lg hover:bg-sky-600 transition-colors text-sm font-medium">✨ Generar Resumen</button>
                </div>
                <div class="chart-container"><canvas id="topUsersChart"></canvas></div>
                <div id="summary-output" class="mt-4 p-4 bg-slate-50 rounded-md border border-slate-200 hidden"></div>
              </div>

              <div class="kpi-card">
                <h3 class="text-xl font-semibold mb-4">Tareas: Demanda vs. Enhancement</h3>
                <div class="chart-container relative mx-auto" style="height:320px;max-width:360px">
                  <canvas id="demandPieChart"></canvas>
                </div>
              </div>
            </div>
          </section>

          <!-- Productividad por Usuario -->
          <section id="productividad" class="page-section hidden">
            <div class="kpi-card mb-6">
              <h3 class="text-xl font-semibold mb-4">Total de Tareas por Usuario</h3>
              <div class="chart-container"><canvas id="tasksByUserChart"></canvas></div>
            </div>
            <div class="kpi-card">
              <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                <h3 class="text-xl font-semibold">Detalle de Productividad por Usuario</h3>
                <div class="flex items-center gap-2">
                  <select id="user-detail-select" class="w-full max-w-xs p-2 border rounded-md bg-white shadow-sm"></select>
                  <button id="generate-feedback-btn" class="bg-sky-500 text-white px-4 py-2 rounded-lg hover:bg-sky-600 transition-colors text-sm font-medium whitespace-nowrap">✨ Generar Feedback</button>
                </div>
              </div>
              <div id="feedback-output" class="mb-4 p-4 bg-slate-50 rounded-md border border-slate-200 hidden"></div>
              <div class="chart-container"><canvas id="userDetailChart"></canvas></div>
            </div>
          </section>

          <!-- Líderes -->
          <section id="lideres" class="page-section hidden">
            <div class="kpi-card">
              <h3 class="text-xl font-semibold mb-4">Comparativa de Desempeño por Líder</h3>
              <div class="chart-container"><canvas id="tasksByLeaderChart"></canvas></div>
            </div>
          </section>

          <!-- Evolución -->
          <section id="evolucion" class="page-section hidden">
            <div class="kpi-card">
              <h3 class="text-xl font-semibold mb-4">Evolución Semanal de Métricas Clave</h3>
              <div class="chart-container"><canvas id="weeklyEvolutionChart"></canvas></div>
            </div>
          </section>

          <!-- Ubicación -->
          <section id="ubicacion" class="page-section hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div class="kpi-card">
                <h3 class="text-xl font-semibold mb-4">Total de Tareas por Ubicación</h3>
                <div class="chart-container"><canvas id="tasksByLocationChart"></canvas></div>
              </div>
              <div class="kpi-card">
                <h3 class="text-xl font-semibold mb-4">Antigüedad Promedio por Ubicación (meses)</h3>
                <ul id="avg-antiguedad-list" class="space-y-2 text-slate-700"></ul>
              </div>
            </div>
          </section>

          <!-- Proyecciones -->
          <section id="proyecciones" class="page-section hidden">
            <div class="kpi-card">
              <h3 class="text-xl font-semibold mb-4">Proyección de Tareas Totales (Regresión lineal)</h3>
              <div class="chart-container"><canvas id="projectionsChart"></canvas></div>
            </div>
          </section>

          <!-- IA -->
          <section id="analisis" class="page-section hidden">
            <div class="kpi-card">
              <h3 class="text-xl font-semibold mb-2">Análisis Inteligente con Gemini</h3>
              <p class="text-slate-600 mb-4">Insights basados en los datos filtrados.</p>
              <button id="generate-insights-btn" class="bg-sky-600 text-white px-6 py-3 rounded-lg hover:bg-sky-700 transition-colors text-base font-semibold">
                ✨ Analizar Datos y Generar Sugerencias
              </button>
              <div id="insights-output" class="mt-6 p-4 bg-slate-50 rounded-md border border-slate-200 hidden"></div>
            </div>
          </section>
        </div>
      </div>
    </main>
  </div>

  <!-- Menú móvil -->
  <div id="mobile-menu" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden">
    <aside class="absolute top-0 left-0 h-full w-64 bg-sky-800 text-sky-100 p-4 transform -translate-x-full transition-transform duration-300">
      <div class="flex justify-between items-center mb-8">
        <h1 class="text-2xl font-bold text-white">Menú</h1>
        <button id="close-mobile-menu">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <nav id="mobile-nav-menu" class="flex-1 space-y-2"></nav>
    </aside>
  </div>

  <script>
  /**********************
   * CONFIG
   **********************/
  // Si ya creaste tu Worker proxy de Gemini, poné acá la URL pública:
  const GEMINI_PROXY_URL = "https://catalogo.ezequiel-galarza.workers.dev/?model=gemini-1.5-flash";

  // Archivos CSV fuente (en la raíz del repo)
  const FILES = {
    productividad: 'productividad.csv',
    calidad:       'calidad.csv',
    base:          'base.csv',
    lideres:       'lideres.csv'
  };

  /**********************
   * HELPERS
   **********************/
  const MONTHS_ES = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  const Q_OF_MONTH_INDEX = m => 'Q' + (Math.floor(m/3)+1);

  function ghURL(file){
    const bust = `?v=${Date.now()}`;
    return [
      `/metricas/${file}${bust}`,
      `https://raw.githubusercontent.com/catalogo-meli/metricas/main/${file}${bust}`
    ];
  }

  async function fetchCSVFile(file){
    const [u1,u2] = ghURL(file);
    let r = await fetch(u1,{cache:'no-store'});
    if(!r.ok) r = await fetch(u2,{cache:'no-store'});
    if(!r.ok) throw new Error(`No pude cargar ${file}. HTTP ${r.status}`);
    return r.text();
  }

  function parseCSV(text){
    const parsed = Papa.parse(text, {
      header: true,
      skipEmptyLines: true,
      delimitersToGuess: [',',';','\t','|']
    });
    return parsed.data.map(row=>{
      const out = {};
      for(const [k,v] of Object.entries(row)) out[k] = normalizeValue(v);
      return out;
    });
  }

  function normalizeValue(v){
    if(v===null || v===undefined) return v;
    if(typeof v !== 'string') return v;
    const t = v.trim();
    if(!t) return '';
    if(t.endsWith('%')){
      const num = t.replace('%','').replace(/\./g,'').replace(',','.');
      const n = Number(num);
      return Number.isFinite(n) ? n/100 : t;
    }
    // 1.234,56 -> 1234.56
    if(/^-?\d{1,3}(\.\d{3})*,\d+$/.test(t)){
      const num = t.replace(/\./g,'').replace(',','.');
      const n = Number(num);
      return Number.isFinite(n) ? n : t;
    }
    if(/^-?\d+(\.\d+)?$/.test(t)){
      const n = Number(t);
      return Number.isFinite(n) ? n : t;
    }
    return t;
  }

  function parseDateAny(val){
    if(val===null || val===undefined || val==='') return null;
    if(typeof val === 'number'){ // serial Excel
      const ms = Math.round((val - 25569) * 86400 * 1000);
      const d = new Date(ms);
      return isNaN(d.getTime()) ? null : d;
    }
    const s = String(val).trim();
    const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
    if(m){
      const d=Number(m[1]), mo=Number(m[2])-1, y=Number(m[3].length===2?'20'+m[3]:m[3]);
      const dt = new Date(y,mo,d);
      return isNaN(dt.getTime()) ? null : dt;
    }
    const dt = new Date(s);
    return isNaN(dt.getTime()) ? null : dt;
  }

  function keyIncludes(k, needle){ return k.toLowerCase().includes(needle); }
  function pick(row, needles){
    const keys = Object.keys(row);
    for(const n of needles){
      const k = keys.find(k => keyIncludes(k,n));
      if(k) return row[k];
    }
    return undefined;
  }
  function correoAUsuario(mail){
    if(!mail) return '';
    return String(mail).toLowerCase().replace(/\s/g,'').replace(/@mercadolibre\.com/i,'');
  }

  const fmt = {
    int: n => (n ?? 0).toLocaleString('es-AR'),
    pct: x => (x ?? 0).toLocaleString('es-AR',{style:'percent',minimumFractionDigits:2,maximumFractionDigits:2}),
    dec: x => (x ?? 0).toLocaleString('es-AR',{minimumFractionDigits:2,maximumFractionDigits:2})
  };

  /**********************
   * BUILD CONSOLIDADO (igual a Apps Script)
   **********************/
  function buildWeeklyRows(prod, cal, base, lideres){
    const P = prod.map(r=>({
      fecha: parseDateAny(pick(r,['fecha'])),
      week:  Number(pick(r,['week'])),
      user:  correoAUsuario(pick(r,['usuario','user'])),
      dem:   Number(pick(r,['tareas de demanda','demanda']))||0,
      enh:   Number(pick(r,['tareas de enhancement','enhancement']))||0,
      total: Number(pick(r,['total tareas','total']))||0,
      idsW:  Number(pick(r,['ids trabaj']))||0
    })).filter(r=>r.fecha && r.week && r.user);

    const C = cal.map(r=>({
      week: Number(pick(r,['week'])),
      user: correoAUsuario(pick(r,['usuario','user'])),
      idsC: Number(pick(r,['ids audit']))||0,
      err:  Number(pick(r,['total error','errores']))||0
    })).filter(r=>r.week && r.user);

    const perfiles = new Map();
    base.forEach(r=>{
      const user = correoAUsuario(pick(r,['mail','email']));
      if(!user) return;
      perfiles.set(user,{
        ciudad:  pick(r,['ciudad','ubicación']) || '',
        ingreso: parseDateAny(pick(r,['fecha ingreso','ingreso']))
      });
    });

    const liderPorUser = new Map();
    lideres.forEach(r=>{
      const user  = correoAUsuario(pick(r,['usuario','user']));
      let lider   = pick(r,['líder','lider']) || '';
      if(String(lider||'').toLowerCase()==='sin líder') return;
      if(user) liderPorUser.set(user, lider);
    });

    const weeks = new Map();
    for(const r of P){
      const y = r.fecha.getFullYear();
      const m = r.fecha.getMonth();
      const ym = `${y}-${String(m+1).padStart(2,'0')}`;
      const key = `${r.user}|${r.week}|${ym}`;
      if(!weeks.has(key)){
        const perf = perfiles.get(r.user) || {};
        const ingreso = perf.ingreso;
        const hoy = new Date();
        const finAnt = (ingreso && ingreso<=hoy) ? hoy : ingreso || hoy;
        const antig = ingreso ? Math.max(0,(finAnt.getFullYear()-ingreso.getFullYear())*12+(finAnt.getMonth()-ingreso.getMonth())) : '';
        weeks.set(key,{
          week: r.week, mes: MONTHS_ES[m], mesIndex:m,
          user:r.user, lider: liderPorUser.get(r.user)||'Sin líder',
          ciudad: perf.ciudad||'', antig,
          dias:new Set(), demand:0, enh:0, total:0, idsWork:0, idsCal:0, errCal:0
        });
      }
      const o = weeks.get(key);
      o.demand+=r.dem; o.enh+=r.enh; o.total+=r.total; o.idsWork+=r.idsW;
      const dKey = `${r.fecha.getFullYear()}-${String(r.fecha.getMonth()+1).padStart(2,'0')}-${String(r.fecha.getDate()).padStart(2,'0')}`;
      o.dias.add(dKey);
    }

    for(const r of C){
      const pref = `${r.user}|${r.week}|`;
      for(const key of weeks.keys()){
        if(key.startsWith(pref)){
          const o = weeks.get(key);
          o.idsCal += r.idsC;
          o.errCal += r.err;
        }
      }
    }

    const rows = Array.from(weeks.values())
      .sort((a,b)=> a.week - b.week)
      .map(o=>{
        const prom = o.dias.size ? (o.total/o.dias.size) : '';
        const tot  = o.demand + o.enh;
        const pDem = tot ? o.demand/tot : '';
        const pEnh = tot ? o.enh/tot    : '';
        const pEf  = o.idsCal>0 ? (1 - (o.errCal/o.idsCal)) : '';
        return {
          week: o.week,
          mes: o.mes,
          mesIndex: o.mesIndex,
          usuario: o.user,
          líder: o.lider,
          ciudad: o.ciudad,
          antigüedad: o.antig,
          promedio_diario: prom,
          efectividad: pEf,
          tareas_demanda: o.demand,
          p_demanda: pDem,
          tareas_enhancement: o.enh,
          p_enhancement: pEnh,
          total_tareas: o.total,
          ids_trabajados: o.idsWork,
          correcciones_auditadas: o.idsCal,
          dias_activos: o.dias.size,
          q: Q_OF_MONTH_INDEX(o.mesIndex)
        };
      });

    return rows;
  }

  /**********************
   * ESTADO GLOBAL
   **********************/
  let originalData = [];       // filas consolidadas
  let currentData  = [];       // filas filtradas
  const charts = {};           // instancias Chart.js

  /**********************
   * FILTROS + NAV
   **********************/
  function setOptions(sel, values, placeholder){
    sel.innerHTML = '';
    const opt = document.createElement('option');
    opt.value = ''; opt.textContent = placeholder;
    sel.appendChild(opt);
    values.forEach(v=>{
      const o = document.createElement('option');
      o.value = v; o.textContent = v;
      sel.appendChild(o);
    });
  }

  function uniqueSorted(arr){ return Array.from(new Set(arr)).sort(); }
  function uniqueSortedNum(arr){ return Array.from(new Set(arr)).sort((a,b)=>a-b); }

  function setupFilters(){
    const meses = MONTHS_ES.filter(m => originalData.some(r=>r.mes===m)); // orden cronológico real
    const semanas = uniqueSortedNum(originalData.map(r=>r.week)).map(String);
    const ubic = uniqueSorted(originalData.map(r=>r.ciudad).filter(Boolean));
    const usuarios = uniqueSorted(originalData.map(r=>r.usuario));
    const lideres = uniqueSorted(originalData.map(r=>r['líder']).filter(l => l && l.toLowerCase() !== 'sin líder'));
    const qs = ['Q1','Q2','Q3','Q4'].filter(q => originalData.some(r=>r.q===q));

    setOptions(document.getElementById('filter-mes'), meses, 'Todos los meses');
    setOptions(document.getElementById('filter-semana'), semanas, 'Todas las semanas');
    setOptions(document.getElementById('filter-ubicacion'), ubic, 'Todas las ubicaciones');
    setOptions(document.getElementById('filter-usuario'), usuarios, 'Todos los usuarios');
    setOptions(document.getElementById('filter-lider'), lideres, 'Todos los líderes');
    setOptions(document.getElementById('filter-q'), qs, 'Todos los trimestres');

    // selector para detalle de usuario
    setOptions(document.getElementById('user-detail-select'), usuarios, 'Elegí un usuario');

    // listeners
    ['filter-mes','filter-semana','filter-ubicacion','filter-usuario','filter-lider','filter-q']
      .forEach(id => document.getElementById(id).addEventListener('change', applyFilters));
  }

  function setupNavigation(){
    const links = [...document.querySelectorAll('#nav-menu a')];
    const mobile = document.getElementById('mobile-nav-menu');
    mobile.innerHTML = links.map(a=>`<a href="${a.getAttribute('href')}" class="block p-3 rounded-lg hover:bg-sky-700">${a.textContent}</a>`).join('');
    links.forEach(a=>{
      a.addEventListener('click', e=>{
        e.preventDefault();
        const target = a.getAttribute('href');
        document.querySelectorAll('.page-section').forEach(s=>s.classList.add('hidden'));
        document.querySelector(target).classList.remove('hidden');
        links.forEach(x=>x.classList.remove('active'));
        a.classList.add('active');
        document.getElementById('page-title').textContent = a.textContent;
        if(target==='#productividad') renderTasksByUser();
        if(target==='#lideres')       renderTasksByLeader();
        if(target==='#evolucion')     renderWeeklyEvolution();
        if(target==='#ubicacion')     renderByLocation();
        if(target==='#proyecciones')  renderProjections();
      });
    });

    // menú móvil
    const mobBtn = document.getElementById('mobile-menu-button');
    const mob    = document.getElementById('mobile-menu');
    const mobClose = document.getElementById('close-mobile-menu');
    mobBtn.addEventListener('click', ()=>{ mob.classList.remove('hidden'); mob.querySelector('aside').classList.remove('-translate-x-full'); });
    mobClose.addEventListener('click', ()=>{ mob.querySelector('aside').classList.add('-translate-x-full'); setTimeout(()=>mob.classList.add('hidden'),200); });
    mobile.querySelectorAll('a').forEach(a=>{
      a.addEventListener('click', ()=>{ mob.querySelector('aside').classList.add('-translate-x-full'); setTimeout(()=>mob.classList.add('hidden'),200); });
    });
  }

  function applyFilters(){
    const f = {
      mes: document.getElementById('filter-mes').value,
      semana: document.getElementById('filter-semana').value,
      ubic: document.getElementById('filter-ubicacion').value,
      user: document.getElementById('filter-usuario').value,
      lider: document.getElementById('filter-lider').value,
      q: document.getElementById('filter-q').value
    };
    currentData = originalData.filter(r =>
      (!f.mes   || r.mes === f.mes) &&
      (!f.semana|| String(r.week) === String(f.semana)) &&
      (!f.ubic  || r.ciudad === f.ubic) &&
      (!f.user  || r.usuario === f.user) &&
      (!f.lider || r['líder'] === f.lider) &&
      (!f.q     || r.q === f.q)
    );

    updateKPIs();
    renderTopUsers();
    renderDemandPie();
    renderTasksByUser();
    renderTasksByLeader();
    renderWeeklyEvolution();
    renderByLocation();
    renderProjections();
  }

  /**********************
   * KPI + RENDER
   **********************/
  function updateKPIs(){
    const total = currentData.reduce((s,r)=> s + (r.total_tareas||0), 0);
    const usuarios = new Set(currentData.map(r=>r.usuario)).size;
    const correcc = currentData.reduce((s,r)=> s + (r.correcciones_auditadas||0), 0);
    const promDiario = (() => {
      const days = currentData.reduce((s,r)=> s + (r.dias_activos||0), 0);
      return days ? total / days : 0;
    })();
    const ef = (() => {
      const vals = currentData.map(r=>r.efectividad).filter(v => v !== '' && v !== null && v !== undefined);
      if(!vals.length) return 0;
      return vals.reduce((a,b)=>a+b,0) / vals.length;
    })();

    document.getElementById('kpi-total-tareas').textContent     = fmt.int(total);
    document.getElementById('kpi-usuarios').textContent         = fmt.int(usuarios);
    document.getElementById('kpi-correcciones').textContent     = fmt.int(correcc);
    document.getElementById('kpi-promedio-diario').textContent  = fmt.dec(promDiario);
    document.getElementById('kpi-efectividad-prom').textContent = fmt.pct(ef);
  }

  function createOrUpdateChart(id, cfg){
    if(charts[id]) { charts[id].data = cfg.data; charts[id].options = cfg.options || {}; charts[id].update(); return charts[id]; }
    const ctx = document.getElementById(id).getContext('2d');
    charts[id] = new Chart(ctx, cfg);
    return charts[id];
  }

  function renderTopUsers(){
    const byUser = new Map();
    currentData.forEach(r=>{
      byUser.set(r.usuario, (byUser.get(r.usuario)||0) + (r.total_tareas||0));
    });
    const arr = Array.from(byUser.entries()).sort((a,b)=>b[1]-a[1]).slice(0,10);
    const data = {
      labels: arr.map(x=>x[0]),
      datasets: [{ label:'Tareas', data: arr.map(x=>x[1]) }]
    };
    createOrUpdateChart('topUsersChart', { type:'bar', data, options:{ responsive:true, plugins:{legend:{display:false}} }});
  }

  function renderDemandPie(){
    const demand = currentData.reduce((s,r)=> s + (r.tareas_demanda||0), 0);
    const enh    = currentData.reduce((s,r)=> s + (r.tareas_enhancement||0), 0);
    createOrUpdateChart('demandPieChart',{
      type:'pie',
      data:{ labels:['Demanda','Enhancement'], datasets:[{ data:[demand, enh] }] },
      options:{ responsive:true, plugins:{legend:{position:'bottom'}} }
    });
  }

  function renderTasksByUser(){
    const byUser = new Map();
    currentData.forEach(r=> byUser.set(r.usuario,(byUser.get(r.usuario)||0)+(r.total_tareas||0)));
    const arr = Array.from(byUser.entries()).sort((a,b)=>b[1]-a[1]);
    createOrUpdateChart('tasksByUserChart',{
      type:'bar',
      data:{ labels:arr.map(x=>x[0]), datasets:[{label:'Tareas', data: arr.map(x=>x[1])}] },
      options:{ responsive:true, plugins:{legend:{display:false}}, scales:{x:{ticks:{autoSkip:false,maxRotation:60,minRotation:45}}}}
    });

    // detalle de usuario
    const select = document.getElementById('user-detail-select');
    if(!select.value && arr.length) select.value = arr[0][0];
    renderUserDetail(select.value);
    select.onchange = () => renderUserDetail(select.value);
  }

  function renderUserDetail(user){
    const rows = currentData.filter(r=>r.usuario===user).sort((a,b)=>a.week-b.week);
    const labels = rows.map(r=>`W${r.week} ${r.mes}`);
    const data = rows.map(r=>r.total_tareas||0);
    createOrUpdateChart('userDetailChart',{
      type:'line',
      data:{ labels, datasets:[{label:`Tareas de ${user}`, data}] },
      options:{ responsive:true, plugins:{legend:{display:false}}}
    });
  }

  function renderTasksByLeader(){
    const byLeader = new Map();
    currentData.forEach(r=>{
      if(!r['líder'] || r['líder'].toLowerCase()==='sin líder') return;
      byLeader.set(r['líder'], (byLeader.get(r['líder'])||0)+(r.total_tareas||0));
    });
    const arr = Array.from(byLeader.entries()).sort((a,b)=>b[1]-a[1]);
    createOrUpdateChart('tasksByLeaderChart',{
      type:'bar',
      data:{ labels:arr.map(x=>x[0]), datasets:[{label:'Tareas', data: arr.map(x=>x[1])}] },
      options:{ responsive:true, plugins:{legend:{display:false}}, scales:{x:{ticks:{autoSkip:false,maxRotation:45}}}}
    });
  }

function renderWeeklyEvolution(){
  // Agrego por semana (numérica) el total de tareas
  const byW = new Map();
  currentData.forEach(r => {
    const w = Number(r.week);
    if (!Number.isFinite(w)) return;
    byW.set(w, (byW.get(w) || 0) + (r.total_tareas || 0));
  });

  const weeks = Array.from(byW.keys());
  if (!weeks.length) {
    createOrUpdateChart('weeklyEvolutionChart', { type:'line', data:{labels:[], datasets:[]}, options:{} });
    return;
  }

  const minW = Math.min(...weeks);
  const maxW = Math.max(...weeks);

  const labels = [];
  const values = [];
  for (let w = minW; w <= maxW; w++) {
    labels.push('W' + String(w).padStart(2,'0'));
    values.push(byW.get(w) || 0);
  }

  createOrUpdateChart('weeklyEvolutionChart', {
    type: 'line',
    data: { labels, datasets: [{ label: 'Total Tareas', data: values, borderWidth: 2, tension: .2, pointRadius: 2 }] },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        x: {
          ticks: {
            autoSkip: false,    // <- muestra todas
            maxRotation: 0,     // sin rotación; si querés, probá 45
            minRotation: 0
          }
        }
      }
    }
  });
}

  function renderByLocation(){
    // barras por ubicación
    const byLoc = new Map();
    currentData.forEach(r=> byLoc.set(r.ciudad,(byLoc.get(r.ciudad)||0)+(r.total_tareas||0)));
    const arr = Array.from(byLoc.entries()).sort((a,b)=>b[1]-a[1]);
    createOrUpdateChart('tasksByLocationChart',{
      type:'bar',
      data:{ labels:arr.map(x=>x[0]), datasets:[{label:'Tareas', data: arr.map(x=>x[1])}] },
      options:{ responsive:true, plugins:{legend:{display:false}}}
    });

    // antigüedad promedio por ubicación (meses)
    const agg = {};
    currentData.forEach(r=>{
      if(!r.ciudad) return;
      if(!agg[r.ciudad]) agg[r.ciudad] = {sum:0, n:0};
      const a = Number(r.antigüedad||0);
      if(Number.isFinite(a)){ agg[r.ciudad].sum += a; agg[r.ciudad].n++; }
    });
    const list = Object.entries(agg).map(([k,v])=>[k, v.n? v.sum/v.n : 0]).sort((a,b)=>b[1]-a[1]);
    const ul = document.getElementById('avg-antiguedad-list');
    ul.innerHTML = list.map(([loc,avg])=>`<li class="flex justify-between"><span>${loc}</span><span class="font-semibold">${fmt.dec(avg)}</span></li>`).join('');
  }

  function renderProjections(){
    // regresión lineal sobre W -> total_tareas
    const byW = new Map();
    currentData.forEach(r=>{
      const w = Number(r.week);
      byW.set(w, (byW.get(w)||0) + (r.total_tareas||0));
    });
    const weeks = Array.from(byW.keys()).sort((a,b)=>a-b);
    if(weeks.length<2){
      createOrUpdateChart('projectionsChart',{type:'line',data:{labels:[],datasets:[]},options:{}});
      return;
    }
    const y = weeks.map(w=>byW.get(w)), x = weeks;
    const n = x.length;
    const sx = x.reduce((a,b)=>a+b,0), sy = y.reduce((a,b)=>a+b,0);
    const sxx = x.reduce((a,b)=>a+b*b,0), sxy = x.reduce((a,i)=>a+i*y[x.indexOf(i)],0);
    const m = (n*sxy - sx*sy)/(n*sxx - sx*sx);
    const b = (sy - m*sx)/n;

    const next = [];
    const maxW = Math.max(...weeks);
    for(let k=1;k<=6;k++) next.push(maxW+k);
    const allW = weeks.concat(next);
    const trend = allW.map(w => m*w + b);

    createOrUpdateChart('projectionsChart',{
      type:'line',
      data:{ labels: allW.map(w=>'W'+w), datasets:[
        {label:'Histórico', data: weeks.map(w=>byW.get(w)), borderWidth:2, tension:.2},
        {label:'Proyección', data: trend, borderDash:[6,4], borderWidth:2, tension:.2}
      ]},
      options:{ responsive:true }
    });
  }

  /**********************
   * GEMINI (opcional)
   **********************/
  // === reemplazar por completo en index.html ===
async function geminiRequest(prompt) {
  if (!GEMINI_PROXY_URL) {
    return "Configura la URL del proxy de Gemini (GEMINI_PROXY_URL) para usar esta función.";
  }

  const attempts = [
    // 1) Proxies que esperan { prompt: "..." }
    { prompt: String(prompt) },
    // 2) Proxies que esperan el payload de Google
    { contents: [{ parts: [{ text: String(prompt) }]}] },
  ];

  let lastErr;
  for (const body of attempts) {
    try {
      const r = await fetch(GEMINI_PROXY_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });

      const raw = await r.text();
      if (!r.ok) throw new Error(raw || `HTTP ${r.status}`);

      // Devuelve texto directo o JSON de Google
      let data;
      try { data = JSON.parse(raw); } catch { return raw; }

      const out =
        data?.candidates?.[0]?.content?.parts?.[0]?.text ??
        data?.text ??
        data?.output ??
        data;

      return (typeof out === 'string') ? out : JSON.stringify(out);
    } catch (e) {
      lastErr = e;
    }
  }
  throw lastErr || new Error('Gemini request failed');
}

  function setupGeminiFeatures(){
    document.getElementById('generate-summary-btn').addEventListener('click', async ()=>{
      const block = document.getElementById('summary-output');
      block.classList.remove('hidden');
      block.textContent = 'Generando...';
      try{
        const total = currentData.reduce((s,r)=>s+(r.total_tareas||0),0);
        const prom  = (()=>{
          const d = currentData.reduce((s,r)=>s+(r.dias_activos||0),0);
          return d? total/d : 0;
        })();
        const top = (()=> {
          const map = new Map();
          currentData.forEach(r=>map.set(r.usuario,(map.get(r.usuario)||0)+(r.total_tareas||0)));
          return Array.from(map.entries()).sort((a,b)=>b[1]-a[1]).slice(0,5).map(x=>`${x[0]} (${x[1]} tareas)`).join(', ');
        })();
        const prompt = `Actúa como analista. Resume hallazgos en 6 viñetas. Datos: total tareas=${total}, promedio diario ponderado=${prom.toFixed(2)}, top usuarios=${top}. Sugerí 3 acciones.`;        
        const resp = await geminiRequest(prompt);
        block.textContent = resp;
      }catch(e){
        block.textContent = e.message;
      }
    });

    document.getElementById('generate-feedback-btn').addEventListener('click', async ()=>{
      const user = document.getElementById('user-detail-select').value;
      const out = document.getElementById('feedback-output');
      out.classList.remove('hidden'); out.textContent = 'Analizando...';
      try{
        const rows = currentData.filter(r=>r.usuario===user).sort((a,b)=>a.week-b.week);
        const last = rows[rows.length-1];
        const prompt = `Feedback breve para ${user}. Evolución semanas: ${rows.map(r=>`W${r.week}:${r.total_tareas}`).join(', ')}. Porcentaje de efectividad promedio ${(rows.map(r=>r.efectividad).filter(v=>v!=='').reduce((a,b)=>a+b,0)/(rows.filter(r=>r.efectividad!=='').length||1)).toFixed(2)}. Señala 2 fortalezas y 2 oportunidades.`;
        const resp = await geminiRequest(prompt);
        out.textContent = resp;
      }catch(e){
        out.textContent = e.message;
      }
    });

    document.getElementById('generate-insights-btn').addEventListener('click', async ()=>{
      const out = document.getElementById('insights-output');
      out.classList.remove('hidden'); out.textContent='Pensando...';
      try{
        const dmd = currentData.reduce((s,r)=>s+(r.tareas_demanda||0),0);
        const enh = currentData.reduce((s,r)=>s+(r.tareas_enhancement||0),0);
        const eff = (()=>{ const v=currentData.map(r=>r.efectividad).filter(v=>v!==''); return v.length? v.reduce((a,b)=>a+b,0)/v.length : 0; })();
        const prompt = `Con los datos filtrados, genera 6 insights accionables y una conclusión: demanda=${dmd}, enhancement=${enh}, efectividad=${eff.toFixed(3)}.`;
        const resp = await geminiRequest(prompt);
        out.textContent = resp;
      }catch(e){
        out.textContent = e.message;
      }
    });
  }

  /**********************
   * INIT
   **********************/
  document.addEventListener('DOMContentLoaded', async ()=>{
    try{
      const [tProd,tCal,tBase,tLid] = await Promise.all([
        fetchCSVFile(FILES.productividad),
        fetchCSVFile(FILES.calidad),
        fetchCSVFile(FILES.base),
        fetchCSVFile(FILES.lideres)
      ]);
      const prod = parseCSV(tProd);
      const cal  = parseCSV(tCal);
      const base = parseCSV(tBase);
      const lids = parseCSV(tLid);

      originalData = buildWeeklyRows(prod, cal, base, lids);

      setupFilters();
      setupNavigation();
      setupGeminiFeatures();
      // render inicial
      currentData = originalData.slice();
      applyFilters();
    }catch(err){
      console.error(err);
      document.body.innerHTML = `<div class="p-8 text-center text-red-600 bg-red-100">${err.message}</div>`;
    }
  });
  </script>
</body>
</html>




